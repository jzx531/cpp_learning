<!DOCTYPE html><html><head>
      <title>learn_concurrency</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\jzx\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.15\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="c-concurrency-in-action">c++ concurrency in action </h1>

<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#c-concurrency-in-action" class="md-toc-link"><p>c++ concurrency in action</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#çº¿ç¨‹ç®¡æ§" class="md-toc-link">
            <p>çº¿ç¨‹ç®¡æ§</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#åœ¨çº¿ç¨‹é—´å…±äº«æ•°æ®" class="md-toc-link"><p>åœ¨çº¿ç¨‹é—´å…±äº«æ•°æ®</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#äº’æ–¥é”" class="md-toc-link">
            <p>äº’æ–¥é”</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#ä¿æŠ¤å…±äº«æ•°æ®çš„å…¶ä»–å·¥å…·" class="md-toc-link">
            <p>ä¿æŠ¤å…±äº«æ•°æ®çš„å…¶ä»–å·¥å…·</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#å¹¶å‘æ“ä½œçš„åŒæ­¥" class="md-toc-link"><p>å¹¶å‘æ“ä½œçš„åŒæ­¥</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#ä½¿ç”¨futureç­‰å¾…ä¸€æ¬¡æ€§äº‹ä»¶å‘ç”Ÿ" class="md-toc-link"><p>ä½¿ç”¨futureç­‰å¾…ä¸€æ¬¡æ€§äº‹ä»¶å‘ç”Ÿ</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å…³è”futureå®ä¾‹å’Œä»»åŠ¡" class="md-toc-link">
            <p>å…³è”futureå®ä¾‹å’Œä»»åŠ¡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åœ¨çº¿ç¨‹é—´ä¼ é€’ä»»åŠ¡" class="md-toc-link">
            <p>åœ¨çº¿ç¨‹é—´ä¼ é€’ä»»åŠ¡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åˆ›å»ºstdpromise" class="md-toc-link">
            <p>åˆ›å»ºstd::promise</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å°†å¼‚å¸¸ä¿å­˜åˆ°futureä¸­" class="md-toc-link">
            <p>å°†å¼‚å¸¸ä¿å­˜åˆ°futureä¸­</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å¤šä¸ªçº¿ç¨‹ä¸€èµ·ç­‰å¾…" class="md-toc-link">
            <p>å¤šä¸ªçº¿ç¨‹ä¸€èµ·ç­‰å¾…</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#é™æ—¶ç­‰å¾…" class="md-toc-link"><p>é™æ—¶ç­‰å¾…</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åç»­å‡½æ•°çš„è¿é”è°ƒç”¨" class="md-toc-link">
            <p>åç»­å‡½æ•°çš„è¿é”è°ƒç”¨</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#çº¿ç¨‹é—©å’Œçº¿ç¨‹å¡" class="md-toc-link">
            <p>çº¿ç¨‹é—©å’Œçº¿ç¨‹å¡</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#stdexperimentalflex_barrier" class="md-toc-link">
            <p>std::experimental::flex_barrier</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#cå†…å­˜æ¨¡å‹å’ŒåŸå­æ“ä½œ" class="md-toc-link"><p>c++å†…å­˜æ¨¡å‹å’ŒåŸå­æ“ä½œ</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#åŒæ­¥æ“ä½œå’Œå¼ºåˆ¶é¡ºåº" class="md-toc-link"><p>åŒæ­¥æ“ä½œå’Œå¼ºåˆ¶é¡ºåº</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åŒæ­¥å…³ç³»" class="md-toc-link">
            <p>åŒæ­¥å…³ç³»</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#å…ˆè¡Œå…³ç³»" class="md-toc-link"><p>å…ˆè¡Œå…³ç³»</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å…ˆåä¸€è‡´é¡ºåº" class="md-toc-link">
            <p>å…ˆåä¸€è‡´é¡ºåº</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#éå…ˆåä¸€è‡´é¡ºåº" class="md-toc-link">
            <p>éå…ˆåä¸€è‡´é¡ºåº</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å®½æ¾æ¬¡åº" class="md-toc-link">
            <p>å®½æ¾æ¬¡åº</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#è·å–-é‡Šæ”¾é¡ºåº" class="md-toc-link">
            <p>è·å–-é‡Šæ”¾é¡ºåº</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#è·å–-é‡Šæ”¾æ¬¡åºå’Œmemory_order_consume" class="md-toc-link">
            <p>è·å–-é‡Šæ”¾æ¬¡åºå’Œmemory_order_consume</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#æ …æ " class="md-toc-link">
            <p>æ …æ </p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å‡­å€ŸåŸå­æ“ä½œä»¤éåŸå­æ“ä½œæœä»å†…å­˜æ¬¡åº" class="md-toc-link">
            <p>å‡­å€ŸåŸå­æ“ä½œä»¤éåŸå­æ“ä½œæœä»å†…å­˜æ¬¡åº</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#è®¾è®¡åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„" class="md-toc-link"><p>è®¾è®¡åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#è®¾è®¡æ›´å¤æ‚çš„åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„" class="md-toc-link">
            <p>è®¾è®¡æ›´å¤æ‚çš„åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#è®¾è®¡æ— é”æ•°æ®ç»“æ„" class="md-toc-link"><p>è®¾è®¡æ— é”æ•°æ®ç»“æ„</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#æ— éœ€ç­‰å¾…çš„æ•°æ®ç»“æ„" class="md-toc-link"><p>æ— éœ€ç­‰å¾…çš„æ•°æ®ç»“æ„</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å®ç°çº¿ç¨‹å®‰å…¨çš„æ— é”é˜Ÿåˆ—" class="md-toc-link">
            <p>å®ç°çº¿ç¨‹å®‰å…¨çš„æ— é”é˜Ÿåˆ—</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#å®ç°æ— é”æ•°æ®ç»“æ„çš„åŸåˆ™" class="md-toc-link"><p>å®ç°æ— é”æ•°æ®ç»“æ„çš„åŸåˆ™</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åŸåˆ™1åœ¨åŸå‹è®¾è®¡ä¸­ä½¿ç”¨stdmemory_order_seq_cstæ¬¡åº" class="md-toc-link">
            <p>åŸåˆ™1ï¼šåœ¨åŸå‹è®¾è®¡ä¸­ä½¿ç”¨std::memory_order_seq_cstæ¬¡åº</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åŸåˆ™2ä½¿ç”¨æ— é”çš„å†…å­˜å›æ”¶æ–¹æ¡ˆ" class="md-toc-link">
            <p>åŸåˆ™2ï¼šä½¿ç”¨æ— é”çš„å†…å­˜å›æ”¶æ–¹æ¡ˆ</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åŸåˆ™3-é˜²èŒƒabaé—®é¢˜" class="md-toc-link">
            <p>åŸåˆ™3: é˜²èŒƒABAé—®é¢˜</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åŸåˆ™4æ‰¾å‡ºå¿™ç­‰å¾ªç¯ååŠ©å…¶ä»–çº¿ç¨‹" class="md-toc-link">
            <p>åŸåˆ™4ï¼šæ‰¾å‡ºå¿™ç­‰å¾ªç¯,ååŠ©å…¶ä»–çº¿ç¨‹</p>

          </a></div>
        </div>
      </details>
    
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#è®¾è®¡å¹¶å‘ä»£ç " class="md-toc-link"><p>è®¾è®¡å¹¶å‘ä»£ç </p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#åœ¨çº¿ç¨‹é—´åˆ‡åˆ†ä»»åŠ¡çš„æ–¹æ³•" class="md-toc-link">
            <p>åœ¨çº¿ç¨‹é—´åˆ‡åˆ†ä»»åŠ¡çš„æ–¹æ³•</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å½±å“å¹¶å‘ä»£ç æ€§èƒ½çš„å› ç´ " class="md-toc-link">
            <p>å½±å“å¹¶å‘ä»£ç æ€§èƒ½çš„å› ç´ </p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#è®¾è®¡æ•°æ®ç»“æ„ä»¥æå‡å¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½" class="md-toc-link">
            <p>è®¾è®¡æ•°æ®ç»“æ„ä»¥æå‡å¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#è®¾è®¡å¹¶å‘ä»£ç æ—¶é¢å¤–è¦è€ƒè™‘çš„å› ç´ " class="md-toc-link">
            <p>è®¾è®¡å¹¶å‘ä»£ç æ—¶é¢å¤–è¦è€ƒè™‘çš„å› ç´ </p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å¹¶å‘ä»£ç çš„è®¾è®¡å®è·µ" class="md-toc-link">
            <p>å¹¶å‘ä»£ç çš„è®¾è®¡å®è·µ</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#é«˜çº§çº¿ç¨‹ç®¡ç†" class="md-toc-link"><p>é«˜çº§çº¿ç¨‹ç®¡ç†</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#çº¿ç¨‹æ± " class="md-toc-link"><p>çº¿ç¨‹æ± </p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#ä»»åŠ¡çªƒå–" class="md-toc-link">
            <p>ä»»åŠ¡çªƒå–</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#ä¸­æ–­çº¿ç¨‹" class="md-toc-link">
            <p>ä¸­æ–­çº¿ç¨‹</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å¹¶è¡Œç®—æ³•å‡½æ•°" class="md-toc-link">
            <p>å¹¶è¡Œç®—æ³•å‡½æ•°</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#å¤šçº¿ç¨‹åº”ç”¨çš„æµ‹è¯•å’Œé™¤é”™" class="md-toc-link">
            <p>å¤šçº¿ç¨‹åº”ç”¨çš„æµ‹è¯•å’Œé™¤é”™</p>

          </a></div>
        </div>
      </details>
    
</div>
<h2 id="çº¿ç¨‹ç®¡æ§">çº¿ç¨‹ç®¡æ§ </h2>
<p>æ¯ä¸ªc++ç¨‹åºéƒ½å«æœ‰è‡³å°‘ä¸€ä¸ªçº¿ç¨‹,å³è¿è¡Œmain()çš„çº¿ç¨‹,è¿™äº›æ–°çº¿ç¨‹è¿åŒå…¶å®çº¿ç¨‹å¹¶å‘è¿è¡Œ,å½“main()å‡½æ•°è¿”å›æ—¶,ç¨‹åºå°±ä¼šé€€å‡º</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">func</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> <span class="token operator">&amp;</span> i<span class="token punctuation">;</span>
    <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> <span class="token operator">&amp;</span> i_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">i</span><span class="token punctuation">(</span>i_<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span><span class="token number">10000</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span>i<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    func <span class="token function">f</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æœ¬ä¾‹ä¸­,æ˜ç¡®è®¾å®šäº†ä¸ç­‰å¾…,äºæ˜¯åœ¨oopsç»“æŸåï¼Œæ–°çº¿ç¨‹å¯èƒ½ç»§ç»­è¿è¡Œ,è¯¥çº¿ç¨‹å¯èƒ½è®¿é—®å·²ç»è¢«é”€æ¯çš„å‰§æœ¬å˜é‡,ä½¿çº¿ç¨‹é”™è¯¯</p>
<p>ä¸Šè¿°æƒ…å½¢çš„å¤„ç†æ–¹æ³•æ˜¯å°†æ•°æ®å®Œå…¨å¤åˆ¶ç»™æ•°æ®è€Œä¸æ˜¯å…±äº«<br>
ä¸ºäº†é˜²æ­¢å› æŠ›å‡ºå¼‚å¸¸è€Œå¯¼è‡´çš„åº”ç”¨ç¨‹åºç»ˆç»“,æˆ‘ä»¬å†³å®šå¦‚ä½•å¤„ç†è¿™ç§æƒ…å†µ,ä¸€èˆ¬åœ°ï¼Œå¦‚æœè¯»è€…æ‰“ç®—åœ¨æ²¡å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µä¸‹è°ƒç”¨join(),å‘ç”Ÿå¼‚å¸¸åŒæ ·éœ€è¦è°ƒç”¨join()æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">func</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> some_local_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    func <span class="token function">my_func</span><span class="token punctuation">(</span>some_local_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>my_func<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
        <span class="token function">do_something_in_current_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span><span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-throw">throw</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸ºäº†å®ç°å‰é¢çš„ç›®æ ‡<br>
è®¾è®¡ä¸€ä¸ªç±»,åœ¨æ ‡å‡†ç±»ä¸­è¿ç”¨RAIIæŠ€æœ¯<br>
åœ¨ææ„å‡½æ•°ä¸­è°ƒç”¨join()</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">thread_guard</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&amp;</span> t<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">thread_guard</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&amp;</span> _t<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">t</span><span class="token punctuation">(</span>_t<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">thread_guard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">thread_guard</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> thread_guard<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    thread_guard<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> thread_guard<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>std:ğŸ§µ:id å®ä¾‹å¸¸ç”¨çº¿ç¨‹,</p>
<h2 id="åœ¨çº¿ç¨‹é—´å…±äº«æ•°æ®">åœ¨çº¿ç¨‹é—´å…±äº«æ•°æ® </h2>
<h3 id="äº’æ–¥é”">äº’æ–¥é” </h3>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;list&gt;</span></span>
std<span class="token double-colon punctuation">::</span>mutex some_mtx<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> some_list<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">add_to_list</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> new_value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>some_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    some_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-bool">bool</span> <span class="token function">list_contains</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>some_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">find</span><span class="token punctuation">(</span>some_list<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> some_list<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">!=</span> some_list<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸ºäº†é¿å…åœ¨bufferæ„é€ å‡½æ•°æ²¡æœ‰åŸæ ·å¤åˆ¶æ‰€æä¾›çš„å€¼,å¹¶æœªä»¤å…¶è½¬æ¢ä¸ºé¢„æœŸçš„å‚æ•°ç±»å‹,è§£å†³æ–¹æ³•æ˜¯,åœ¨bufferä¼ å…¥std::threadçš„æ„é€ å‡½æ•°ä¹‹å‰,å°±æŠŠå®ƒè½¬åŒ–æˆstd::stringå¯¹è±¡</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> s<span class="token punctuation">)</span>
<span class="token keyword keyword-void">void</span> <span class="token function">not_oops</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> some_param<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-char">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"%d"</span><span class="token punctuation">,</span>some_param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>std::thread çš„å‡½æ•°ä¼ å…¥çº¿ç¨‹å‡½æ•°çš„å‚æ•°æ—¶ï¼Œçº¿ç¨‹åº“ä¼šæŠŠå‚æ•°çš„å¼•ç”¨ä¼ å€¼å½“æˆmove-onlyç±»å‹,å¹¶ä»¥å³å€¼ä¼ é€’,åªè¦ç”¨std::ref()åŒ…è£…å³å¯</p>
<p>std::thread t(update_data_for_widget,w,std::ref(data));</p>
<p>è‹¥è¦å°†æŸä¸ªç±»çš„æˆå‘˜å‡½æ•°è®¾å®šä¸ºçº¿ç¨‹å‡½æ•°,æˆ‘ä»¬åˆ™åº”è¯¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ,æŒ‡å‘è¯¥æˆå‘˜å‡½æ•°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">X</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">do_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
X my_x<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>X<span class="token double-colon punctuation">::</span>do_something<span class="token punctuation">,</span><span class="token operator">&amp;</span>my_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>c++11å¼•å…¥äº†å¦ä¸€ç§ä¼ é€’å‚æ•°çš„æ–¹å¼:å‚æ•°åªèƒ½ç§»åŠ¨ä½†ä¸èƒ½å¤åˆ¶,å³æ•°æ®ä»æŸä¸ªå¯¹è±¡è½¬ç§»åˆ°å¦ä¸€ä¸ªå¯¹è±¡æ—¶,åŸå¯¹è±¡åˆ™è¢«æ¬ç©ºã€‚è¿™ç§å‹åˆ«çš„å…¶ä¸­ä¸€ä¸ªä¾‹å­æ˜¯std::unique_ptr,å®ƒä¸ºåŠ¨æ€åˆ†é…çš„å¯¹è±¡æä¾›è‡ªåŠ¨åŒ–çš„å†…å­˜ç®¡ç†<br>
åœ¨ä»»ä½•æ—¶å€™å¯¹äºç»™å®šçš„å¯¹è±¡,åªå¯èƒ½å­˜åœ¨å”¯ä¸€ä¸€ä¸ªstd::unique_ptrå®ä¾‹æŒ‡å‘å®ƒ;è‹¥å®ä¾‹è¢«é”€æ¯,æ‰€æŒ‡å¯¹è±¡ä¹Ÿè¢«åˆ é™¤<br>
é€šè¿‡ç§»åŠ¨æ„é€ move constructorå’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦move assignment operator,å¯ä»¥å°†std::unique_ptrå®ä¾‹ä»ä¸€ä¸ªå¯¹è±¡è½¬ç§»åˆ°å¦ä¸€ä¸ªå¯¹è±¡,è€Œä¸ç”¨å¤åˆ¶å¯¹è±¡,è¿™ç§ç§»åŠ¨ä½¿æºå¯¹è±¡å˜æˆnullæŒ‡é’ˆ.</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">process_big_object</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>BigObject<span class="token operator">&gt;</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>BigObject<span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> BigObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span><span class="token function">prepare_data</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>process_big_object<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>std::move()è½¬ç§»big_objectçš„å½’å±æƒ</p>
<p>è™½ç„¶std::threadç±»å¹¶ä¸æ‹¥æœ‰åŠ¨æ€å¯¹è±¡ï¼Œä½†å®ƒä»¬æ‹¥æœ‰å¦ä¸€ç§èµ„æºï¼Œæ¯ä»½å®ä¾‹éƒ½è´Ÿè´£ç®¡æ§ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹.å› ä¸ºstd::threadç±»çš„å®ä¾‹èƒ½å¤Ÿè¢«ç§»åŠ¨å´ä¸èƒ½å¤åˆ¶ï¼Œæ•…çº¿ç¨‹çš„å½’å±æƒå¯ä»¥åœ¨å…¶å®ä¾‹ä¹‹é—´è½¬ç§»</p>
<p>åªè¦std::threadå¯¹è±¡æ­£åœ¨ç®¡æ§ç€ä¸€ä¸ªçº¿ç¨‹,å°±ä¸èƒ½ç®€å•åœ°å‘å®ƒèµ‹æ–°å€¼,å¦åˆ™è¯¥çº¿ç¨‹ä¼šå› æ­¤è¢«é—å¼ƒ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">some_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">some_other_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>some_function<span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>thread t2<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
t1<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>some_other_function<span class="token punctuation">)</span><span class="token punctuation">;</span> 
std<span class="token double-colon punctuation">::</span>thread <span class="token function">t3</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
t1<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>some_function<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é”™è¯¯, t1æ­£åœ¨è¿è¡Œçº¿ç¨‹</span>
</code></pre><p>ä»å‡½æ•°å†…éƒ¨è¿”å›std::threadå¯¹è±¡</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>thread <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">some_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>some_function<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
std<span class="token double-colon punctuation">::</span>thread <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">some_other_function</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>some_other_function<span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> t<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//ç±»ä¼¼çš„,è‹¥å½’å±æƒå¯ä»¥è½¬ç§»åˆ°å‡½æ•°å†…éƒ¨,å‡½æ•°å°±èƒ½æ¥å—std::threadå®ä¾‹ä½œä¸ºæŒ‰å³å€¼ä¼ é€’çš„å‚æ•°</span>

<span class="token keyword keyword-void">void</span> <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>thread t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">some_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>some_function<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>some_function<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">scoped_thread</span><span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>thread t<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">scoped_thread</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&amp;&amp;</span> t_<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">t</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>t_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-throw">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"No thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">scoped_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">scoped_thread</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> scoped_thread<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    scoped_thread<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> scoped_thread<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">joining_thread</span><span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>thread t<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">joining_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-noexcept">noexcept</span><span class="token operator">=</span> <span class="token keyword keyword-default">default</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Callable</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">&gt;</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">joining_thread</span><span class="token punctuation">(</span>Callable<span class="token operator">&amp;&amp;</span> func<span class="token punctuation">,</span>Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">t</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Callable<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">joining_thread</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&amp;&amp;</span> t_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">t</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>t_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">joining_thread</span><span class="token punctuation">(</span>joining_thread<span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span><span class="token keyword keyword-noexcept">noexcept</span><span class="token operator">:</span><span class="token function">t</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    joining_thread<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>joining_thread<span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span><span class="token keyword keyword-noexcept">noexcept</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token operator">*</span><span class="token keyword keyword-this">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">joining_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>joining_thread<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token keyword keyword-noexcept">noexcept</span><span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>id <span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-noexcept">noexcept</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> t<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-bool">bool</span> <span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-noexcept">noexcept</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> t<span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-throw">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"No thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&amp;</span> <span class="token function">as_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-noexcept">noexcept</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-const">const</span> std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&amp;</span> <span class="token function">as_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-noexcept">noexcept</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ç”Ÿæˆå¤šä¸ªçº¿ç¨‹,å¹¶ç­‰å¾…å®ƒä»¬å®Œæˆè¿ä½œ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">do_work</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> threads<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
        threads<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>do_work<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span><span class="token operator">&amp;</span> t<span class="token operator">:</span>threads<span class="token punctuation">)</span><span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>çº¿ç¨‹å®‰å…¨çš„stack</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stack&gt;</span></span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">empty_stack</span><span class="token operator">:</span><span class="token base-clause">std<span class="token double-colon punctuation">::</span><span class="token class-name">exception</span></span><span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-char">char</span><span class="token operator">*</span> <span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-throw">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_stack</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>stack<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
        <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">threadsafe_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">threadsafe_stack</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_stack<span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token operator">=</span>other<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        threadsafe_stack<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_stack<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">empty_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-auto">auto</span> res<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ¡ä»¶ç«äº‰æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æŠ¢å…ˆè¿è¡Œ,æ­»é”åˆ™æ˜¯å…¶åé¢,ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶äº’ç›¸ç­‰å¾…ï¼Œåœæ»ä¸å‰</p>
<p>c++æä¾›std::lock()å‡½æ•°åŒæ—¶é”ä½å¤šä¸ªäº’æ–¥,è€Œæ²¡æœ‰å‘ç”Ÿæ­»é”çš„é£é™©</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">some_big_object</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>some_big_objec<span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span>some_big_object<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">X</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        some_big_object some_detail<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">X</span><span class="token punctuation">(</span>some_big_object <span class="token operator">&amp;</span> sd<span class="token punctuation">)</span><span class="token double-colon punctuation">::</span><span class="token function">some_detail</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-friend">friend</span> <span class="token keyword keyword-void">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>X<span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span>X<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lhs<span class="token operator">==</span><span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>m<span class="token punctuation">,</span>rhs<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock_a</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>m<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>adopt_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock_b</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>m<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>adopt_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">swap</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>some_detail<span class="token punctuation">,</span>rhs<span class="token punctuation">.</span>some_detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸€å¼€å§‹å¯¹æ¯”ä¸¤ä¸ªå‚æ•°,ä»¥ç¡®å®šå®ƒä»¬æŒ‡å‘ä¸åŒå®ä¾‹,æ­¤é¡¹åˆ¤æ–­å¿…ä¸å¯å°‘,åŸå› æ˜¯æˆ‘ä»¬å·²ç»åœ¨std::mutex ä¸ŠåŠ é”,é‚£ä¹ˆå†æ¬¡è¯•å›¾ä»è¯¥äº’æ–¥é”å°†å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸º<br>
ä»£ç è°ƒç”¨std::locké”å®šä¸¤ä¸ªäº’æ–¥,å¹¶æ ¹æ®å®ƒä»¬åˆ†åˆ«æ„é€ std::lock_guardå®ä¾‹<br>
æˆ‘ä»¬é™¤äº†ä½¿ç”¨äº’æ–¥å½“è¿™ä¸¤ä¸ªå®ä¾‹çš„æ„é€ å‚æ•°,è¿˜é¢å¤–æä¾›äº†std::adopt_lockå¯¹è±¡,ä»¥æŒ‡æ˜äº’æ–¥å·²è¢«é”ä½,å³äº’æ–¥ä¸Šæœ‰é”çš„å­˜åœ¨<br>
std::lockå‡½æ•°åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­,å¦‚æœæœ‰å¼‚å¸¸,ä¼šé‡Šæ”¾å®ƒçš„æ‰€è·å¾—çš„æ‰€æœ‰é”</p>
<p>é’ˆå¯¹ä»¥ä¸Šåœºæ™¯,c++17å¼•å…¥äº†std::scoped_lock,å®ƒå¯ä»¥åŒæ—¶é”ä½å¤šä¸ªäº’æ–¥,å¹¶åœ¨ææ„æ—¶è‡ªåŠ¨è§£é”,è€Œä¸éœ€è¦æ‰‹åŠ¨è§£é”</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>X<span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span>X<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lhs<span class="token operator">==</span><span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>scoped_lock <span class="token function">guard</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>m<span class="token punctuation">,</span>rhs<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>some_detail<span class="token punctuation">,</span>rhs<span class="token punctuation">.</span>some_detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è™½ç„¶æ­»é”çš„æœ€å¸¸è§è¯±å› æ˜¯é”æ“ä½œ,ä½†å³ä½¿æ²¡æœ‰ç‰µæ¶‰é”,ä¹Ÿä¼šå‘ç”Ÿæ­»é”æ“ä½œ.å‡å®šæœ‰ä¸¤ä¸ªçº¿ç¨‹,å„è‡ªå…³è”äº†std::threadå®ä¾‹,è‹¥å®ƒä»¬åŒæ—¶åœ¨å¯¹æ–¹çš„std::threadå®ä¾‹ä¸Šè°ƒç”¨join(),å°±èƒ½åˆ¶é€ æ­»é”ç°è±¡å´ä¸æ¶‰åŠé”æ“ä½œ</p>
<mark>
é˜²èŒƒæ­»é”çš„å‡†åˆ™æœ€ç»ˆå¯å½’çº³æˆä¸€ä¸ªæ€æƒ³:åªè¦å¦ä¸€çº¿ç¨‹æœ‰å¯èƒ½æ­£åœ¨ç­‰å¾…å½“å‰çº¿ç¨‹,é‚£ä¹ˆå½“å‰çº¿ç¨‹ä¸èƒ½åè¿‡æ¥ç­‰å¾…å®ƒ
</mark>
<ol>
<li>é¿å…åµŒå¥—é”</li>
<li>ä¸€ä½†æŒé”,å°±å¿…é¡»é¿å…è°ƒç”¨ç”±ç”¨æˆ·æä¾›çš„ç¨‹åºæ¥å£</li>
<li>ä¾ä»å›ºå®šé¡ºåºè·å–é”</li>
</ol>
<p>å‡å¦‚Aå’ŒBä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹,æ­£å‘éå†è¿›ç¨‹å…ˆè·å–Aé”å†è·å–Bé”ï¼Œåå‘éå†è¿›ç¨‹å…ˆè·å–Bé”å†è·å–Aé”,åˆ™ä¼šå‘ç”Ÿæ­»é”</p>
<ol start="4">
<li>æŒ‰å±‚çº§åŠ é”</li>
</ol>
<p>æŠŠåº”ç”¨ç¨‹åºåˆ†å±‚,å¹¶ä¸”æ˜ç¡®æ¯ä¸ªäº’æ–¥ä½äºå“ªä¸ªå±‚çº§.è‹¥æŸçº¿ç¨‹ä»¥å¯¹ä½å±‚çº§äº’æ–¥åŠ é”,åˆ™ä¸å‡†å®ƒå†å¯¹é«˜å±‚çº§äº’æ–¥åŠ é”,å…·ä½“åšæ³•æ˜¯å°†é¡¶å±‚çš„ç¼–å·èµ‹äºˆå¯¹åº”å±‚çº§åº”ç”¨ç¨‹åºä¸Šçš„äº’æ–¥,å¹¶è®°å½•å„çº¿ç¨‹åˆ†åˆ«é”å®šäº†å“ªäº›äº’æ–¥</p>
<p>ä¸‹é¢è¿™ä¸ªä¾‹å­ç¤ºèŒƒäº†ä¸¤ä¸ªçº¿ç¨‹å¦‚ä½•è¿ç”¨å±‚çº§äº’æ–¥</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>hierachical_mutex <span class="token function">high_level_mutex</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hierachical_mutex <span class="token function">low_level_mutex</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hierachical_mutex <span class="token function">other_mutex</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-int">int</span> <span class="token function">do_low_level_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-int">int</span> <span class="token function">low_level_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>hierachical_mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>low_level_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">do_low_level_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">high_level_stuff</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> some_param<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">high_level_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>hierachical_mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>high_level_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">high_level_stuff</span><span class="token punctuation">(</span><span class="token function">low_level_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">thread_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">high_level_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">do_other_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">other_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>hierachical_mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>other_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">do_other_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">thread_b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>hierachical_mutex<span class="token operator">&gt;</span><span class="token function">lk</span><span class="token punctuation">(</span>other_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">other_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šå¼ä¸­thread_bè¿åäº†è§„åˆ™,thread_bé”ä½äº†ä¸­å±‚é”,ä½†å†…éƒ¨å´ç´¢å–äº†é«˜çº§é”,ä¼šæŠ¥é”™æˆ–å‘ç”Ÿå¼‚å¸¸<br>
ä¸ºè‡ªå®šä¹‰çš„hierarchical_mutexç±»å®ç°å±‚çº§äº’æ–¥<br>
ä¸ºäº†ä½¿ç”¨lock_guard é”ä½äº’æ–¥ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<br>
lock(),unlock()å‡½æ•°,ä»¥åŠtry_lock()å‡½æ•°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">hierachical_mutex</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>mutex internal_mutex<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> hierachy_value<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> previous_hierachy_value<span class="token punctuation">;</span>
    <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-thread_local">thread_local</span> <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> this_thread_hierachy_value<span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">check_for_hierarchy_violation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>this_thread_hierachy_value <span class="token operator">&lt;=</span>hierachy_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-throw">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"Hierachy violation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">update_hierachy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        previous_hierachy_value <span class="token operator">=</span> this_thread_hierachy_value<span class="token punctuation">;</span>
        this_thread_hierachy_value <span class="token operator">=</span> hierachy_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">hierachical_mutex</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> value<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">hierachy_value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">previous_hierachy_value</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token function">check_for_hierarchy_violation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       internal_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">update_hierachy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>this_thread_hierachy_value <span class="token operator">!=</span> hierachy_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-throw">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"Hierachy violation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        this_thread_hierachy_value <span class="token operator">=</span> previous_hierachy_value<span class="token punctuation">;</span>
        internal_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-bool">bool</span> <span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">check_for_hierarchy_violation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>internal_mutex<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">update_hierachy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-thread_local">thread_local</span> <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> hierachical_mutex<span class="token double-colon punctuation">::</span><span class="token function">this_thread_hierachy_value</span><span class="token punctuation">(</span>ULLONG_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><p>å¼€å§‹é˜¶æ®µ,å°†å±‚çº§ç¼–å·å®šä¹‰ä¸ºæœ€å¤§<br>
ä»»æ„hierachical_mutexäº’æ–¥éƒ½èƒ½è¢«åŠ é”ã€‚å› æ­¤å£°æ˜ç”±thread_localä¿®é¥°,æ¯ä¸ªçº¿ç¨‹éƒ½å…·æœ‰è‡ªå·±çš„this_thread_hierachy_valueå‰¯æœ¬,æ‰€ä»¥è¯¥å˜é‡åœ¨æŸä¸ªçº¿ç¨‹ä¸Šçš„å€¼ä¸å¦ä¸€çº¿ç¨‹å€¼å®Œå…¨æ— å…³,</p>
<p>è¿ç”¨std::unique_lock&lt;&gt;çµæ´»åŠ é”</p>
<p>æ„é€ å‡½æ•°æ¥å—ç¬¬äºŒå‚æ•°,å¯ä»¥ä¼ å…¥<br>
ä¾‹å¦‚:adopt_lockå®ä¾‹,ä»¥æŒ‡æ˜std::unique_lockå¯¹è±¡ç®¡ç†äº’æ–¥ä¸Šçš„é”</p>
<p>ä¼ å…¥std::defer_lockä½¿äº’æ–¥åœ¨å®Œæˆæ„é€ æ—¶å¤„äºæ— é”çŠ¶æ€</p>
<p>std::unique_lockå¯¹è±¡å¯ä»¥ä¸å æœ‰å…³è”çš„äº’æ–¥<br>
ä½†æ¯”std::lock_guardç•¥æ…¢ä¸”å ç”¨æ›´å¤šçš„ç©ºé—´</p>
<p>ock_guard æ˜¯åŸºäºäº’æ–¥é” std::mutex å®ç°çš„ï¼Œunique_lock æ˜¯åŸºäºé€šç”¨é” std::unique_lock å®ç°çš„ï¼Œunique_lock å¯ä»¥å®ç°æ¯” lock_guard æ›´çµæ´»çš„é”æ“ä½œã€‚<br>
lock_guard æ˜¯ä¸å¯ç§»åŠ¨çš„ï¼ˆmoveableï¼‰ï¼Œå³ä¸èƒ½æ‹·è´ã€èµ‹å€¼ã€ç§»åŠ¨ï¼Œåªèƒ½é€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–å’Œææ„å‡½æ•°é”€æ¯ï¼Œunique_lock æ˜¯å¯ç§»åŠ¨çš„ï¼Œå¯ä»¥æ‹·è´ã€èµ‹å€¼ã€ç§»åŠ¨ã€‚<br>
unique_lock æä¾›äº†æ›´å¤šçš„æ§åˆ¶é”çš„è¡Œä¸ºï¼Œæ¯”å¦‚é”è¶…æ—¶ã€ä¸é”å®šã€æ¡ä»¶å˜é‡ç­‰ã€‚<br>
unique_lock æ¯” lock_guard æ›´é‡ï¼Œå› ä¸ºå®ƒæœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Œæ›´å¤šçš„å¼€é”€ã€‚å¦‚æœåªéœ€è¦ç®€å•çš„äº’æ–¥ä¿æŠ¤ï¼Œä½¿ç”¨ lock_guard æ›´å¥½ã€‚</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">some_big_object</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>some_big_object<span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span>some_big_object<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">X</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        some_big_object some_detail<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">X</span><span class="token punctuation">(</span>some_big_object <span class="token operator">&amp;</span> sd<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">some_detail</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-friend">friend</span> <span class="token keyword keyword-void">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>X<span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span>X<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lhs<span class="token operator">==</span><span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock_a</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>mtx<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>defer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock_b</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>mtx<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>defer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span>lock_a<span class="token punctuation">,</span>lock_b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤æ—¶æ‰å¯¹äº’æ–¥åŠ é”</span>
            <span class="token function">swap</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>some_detail<span class="token punctuation">,</span>rhs<span class="token punctuation">.</span>some_detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>äº’æ–¥çš„å½’å±æƒå¯ä»¥åœ¨å¤šä¸ªstd::unique_lockå®ä¾‹ä¹‹é—´è½¬ç§»,ä½†ä¸èƒ½å¤åˆ¶<br>
è½¬ç§»å¯ä»¥è‡ªåŠ¨å‘ç”Ÿ,è­¬å¦‚ä»å‡½æ•°è¿”å›å®ä¾‹æ—¶,ä½†æˆ‘ä»¬å¿…é¡»é’ˆå¯¹åˆ«çš„æƒ…å½¢è°ƒç”¨std::move()<br>
std::unique_lockå¯è½¬ç§»ä¸å¯å¤åˆ¶</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">get_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-extern">extern</span> std<span class="token double-colon punctuation">::</span>mutex some_mutex<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>some_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prepare_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> lk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">process_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span><span class="token function">get_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">do_something_with_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢çš„æ¨¡å¼ä¸»è¦åœ¨ä¸¤ç§æƒ…å½¢ä¸‹ä½¿ç”¨:</p>
<ol>
<li>äº’æ–¥åŠ é”çš„æ—¶æœºå–å†³äºç¨‹åºçš„å½“å‰çŠ¶æ€;</li>
<li>æˆ–è€…,æŸå‡½æ•°è´Ÿè´£æ‰§è¡ŒåŠ é”æ“ä½œå¹¶è¿”å›std::unique_lockå¯¹è±¡,è€Œäº’æ–¥åŠ é”æ—¶æœºåˆ™ç”±ä¼ å…¥çš„å‚æ•°å†³å®š</li>
</ol>
<p>é”çš„è§’è‰²æ˜¯å…¶æ•°æ®æˆå‘˜,ç”¨äºä¿è¯åªæœ‰æ­£ç¡®åŠ é”æ‰èƒ½å¤Ÿè®¿é—®å—ä¿æŠ¤æ•°æ®<br>
æ‰€æœ‰æ•°æ®é€šè¿‡é€šé“ç±»è®¿é—®,è‹¥æƒ³è®¿é—®æ•°æ®,åˆ™éœ€è¦å…ˆå–å¾—é€šé“ç±»çš„å®ä¾‹<br>
å†å€Ÿå®ƒæ‰§è¡ŒåŠ é”æ“ä½œ,ç„¶åé€šè¿‡é€šé“å¯¹è±¡çš„æˆå‘˜å‡½æ•°æ‰å¾—ä»¥è®¿é—®æ•°æ®</p>
<p>æˆ‘ä»¬åœ¨è®¿é—®å®Œæˆåé”€æ¯é€šé“å¯¹è±¡,é”éšä¹‹é‡Šæ”¾<br>
std::unique_lockç±»å…è®¸å®ƒçš„å®ä¾‹åœ¨è¢«é”€æ¯å‰è§£é”<br>
å…¶æˆå‘˜å‡½æ•°unlock()è´Ÿè´£è§£é”æ“ä½œ,è¿™ä¸äº’æ–¥ä¸€è‡´</p>
<p>æŒé”æœŸé—´åº”é¿å…ä»»ä½•è€—æ—¶çš„æ“ä½œ,å¦‚è¯»å†™æ–‡ä»¶<br>
åŒæ ·æ˜¯è¯»å†™æ–‡ä»¶æ€»é‡ç›¸ç­‰çš„æ•°æ®,æ–‡ä»¶æ“ä½œä¼šæ…¢çš„å¤š</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">get_and_process_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">my_lock</span><span class="token punctuation">(</span>the_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    some_class data_to_process <span class="token operator">=</span> <span class="token function">get_next_data_chunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å‡å®šprocessæ— éœ€åŠ é”</span>
    result_type result <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>data_to_process<span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_result</span><span class="token punctuation">(</span>data_to_process<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>åœ¨æ¯”è¾ƒè¿ç®—çš„è¿‡ç¨‹ä¸­,æ¯æ¬¡åªé”ä½ä¸€ä¸ªäº’æ–¥</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">Y</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-int">int</span> some_detail<span class="token punctuation">;</span>
        <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
        <span class="token keyword keyword-int">int</span> <span class="token function">get_detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> some_detail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">Y</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> sd<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">some_detail</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-friend">friend</span> <span class="token keyword keyword-bool">bool</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Y<span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span><span class="token keyword keyword-const">const</span> Y<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lhs<span class="token operator">==</span><span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-int">int</span> <span class="token keyword keyword-const">const</span> lhs_detail <span class="token operator">=</span> lhs<span class="token punctuation">.</span><span class="token function">get_detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-int">int</span> <span class="token keyword keyword-const">const</span> rhs_detail <span class="token operator">=</span> rhs<span class="token punctuation">.</span><span class="token function">get_detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> lhs_detail<span class="token operator">==</span>rhs_detail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="ä¿æŠ¤å…±äº«æ•°æ®çš„å…¶ä»–å·¥å…·">ä¿æŠ¤å…±äº«æ•°æ®çš„å…¶ä»–å·¥å…· </h3>
<p>å‡è®¾æˆ‘ä»¬éœ€è¦æŸä¸ªå…±äº«æ•°æ®,è€Œå®ƒåˆ›å»ºèµ·æ¥å¼€é”€ä¸è²<br>
æ‰€ä»¥ç­‰åˆ°å¿…è¦æ—¶æ‰çœŸæ­£ç€æ‰‹åˆ›å»º,è¿™ç§æ–¹å¼ç§°ä¸ºå»¶è¿Ÿåˆå§‹åŒ–</p>
<p>ç”¨äº’æ–¥å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>some_resource<span class="token operator">&gt;</span> resource_ptr<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>mutex resource_mutex<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//æ­¤å¤„,å…¨éƒ¨çº¿ç¨‹éƒ½è¢«è¿«è¿è¡Œ</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>resource_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>resource_ptr<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        resource_ptr<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> some_resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resource_ptr<span class="token operator">-&gt;</span><span class="token function">do_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¿…è¦çš„åŒæ­¥æ•°æ®ç”±std::once_flagå®ä¾‹å­˜å‚¨<br>
æ¯ä¸ªstd::once_flag å®ä¾‹å¯¹åº”ä¸€æ¬¡ä¸åŒçš„åˆå§‹åŒ–</p>
<p>ç›¸æ¯”æ˜¾å¼ä½¿ç”¨äº’æ–¥,std::call_once()å‡½æ•°çš„é¢å¤–å¼€é”€å¾€å¾€æ›´ä½</p>
<p>ç‰¹åˆ«æ˜¯åœ¨åˆå§‹åŒ–å·²ç»å®Œæˆçš„æƒ…å†µä¸‹,å¦‚æœåŠŸèƒ½ç¬¦åˆéœ€æ±‚å°±åº”ä¼˜å…ˆä½¿ç”¨</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>some_resource<span class="token operator">&gt;</span> resource_ptr<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>once_flag resource_flag<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">init_resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    resource_ptr<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> some_resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//åˆå§‹åŒ–å‡½æ•°å‡†ç¡®åœ°è¢«å”¯ä¸€ä¸€æ¬¡è°ƒç”¨</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">call_once</span><span class="token punctuation">(</span>resource_flag<span class="token punctuation">,</span>init_resource<span class="token punctuation">)</span>
    resource_ptr<span class="token operator">-&gt;</span><span class="token function">do_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">X</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        connection_info connection_details<span class="token punctuation">;</span>
        connection_handle connection<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>once_flag connection_init_flag<span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">open_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            connection <span class="token operator">=</span> connection_manager<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>connection_details<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">X</span><span class="token punctuation">(</span>connection_info <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> connection_details_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">connection_details</span><span class="token punctuation">(</span>connection_details_<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">send_data</span><span class="token punctuation">(</span>data_packet <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">call_once</span><span class="token punctuation">(</span>connection_init_flag<span class="token punctuation">,</span><span class="token operator">&amp;</span>X<span class="token double-colon punctuation">::</span>open_connection<span class="token punctuation">,</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">send_data</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        data_packet <span class="token function">receive_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">call_once</span><span class="token punctuation">(</span>connection_init_flag<span class="token punctuation">,</span><span class="token operator">&amp;</span>X<span class="token double-colon punctuation">::</span>open_connection<span class="token punctuation">,</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> connection<span class="token punctuation">.</span><span class="token function">receive_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>c++11è§„å®šåˆå§‹åŒ–åªä¼šåœ¨æŸä¸€çº¿ç¨‹ä¸Šå•ç‹¬å‘ç”Ÿ,åœ¨åˆå§‹åŒ–å®Œæˆä¹‹å‰,<br>
å…¶ä»–çº¿ç¨‹ä¸ä¼šè¶Šè¿‡é™æ€æ•°æ®çš„å£°æ˜è€Œç»§ç»­è¿è¡Œ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">my_class</span><span class="token punctuation">;</span>
my_class<span class="token operator">&amp;</span> <span class="token function">get_my_class_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-static">static</span> my_class instance<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨è°ƒç”¨get_my_class_instance()å‡½æ•°,è€Œæ— é¡»æ‹…å¿§åˆå§‹åŒ–æ¡ä»¶çš„ç«äº‰</p>
<p>è€ƒè™‘ä¸€ä¸ªå­˜å‚¨ç€DNSæ¡ç›®çš„ç¼“å­˜è¡¨,å®ƒå°†åŸŸåè§£é‡Šæˆå¯¹åº”çš„IPåœ°å€<br>
ç»™å®šDNSæ¡ç›®é€šå¸¸åœ¨å¾ˆé•¿æ—¶é—´å†…éƒ½ä¸ä¼šå˜åŒ–<br>
DNSæ¡ç›®ä¿æŒå¤šå¹´ä¸å˜.å°½ç®¡éšç€ç”¨æˆ·è®¿é—®ä¸åŒç½‘ç«™,ç¼“å­˜è¡¨ä¼šä¸æ—¶åŠ å…¥æ–°æ¡ç›®,ä½†åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Š<br>
æ•°æ®åœ¨æ•´ä¸ªç”Ÿå‘½æœŸå†…å°†ä¿æŒä¸å˜ã€‚ä¸ºäº†åˆ¤æ–­æ•°æ®æ˜¯å¦æœ‰æ•ˆ,å¿…é¡»å®šæœŸæ£€æŸ¥ç¼“å­˜è¡¨</p>
<p>std::mutexè¿‡äºä¸¥è‹›,å³ä½¿æ²¡æœ‰å‘ç”Ÿæ•°æ®å˜åŠ¨ï¼Œç…§æ ·ä¼šç¦æ­¢å¹¶å‘è®¿é—®ï¼Œç”±äºæ–°çš„äº’æ–¥å…·æœ‰ä¸¤ç§ä¸åŒçš„ä½¿ç”¨æ–¹å¼,å› æ­¤é€šå¸¸è¢«ç§°ä¸ºè¯»å†™äº’æ–¥</p>
<p>c++17æä¾›,åˆ©ç”¨std::shared_mutexå®æ–½åŒæ­¥æ“ä½œ.æ›´æ–°æ“ä½œå¯ç”¨std::lock_guard<a href="std::shared_mutex">std::shared_mutex</a>åŠ é”,è€Œè¯»å–æ“ä½œå¯ç”¨std::shared_lock<a href="std::shared_mutex">std::shared_mutex</a>å’Œstd::unique_lock<a href="std::shared_mutex">std::shared_mutex</a>åŠ é”</p>
<p>å¯¹äºå†™çœ‹ä½¿ç”¨std::shared_lock<a href="std::shared_mutex">std::shared_mutex</a>å®ç°å…±äº«è®¿é—®</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;shared_mutex&gt;</span></span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">dns_entry</span><span class="token punctuation">;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">dns_cache</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span>dns_entry<span class="token operator">&gt;</span> cache<span class="token punctuation">;</span>
    <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>shared_mutex cache_mutex<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    dns_entry <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> <span class="token function">get_entry</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> domain<span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>shared_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>shared_mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>entry_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span>dns_entry<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>const_iterator it <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> entries<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">dns_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">update_or_add_entry</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> domain<span class="token punctuation">,</span>dns_entry <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> dns_details<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>shared_mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>entry_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        entries<span class="token punctuation">[</span>domain<span class="token punctuation">]</span><span class="token operator">=</span>dns_details<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åŠ å…¥çº¿ç¨‹å·²ç»æŒæœ‰æŸä¸ªstd::mutexå®ä¾‹,è¯•å›¾å†æ¬¡å¯¹å…¶é‡æ–°åŠ é”å°±ä¼šå‡ºé”™,å°†å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚ä½†åœ¨æŸäº›åœºæ™¯ä¸­,å´æœ‰éœ€è¦è®©çº¿ç¨‹åœ¨åŒä¸€äº’æ–¥ä¸Šå¤šæ¬¡é‡å¤åŠ é”,è€Œæ— é¡»è§£é”ï¼Œc++æ ‡å‡†åº“ä¸ºæ­¤æä¾›äº†std::recursive_mutex,å…¶å·¥ä½œæ–¹å¼ä¸std::mutexç›¸ä¼¼,ä¸åŒä¹‹å¤„ï¼Œå…¶å…è®¸åŒä¸€çº¿ç¨‹å¯¹æŸäº’æ–¥çš„åŒä¸€å®ä¾‹å¤šæ¬¡åŠ é”</p>
<p>æ¯”å¦‚å½“å…¬æœ‰å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªå…¬æœ‰å‡½æ•°<br>
å®¹è®¸ç¬¬äºŒä¸ªå…¬æœ‰å‡½æ•°æˆåŠŸåœ°å¯¹é€’å½’äº’æ–¥åŠ é”<br>
ä½†ä¸€èˆ¬æ›´å¥½çš„æ–¹æ³•æ˜¯æ ¹æ®è¿™ä¸¤ä¸ªå…¬æœ‰å‡½æ•°çš„å…±åŒéƒ¨åˆ†,æå–å‡ºä¸€ä¸ªæ–°çš„ç§æœ‰å‡½æ•°</p>
<h2 id="å¹¶å‘æ“ä½œçš„åŒæ­¥">å¹¶å‘æ“ä½œçš„åŒæ­¥ </h2>
<p>å‡­å€Ÿæ¡ä»¶å˜é‡ç­‰å¾…æ¡ä»¶æˆç«‹</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">data_chunk</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-int">int</span> data<span class="token punctuation">;</span>
    <span class="token function">data_chunk</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> d<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">data</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
data_chunk <span class="token function">prepare_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">data_chunk</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
std<span class="token double-colon punctuation">::</span>mutex mut<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>data_chunk<span class="token operator">&gt;</span> data_queue<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>condition_variable data_cond<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">data_preparation_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
       data_chunk <span class="token keyword keyword-const">const</span> data <span class="token operator">=</span> <span class="token function">prepare_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       data_cond<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">data_processing_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span><span class="token operator">!</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data_chunk data <span class="token operator">=</span> data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Processing data: "</span> <span class="token operator">&lt;&lt;</span> data<span class="token punctuation">.</span>data <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>std::condition_variableå®ä¾‹ä¸Šè°ƒç”¨wait(),ä¼ å…¥é”å¯¹è±¡å’Œä¸€ä¸ªlamdaå‡½æ•°,åè€…ç”¨äºè¡¨è¾¾éœ€è¦ç­‰å¾…æˆç«‹çš„æ¡ä»¶,lamdaå‡½æ•°æ˜¯c++11çš„æ–°ç‰¹æ€§<br>
wait()åœ¨å†…éƒ¨è°ƒç”¨ä¼ å…¥çš„lamdaå‡½æ•°,åˆ¤æ–­æ¡ä»¶æ˜¯å¦æˆç«‹;è‹¥æˆç«‹(lamdaå‡½æ•°è¿”å›true)åˆ™wait()è¿”å›,å¦åˆ™wait()è§£é”äº’æ–¥,å¹¶ä»¤çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€æˆ–ç­‰å¾…çŠ¶æ€<br>
æ•°æ®å‡†å¤‡çº¿ç¨‹è°ƒç”¨notify_one()é€šçŸ¥æ¡ä»¶å˜é‡,çº¿ç¨‹ç”²éšä¹‹ä»ä¼‘çœ ä¸­è§‰é†’,é‡æ–°åœ¨äº’æ–¥ä¸Šè·å–é”ï¼Œå†æ¬¡æŸ¥éªŒæ¡ä»¶;è‹¥æ¡ä»¶æˆç«‹,åˆ™ä»wait()å‡½æ•°è¿”å›,ä»è·å–é”ï¼Œè€Œå¦‚æœæ¡ä»¶ä¸æˆç«‹ï¼Œå°±è§£é”äº’æ–¥ç»§ç»­ç­‰å¾…</p>
<p>ä½¿ç”¨unique_lockå°±æ˜¯ä¸ºäº†è®©å¤„ç†æ•°æ®çš„çº¿ç¨‹ç”²èƒ½å¤Ÿé‡Šæ”¾äº’æ–¥</p>
<p>åˆ©ç”¨æ¡ä»¶å˜é‡æ„å»ºçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex mut<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data_queue<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>condition_variable data_cond<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span>threadsafe_queue <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue <span class="token operator">=</span> other<span class="token punctuation">.</span>data_queue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword keyword-this">this</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span><span class="token operator">!</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword keyword-this">this</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span><span class="token operator">!</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">try_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_gurad<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">try_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><hr>
<mark>
åœ¨C++ä¸­ï¼Œstd::adopt_lockæ˜¯ä¸€ä¸ªé”å®šç­–ç•¥ï¼Œå®ƒå‘Šè¯‰lock_guardæˆ–unique_lockå¯¹è±¡ï¼Œäº’æ–¥é‡åœ¨ä¼ é€’ç»™é”å®šå¯¹è±¡ä¹‹å‰å·²ç»è¢«å½“å‰çº¿ç¨‹é”å®šã€‚è¿™æ„å‘³ç€é”å®šå¯¹è±¡åœ¨æ„é€ æ—¶ä¸ä¼šå°è¯•é”å®šäº’æ–¥é‡ï¼Œè€Œæ˜¯â€œæ”¶å…»â€å·²ç»å­˜åœ¨çš„é”ã€‚
</mark>
<hr>
<mark>
å½“ä½ éœ€è¦å¯¹å¤šä¸ªäº’æ–¥ä½“è¿›è¡Œæ“ä½œæ—¶ï¼Œä½¿ç”¨std::defer_lockå¯ä»¥é¿å…æ­»é”çš„é£é™©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸¤ä¸ªstd::unique_lockå¯¹è±¡å¹¶åˆ†åˆ«å¯¹ä¸¤ä¸ªäº’æ–¥ä½“ä¸Šé”ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹ä¸­çš„ä¸€ä¸ªå…ˆé”å®šäº†ç¬¬ä¸€ä¸ªäº’æ–¥ä½“ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹å…ˆé”å®šäº†ç¬¬äºŒä¸ªäº’æ–¥ä½“ï¼Œå°±å¯èƒ½å‘ç”Ÿæ­»é”ã€‚ä½¿ç”¨std::defer_lockï¼Œä½ å¯ä»¥å»¶è¿Ÿé”å®šæ“ä½œï¼Œç›´åˆ°å¯ä»¥å®‰å…¨åœ°åŒæ—¶é”å®šä¸¤ä¸ªäº’æ–¥ä½“ã€‚
</mark>
<hr>
<h3 id="ä½¿ç”¨futureç­‰å¾…ä¸€æ¬¡æ€§äº‹ä»¶å‘ç”Ÿ">ä½¿ç”¨futureç­‰å¾…ä¸€æ¬¡æ€§äº‹ä»¶å‘ç”Ÿ </h3>
<p>c++æ ‡å‡†ç¨‹åºåº“ä½¿ç”¨futureæ¥æ¨¡æ‹Ÿè¿™ç±»ä¸€æ¬¡æ€§äº‹ä»¶:è‹¥çº¿ç¨‹éœ€è¦ç­‰å¾…æŸä¸ªç‰¹å®šçš„ä¸€æ¬¡æ€§äº‹ä»¶å‘ç”Ÿ,åˆ™ä¼šä»¥æ°å½“çš„æ–¹å¼å–å¾—ä¸€ä¸ªfutureï¼Œå®ƒä»£è¡¨ç›®æ ‡äº‹ä»¶,æ¥ç€ï¼Œçº¿ç¨‹å°±èƒ½ä¸€è¾¹æ‰§è¡Œå…¶ä»–ä»»åŠ¡ä¸€è¾¹åœ¨futureä¸Šç­‰å¾…ï¼›åŒæ—¶,å®ƒä»¥çŸ­æš‚çš„é—´éš”åå¤æŸ¥éªŒç›®æ ‡äº‹ä»¶å·²ç»å‘ç”Ÿ<br>
è¯¥çº¿ç¨‹ä¹Ÿå¯ä»¥è½¬æ¢è¿è¡Œæ¨¡å¼,å…ˆä¸ç­‰ç›®æ ‡äº‹ä»¶å‘ç”Ÿï¼Œç›´æ¥æš‚ç¼“å½“å‰ä»»åŠ¡è€Œåˆ‡æ¢åˆ°åˆ«çš„ä»»åŠ¡,åŠè‡³å¿…è¦æ—¶,æ‰å›å¤´ç­‰å¾…futureå‡†å¤‡å°±ç»ªï¼Œfutureå¯èƒ½ä¸æ•°æ®ç›¸å…³ä¹Ÿå¯èƒ½æœªç›¸å…³<br>
ä¸€æ—¦ç›®æ ‡äº‹ä»¶å‘ç”Ÿ,å…¶futureå°±è¿›å…¥å°±ç»ªçŠ¶æ€,æ— æ³•é‡ç½®</p>
<p>c++æ ‡å‡†ç¨‹åºåº“æœ‰ä¸¤ç§future,åˆ†åˆ«ç”±ä¸¤ä¸ªç±»æ¨¡æ¿å®ç°ï¼Œå…¶å£°æ˜ä½äºæ ‡å‡†åº“çš„å¤´æ–‡ä»¶<future>å†…ï¼Œç‹¬å future(unique_future,å³std::future&lt;&gt;)å’Œå…±äº«fture(shared_future&lt;&gt;)</future></p>
<p>åŒä¸€äº‹ä»¶ä»…ä»…å…è®¸å…³è”å”¯ä¸€ä¸€ä¸ªstd::futureå®ä¾‹,ä½†å¯ä»¥å…³è”å¤šä¸ªstd::shared_futureå®ä¾‹,åªè¦ç›®æ ‡äº‹ä»¶å‘ç”Ÿ,ä¸åè€…å…³è”çš„æ‰€æœ‰å®ä¾‹å°±ä¼šåŒæ­¥å°±ç»ªï¼Œå¹¶ä¸”ä»–ä»¬å…¨éƒ½å¯ä»¥è®¿é—®ä¸è¯¥ç›®æ ‡äº‹ä»¶å…³è”çš„ä»»ä½•æ•°æ®ï¼Œå…³è”æ•°æ®æ­£æ˜¯ä¸¤ç§futureä»¥æ¨¡æ¿å½¢å¼å®ç°çš„åŸå› </p>
<p>å¦‚æœæ²¡æœ‰å…³è”æ•°æ®ï¼Œæˆ‘ä»¬åº”ä½¿ç”¨ç‰¹åŒ–çš„æ¨¡æ¿std::future<void>å’Œstd::shared_future<void></void></void></p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;future&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword keyword-int">int</span> <span class="token function">find_the_answer_to_ltuae</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">do_other_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> the_answer <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>find_the_answer_to_ltuae<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">do_other_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"The answer to life, the universe, and everything is: "</span> <span class="token operator">&lt;&lt;</span> the_answer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>std::async()å’Œstd::threadçš„æ„é€ å‡½æ•°ç›¸åŒï¼Œè‹¥è¦å¼‚æ­¥è¿è¡ŒæŸä¸ªç±»çš„æŸæˆå‘˜å‡½æ•°,åˆ™std::async()çš„ç¬¬ä¸€ä¸ªå‚æ•°åº”æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥ç±»çš„ç›®æ ‡æˆå‘˜å‡½æ•°,ç”¨ä½œæˆå‘˜å‡½æ•°çš„å‚æ•°</p>
<p>ç»™std::async()è¡¥å……ä¸€ä¸ªå‚æ•°,ä»¥æŒ‡å®šé‡‡ç”¨å“ªç§è¿è¡Œæ–¹å¼.å‚æ•°ç±»å‹ä¸ºstd::launch</p>
<p><mark>1. std::launch::deferred:å‰è€…æŒ‡å®šåœ¨å½“å‰çº¿ç¨‹ä¸Šå»¶åè°ƒç”¨ä»»åŠ¡å‡½æ•°,ç­‰åˆ°futureä¸Šè°ƒç”¨äº†waitæˆ–getï¼Œä»»åŠ¡å‡½æ•°æ‰ä¼šæ‰§è¡Œ;<br>
2. std::launch::async:åè€…æŒ‡å®šåœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸Šå¼‚æ­¥è¿è¡Œä»»åŠ¡å‡½æ•°,futureä¸Šè°ƒç”¨waitæˆ–getæ—¶,ä»»åŠ¡å‡½æ•°å·²ç»å®Œæˆ,è¿”å›å€¼ä¹Ÿå·²ç»å¯ç”¨;<br>
3. std::launch::async|std::launch::deferred:è¡¨ç¤ºç”±std::async()é€‰æ‹©è¿è¡Œæ–¹å¼,è¯¥é¡¹æ˜¯é»˜è®¤é¡¹<br>
</mark></p>
<h4 id="å…³è”futureå®ä¾‹å’Œä»»åŠ¡">å…³è”futureå®ä¾‹å’Œä»»åŠ¡ </h4>
<p>std::packaged_task&lt;&gt;è¿æ¥äº†futureå¯¹è±¡ä¸å‡½æ•°ï¼Œå…¶å¯¹è±¡æ‰§è¡Œä»»åŠ¡æ—¶ä¼šè°ƒç”¨å…³è”çš„å‡½æ•°(æˆ–å¯è°ƒç”¨å¯¹è±¡),æŠŠè¿”å›å€¼ä¿å­˜ä¸ºfutureçš„å†…éƒ¨æ•°æ®,å¹¶ä»¤futureå‡†å¤‡å°±ç»ª.å®ƒå¯ä½œä¸ºçº¿ç¨‹æ± çš„æ„å»ºå•å…ƒ<br>
std::packaged_task&lt;&gt;æ˜¯ç±»æ¨¡æ¿,å…¶æ¨¡æ¿å‚æ•°æ˜¯å‡½æ•°ç­¾åï¼Œè­¬å¦‚void()è¡¨ç¤ºä¸€ä¸ªå‡½æ•°,ä¸æ¥å—å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰è¿”å›å€¼ï¼Œint(std::string&amp;,double*)ä»£è¡¨æŸå‡½æ•°,å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°å¹¶è¿”å›intå€¼,å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éconstå¼•ç”¨,æŒ‡å‘std::stringå¯¹è±¡,ç¬¬äºŒä¸ªå‚æ•°æ˜¯doubleç±»å‹æŒ‡é’ˆ.<br>
ç±»æ¨¡æ¿std::packaged_task&lt;&gt;å…·æœ‰æˆå‘˜å‡½æ•°get_future(),å®ƒè¿”å›std::future&lt;&gt;å®ä¾‹ï¼Œè¯¥futureçš„ç‰¹åŒ–ç±»å‹å–å†³äºå‡½æ•°ç­¾åæ‰€æŒ‡å®šçš„è¿”å›å€¼<br>
å®šä¹‰ç‰¹åŒ–çš„std::packaged_task&lt;&gt;ç±»æ¨¡æ¿</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">packaged_task</span><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword keyword-char">char</span><span class="token operator">&gt;</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Callable</span><span class="token operator">&gt;</span>
        <span class="token keyword keyword-explicit">explicit</span> <span class="token function">packaged_task</span><span class="token punctuation">(</span>Callable<span class="token operator">&amp;&amp;</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> <span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword keyword-char">char</span><span class="token operator">&gt;</span><span class="token operator">*</span> data<span class="token punctuation">,</span><span class="token keyword keyword-int">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h4 id="åœ¨çº¿ç¨‹é—´ä¼ é€’ä»»åŠ¡">åœ¨çº¿ç¨‹é—´ä¼ é€’ä»»åŠ¡ </h4>
<p>è®¸å¤šå›¾å½¢ç”¨æˆ·ç•Œé¢GUIæ¡†æ¶éƒ½è®¾ç«‹äº†ä¸“é—¨çš„çº¿ç¨‹,ä½œä¸ºæ›´æ–°ç•Œé¢çš„å®é™…æ‰§è¡Œè€….è‹¥åˆ«çš„çº¿ç¨‹éœ€è¦æ›´æ–°ç•Œé¢,å°±å¿…é¡»å‘å®ƒå‘é€æ¶ˆæ¯,ç”±å®ƒæ‰§è¡Œæ“ä½œ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;deque&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;future&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;utility&gt;</span></span>

std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span> tasks<span class="token punctuation">;</span>
<span class="token keyword keyword-bool">bool</span> <span class="token function">gui_shutdown_message_received</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">get_and_process_gui_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">gui_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gui_shutdown_message_received</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">get_and_process_gui_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> task<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tasks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
            task<span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tasks<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">}</span>
        <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

std<span class="token double-colon punctuation">::</span>thread <span class="token function">gui_bg_thread</span><span class="token punctuation">(</span>gui_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Func</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;</span> <span class="token function">post_task_for_gui_thread</span><span class="token punctuation">(</span>Func f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;</span> res<span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><h4 id="åˆ›å»ºstdpromise">åˆ›å»ºstd::promise </h4>
<p>std::promiseå’Œstd::futureç»„åˆä½¿ç”¨,å¯ä»¥ä½¿ï¼šç­‰å¾…æ•°æ®çš„çº¿ç¨‹åœ¨futureä¸Šé˜»å¡ï¼Œè€Œæä¾›æ•°æ®çš„çº¿ç¨‹åˆ©ç”¨ç›¸é…çš„promiseè®¾å®šå…³è”çš„å€¼,ä½¿futureå‡†å¤‡å°±ç»ª</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;future&gt;</span></span>
<span class="token keyword keyword-void">void</span> <span class="token function">process_connections</span><span class="token punctuation">(</span>connection_set<span class="token operator">&amp;</span> connections<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">done</span><span class="token punctuation">(</span>connections<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span>connection_set<span class="token double-colon punctuation">::</span>iterator connection<span class="token operator">=</span>connections<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>connection<span class="token operator">!=</span>connections<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>connection<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>connection<span class="token operator">-&gt;</span><span class="token function">has_incoming_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                data_packet data<span class="token operator">=</span>connection<span class="token operator">-&gt;</span><span class="token function">incoming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>payload_type<span class="token operator">&gt;</span><span class="token operator">&amp;</span> p <span class="token operator">=</span> it<span class="token operator">-&gt;</span><span class="token function">get_promise</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>connection<span class="token operator">-&gt;</span><span class="token function">has_outgoing_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                outgoing_data data<span class="token operator">=</span>connection<span class="token operator">-&gt;</span><span class="token function">outgoing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> p <span class="token operator">=</span> it<span class="token operator">-&gt;</span><span class="token function">get_promise</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                data<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="å°†å¼‚å¸¸ä¿å­˜åˆ°futureä¸­">å°†å¼‚å¸¸ä¿å­˜åˆ°futureä¸­ </h4>
<p>async()æŠ›å‡ºçš„å¼‚å¸¸åªè¦è°ƒç”¨get(),è¯¥å¼‚å¸¸å°±ä¼šå†æ¬¡è¢«æŠ›å‡º</p>
<p>std::promiseä¹Ÿå…·æœ‰åŒæ ·çš„åŠŸèƒ½,å®ƒé€šè¿‡æˆå‘˜å‡½æ•°çš„æ˜¾ç¤ºè°ƒç”¨å®ç°,å‡å¦‚æƒ³ä¿å­˜å¼‚å¸¸<br>
ä½¿ç”¨set_exception()</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-extern">extern</span> std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span><span class="token keyword keyword-double">double</span><span class="token operator">&gt;</span>some_promise<span class="token punctuation">;</span>
<span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
    some_promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token function">calculate_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    some_promise<span class="token punctuation">.</span><span class="token function">set_exception</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//æ­¤å¤–è¿˜èƒ½ç”¨std::make_exception_ptr()ä¿å­˜æ–°å¼‚å¸¸è€Œä¸å‡ºå‘æŠ›å‡º</span>
some_promise<span class="token punctuation">.</span><span class="token function">set_exception</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_exception_ptr</span><span class="token punctuation">(</span><span class="token function">my_exception</span><span class="token punctuation">(</span><span class="token string">"error message"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="å¤šä¸ªçº¿ç¨‹ä¸€èµ·ç­‰å¾…">å¤šä¸ªçº¿ç¨‹ä¸€èµ·ç­‰å¾… </h4>
<p>å½“std::shared_futureçš„å®ä¾‹ä¾æ®std::futureçš„å®ä¾‹æ„é€ è€Œå¾—,å‰è€…æ‰€æŒ‡å‘çš„å¼‚æ­¥çŠ¶æ€ç”±åè€…å†³å®š.å› ä¸ºstd::futureå¯¹è±¡ç‹¬å å¼‚æ­¥çŠ¶æ€ï¼Œå…¶å½’å±æƒä¸ä¸ºå…¶ä»–ä»»ä½•å¯¹è±¡æ‰€å…±æœ‰,æ‰€ä»¥è‹¥è¦æŒ‰é»˜è®¤æ–¹å¼æ„é€ std::shared_futureå¯¹è±¡ï¼Œåˆ™å¿…é¡»ç”¨std::moveå‘å…¶é»˜è®¤æ„é€ å‡½æ•°ä¼ é€’å½’å±æƒ,è¿™ä½¿std::futureå˜ä¸ºç©ºçŠ¶æ€</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span>p<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>shared_future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token function">sf</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//éšå¼å½’å±æƒè½¬ç§»</span>
</code></pre><p>std::futureè¿˜å…·æœ‰å¯ä»¥æ ¹æ®åˆå§‹åŒ–åˆ—è¡¨è‡ªåŠ¨æ¨æ–­å˜é‡çš„ç±»å‹ä»è€Œä½¿std::shared_futureçš„å®ä¾‹åŒ–æ›´åŠ æ–¹ä¾¿çš„ç‰¹ç‚¹</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>someIndexType<span class="token punctuation">,</span>SomeDataType<span class="token punctuation">,</span>SomeComparator<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>iterator<span class="token operator">&gt;</span> p<span class="token punctuation">;</span>
<span class="token keyword keyword-auto">auto</span> sf<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> p<span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> f <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_future<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> sf <span class="token operator">=</span> f<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> sf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
</code></pre><h3 id="é™æ—¶ç­‰å¾…">é™æ—¶ç­‰å¾… </h3>
<p>æœ‰ä¸¤ç§è¶…æ—¶æœºåˆ¶å¯ä»¥ä½¿ç”¨</p>
<ol>
<li>å»¶è¿Ÿè¶…æ—¶:çº¿ç¨‹æ ¹æ®æŒ‡å®šçš„æ—¶é•¿è€Œç»§ç»­ç­‰å¾…</li>
<li>ç»å¯¹è¶…æ—¶:åœ¨æŸç‰¹å®šæ—¶é—´ç‚¹æ¥ä¸´ä¹‹å‰,çº¿ç¨‹ä¸€ç›´ç­‰å¾…ã€‚</li>
</ol>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> f<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>some_task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>std<span class="token double-colon punctuation">::</span>future_status<span class="token double-colon punctuation">::</span>ready<span class="token punctuation">)</span>
<span class="token function">do_something_with_result</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å°±å˜é‡è¿›è¡Œé™æ—¶ç­‰å¾…</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span>
<span class="token keyword keyword-bool">bool</span> done<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
<span class="token keyword keyword-bool">bool</span> <span class="token function">wait_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-auto">auto</span> <span class="token keyword keyword-const">const</span> timeout <span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>steady_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span><span class="token function">lk</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>cv<span class="token punctuation">.</span><span class="token function">wait_until</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token operator">==</span>std<span class="token double-colon punctuation">::</span>cv_status<span class="token double-colon punctuation">::</span>timeout<span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> done<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¶…æ—¶æ—¶é™çš„æœ€ç®€å•ç”¨é€”æ˜¯æ¨è¿Ÿç‰¹å®šçº¿ç¨‹çš„å¤„ç†è¿‡ç¨‹,è‹¥å®ƒä¸è¿è¡Œ,å°±ä¸ä¼šå ç”¨å…¶ä»–çº¿ç¨‹çš„å¤„ç†æ—¶é—´,ä»è€Œé¿å…èµ„æºç«äº‰</p>
<p>åœ¨ç»™äº’æ–¥åŠ é”æ—¶,ä¹Ÿèƒ½è®¾å®šè¶…æ—¶æ—¶é™</p>
<p>ä½¿ç”¨<mark>std::timed_mutex</mark>å’Œ<mark>std::recursive_timed_mutex</mark>å¯ä»¥è®¾å®šè¶…æ—¶æ—¶é™,è¿™ä¸¤ç§é”éƒ½å«æœ‰æˆå‘˜å‡½æ•°try_lock_for()å’Œtry_lock_until()</p>
<p><img src="timeout_in_cpp.png" alt="alt text"></p>



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C++ Standard Library Functions</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>


<h1>C++ Standard Library Functions with Timeout</h1>
<table>
    <thead>
        <tr>
            <th>ç±»/å‘½åç©ºé—´</th>
            <th>C++æ ‡å‡†åº“ä¸­æ¥æ”¶è¶…æ—¶çš„å‡½æ•°</th>
            <th>è¿”å›å€¼</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>std::this_thread</td>
            <td>sleep_for(duration)<br>sleep_until(time_point)</td>
            <td>æ— </td>
        </tr>
        <tr>
            <td>std::condition_variableæˆ–std::condition_variable_any</td>
            <td>wait_for(lock, duration)<br>wait_until(lock, time_point, predicate)</td>
            <td>Bool - è¢«å”¤é†’æ—¶çš„è¿”å›å€¼</td>
        </tr>
        <tr>
            <td>std::timed_mutex<br>std::recursive_timed_mutex<br>std::shared_timed_mutex</td>
            <td>try_lock_for(duration)<br>try_lock_until(time_point)</td>
            <td>Bool - è‹¥è·å¾—é”ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</td>
        </tr>
        <tr>
            <td>std::unique_lock<timed lockable=""></timed></td>
            <td>try_lock_for(duration)<br>try_lock_until(time_point)</td>
            <td>æ—  - å¦‚æœåœ¨æ–°æ„å»ºçš„å¯¹è±¡ä¸Šè·å¾—é”ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</td>
        </tr>
        <tr>
            <td>std::shared_lock<shared timedlockable=""></shared></td>
            <td>try_lock_for(duration)<br>try_lock_until(time_point)</td>
            <td>Bool - è‹¥è·å¾—é”ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</td>
        </tr>
        <tr>
            <td>std::future<valuetype>æˆ–std::shared_future<valuetype></valuetype></valuetype></td>
            <td>wait_for(duration)<br>wait_until(time_point)</td>
            <td>å¦‚æœç­‰å¾…è¶…æ—¶è¿”å›std::future_status::timeout<br>å¦‚æœå‡†å¤‡åˆ™è¿”å›std::future_status::ready<br>å¦‚æœè¢«å»¶è¿Ÿåˆ™è¿”å›std::future_status::deferred</td>
        </tr>
    </tbody>
</table>


<p>å¿«é€Ÿæ’åºçš„ä¸²è¡Œå®ç°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">sequential_quick_sort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> input<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> result<span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    T <span class="token keyword keyword-const">const</span> <span class="token operator">&amp;</span> pivot<span class="token operator">=</span><span class="token operator">*</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> divide<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">partition</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>input<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> x<span class="token operator">&lt;</span>pivot<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> lower_part<span class="token punctuation">,</span>higher_part<span class="token punctuation">;</span>
    lower_part<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>lower_part<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>input<span class="token punctuation">,</span>input<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>divide<span class="token punctuation">)</span><span class="token punctuation">;</span>
    higher_part<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>higher_part<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>input<span class="token punctuation">,</span>lower_part<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> <span class="token function">new_lower</span><span class="token punctuation">(</span><span class="token function">sequential_quick_sort</span><span class="token punctuation">(</span>lower_part<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> <span class="token function">new_higher</span><span class="token punctuation">(</span><span class="token function">sequential_quick_sort</span><span class="token punctuation">(</span>higher_part<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_higher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_lower<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//è¿ç”¨futureå®ç°å¹¶è¡Œå¿«é€Ÿæ’åº</span>
<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">parallel_quick_sort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> input<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> input<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> result<span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>input<span class="token punctuation">,</span>input<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> pivot<span class="token operator">=</span><span class="token operator">*</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> divide<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">partition</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>input<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> x<span class="token operator">&lt;</span>pivot<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> divide_point <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">partition</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>input<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> x<span class="token operator">&lt;</span>pivot<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> lower_part<span class="token punctuation">;</span>
    lower_part<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>lower_part<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>input<span class="token punctuation">,</span>input<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>divide_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span>new_lower<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>parallel_quick_sort<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>lower_part<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> new_higher<span class="token operator">=</span><span class="token function">parallel_quick_sort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_higher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_lower<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æœ€å¤§çš„å˜åŒ–å°±æ˜¯å‰åŠéƒ¨åˆ†çš„æ’åºä¸å†ç”±å½“å‰çº¿ç¨‹æ‰§è¡Œ,è€Œæ˜¯é€šè¿‡std::async()åœ¨å¦ä¸€çº¿ç¨‹ä¸Šæ“ä½œ</p>
<p>å¦‚æœå±‚æ•°è¿‡é«˜,å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹è¿‡å¤š<br>
é™¤äº†ä½¿ç”¨std::async()ä¹‹å¤–</p>
<p>spawn_task()çš„ç®€å•å®ç°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">F</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">A</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>result_of_t<span class="token operator">&lt;</span><span class="token function">F</span><span class="token punctuation">(</span>A<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type <span class="token function">spawn_task</span><span class="token punctuation">(</span>F<span class="token operator">&amp;&amp;</span> f<span class="token punctuation">,</span>A<span class="token operator">&amp;&amp;</span> a<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-using">using</span> result_type<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>result_of_t<span class="token operator">&lt;</span><span class="token function">F</span><span class="token punctuation">(</span>A<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token function">result_type</span><span class="token punctuation">(</span>A<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>result_type<span class="token operator">&gt;</span>
    <span class="token function">res</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸std::async()ç­‰ä»·çš„å‡½æ•°,å…¶ä¸­è¿ç”¨äº†å¹¶å‘æŠ€æœ¯è§„çº¦ä¸­çš„std::experimental<br>
::futureè¿˜å…·æœ‰å¯ä»¥æ ¹æ®åˆå§‹åŒ–åˆ—è¡¨è‡ªåŠ¨æ¨æ–­å˜é‡çš„ç±»å‹ä»è€Œä½¿std</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Func</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-decltype">decltype</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>Func<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token function">spawn_task</span><span class="token punctuation">(</span>Func<span class="token operator">&amp;&amp;</span> f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span><span class="token keyword keyword-decltype">decltype</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>Func<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>p<span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> res  <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>p<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span>f<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">decay_t</span><span class="token generic class-name"><span class="token operator">&lt;</span>Func<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-mutable">mutable</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
                p<span class="token punctuation">.</span><span class="token function">set_value_at_thread_exit</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                p<span class="token punctuation">.</span><span class="token function">set_exception_at_thread_exit</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="åç»­å‡½æ•°çš„è¿é”è°ƒç”¨">åç»­å‡½æ•°çš„è¿é”è°ƒç”¨ </h4>
<p>å‡å®šæœ‰ä¸€ç³»åˆ—è€—æ—¶çš„ä»»åŠ¡éœ€è¦æ‰§è¡Œ,è€Œä¸”ï¼Œä¸ºäº†è®©ä¸»çº¿ç¨‹æŠ½èº«æ‰§è¡Œå…¶ä»–ä»»åŠ¡,æˆ‘ä»¬æƒ³æŒ‰å¼‚æ­¥æ–¹å¼æ‰§è¡Œè¿™äº›ä»»åŠ¡</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span>  <span class="token function">process_login</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span> <span class="token operator">&amp;</span> username<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> password<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
        user_id <span class="token keyword keyword-const">const</span> id <span class="token operator">=</span> backend<span class="token punctuation">.</span><span class="token function">authenticate_user</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user_data <span class="token keyword keyword-const">const</span> info_to_display <span class="token operator">=</span> backend<span class="token punctuation">.</span><span class="token function">request_current_info</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">update_display</span><span class="token punctuation">(</span>info_to_display<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">display_error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½¿ç”¨åç»­å‡½æ•°å¤„ç†ç”¨æˆ·ç™»å½•</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;</span> <span class="token function">process_login</span><span class="token punctuation">(</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> username<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> password
<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">spawn_task</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> backend<span class="token punctuation">.</span><span class="token function">authenticate_user</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>user_id<span class="token operator">&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> backend<span class="token punctuation">.</span><span class="token function">request_current_info</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>user_data<span class="token operator">&gt;</span>info_to_display<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
            <span class="token function">update_display</span><span class="token punctuation">(</span>info_to_display<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">display_error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;future&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;utility&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>

<span class="token comment">// å®šä¹‰ä¸€ä¸ªæ”¯æŒ then çš„ future ç±»æ¨¡æ¿</span>
<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">MyFuture</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">MyFuture</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;&amp;</span> future<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">future_</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Func</span><span class="token operator">&gt;</span>
    <span class="token keyword keyword-auto">auto</span> <span class="token function">then</span><span class="token punctuation">(</span>Func<span class="token operator">&amp;&amp;</span> func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-using">using</span> ResultType <span class="token operator">=</span> <span class="token keyword keyword-decltype">decltype</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span>future_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span> promise<span class="token punctuation">;</span>
        <span class="token keyword keyword-auto">auto</span> resultFuture <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">,</span> f <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">,</span> future <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>future_<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-mutable">mutable</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span><span class="token function">set_value_at_thread_exit</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span><span class="token function">set_exception_at_thread_exit</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token generic-function"><span class="token function">MyFuture</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>resultFuture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;&amp;</span> <span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>future_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword keyword-private">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> future_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// è¾…åŠ©å‡½æ•°ï¼Œç”¨äºåˆ›å»º MyFuture å¯¹è±¡</span>
<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Func</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-auto">auto</span> <span class="token function">make_my_future</span><span class="token punctuation">(</span>Func<span class="token operator">&amp;&amp;</span> func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-using">using</span> ResultType <span class="token operator">=</span> <span class="token keyword keyword-decltype">decltype</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span> promise<span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> future <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">,</span> f <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Func<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-mutable">mutable</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span><span class="token function">set_value_at_thread_exit</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span><span class="token function">set_exception_at_thread_exit</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token generic-function"><span class="token function">MyFuture</span><span class="token generic class-name"><span class="token operator">&lt;</span>ResultType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-auto">auto</span> future <span class="token operator">=</span> <span class="token function">make_my_future</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"First task running..."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">42</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-auto">auto</span> nextFuture <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Second task running with result: "</span> <span class="token operator">&lt;&lt;</span> result <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> result <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Main thread continues..."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// è·å–æœ€ç»ˆç»“æœ</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-int">int</span> finalResult <span class="token operator">=</span> nextFuture<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Third task running with result: "</span> <span class="token operator">&lt;&lt;</span> result <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> result <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Final result: "</span> <span class="token operator">&lt;&lt;</span> finalResult <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> std<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Exception: "</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½¿ç”¨std::async()ä»å¤šä¸ªfutureæ”¶é›†ç»“æœ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>FinalResult<span class="token operator">&gt;</span> <span class="token function">process_data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>MyData<span class="token operator">&gt;</span><span class="token operator">&amp;</span> vec<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t <span class="token keyword keyword-const">const</span> chunk_size <span class="token operator">=</span>whatever<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>chunkResult<span class="token operator">&gt;&gt;</span>results<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> begin<span class="token operator">=</span>vec<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>end<span class="token operator">=</span>vec<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>begin<span class="token operator">!=</span>end<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        size_t <span class="token keyword keyword-const">const</span> remaining_size<span class="token operator">=</span>end<span class="token operator">-</span>begin<span class="token punctuation">;</span>
        size_t <span class="token keyword keyword-const">const</span> this_chunk_size<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>remaining_size<span class="token punctuation">,</span>chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>process_chunk<span class="token punctuation">,</span>begin<span class="token punctuation">,</span>begin<span class="token operator">+</span>this_chunk_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            begin<span class="token operator">+=</span>this_chunk_size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">[</span>all_results<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>chunkResult<span class="token operator">&gt;</span> all_chunks<span class="token punctuation">;</span>
        v<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span><span class="token operator">&amp;</span> f<span class="token operator">:</span>all_results<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
all_chunks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> <span class="token function">gather_results</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä¸Šé¢çš„ä»£ç ä¼šåœ¨get()å¤„åå¤è¢«å”¤é†’,ä¸è¿‡,è‹¥å®ƒå‘ç°æœ‰ä»»åŠ¡å°šæœªå¾—å‡ºç»“æœ,æ—‹å³å†æ¬¡ä¼‘çœ <br>
ä¸Šè¿°"ç­‰å¾…-åˆ‡æ¢"çš„è¡Œä¸ºå±å®æ— ç”¨</p>
<p>é‡‡ç”¨std::experimental::when_all()å‡½æ•°ä»å¤šä¸ªfutureæ”¶é›†ç»“æœ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>FinalResult<span class="token operator">&gt;</span> <span class="token function">process_data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>MyData<span class="token operator">&gt;</span><span class="token operator">&amp;</span> vec<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t <span class="token keyword keyword-const">const</span> chunk_size <span class="token operator">=</span>whatever<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>ChunkResult<span class="token operator">&gt;&gt;</span>results<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> begin<span class="token operator">=</span>vec<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>end<span class="token operator">=</span>vec<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>begin<span class="token operator">!=</span>end<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        size_t <span class="token keyword keyword-const">const</span> remaining_size<span class="token operator">=</span>end<span class="token operator">-</span>begin<span class="token punctuation">;</span>
        size_t <span class="token keyword keyword-const">const</span> this_chunk_size<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>remaining_size<span class="token punctuation">,</span>chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>
            <span class="token function">spawn_async</span><span class="token punctuation">(</span>process_chunk<span class="token punctuation">,</span>begin<span class="token punctuation">,</span>begin<span class="token operator">+</span>this_chunk_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            begin<span class="token operator">+=</span>this_chunk_size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span><span class="token function">when_all</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>results<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>ChunkResult<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>ready_results<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>ChunkResult<span class="token operator">&gt;&gt;</span>results<span class="token operator">=</span>ready_results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>ChunkResult<span class="token operator">&gt;</span>v<span class="token punctuation">;</span>
        v<span class="token punctuation">.</span><span class="token function">rerserve</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span><span class="token operator">&amp;</span> f<span class="token operator">:</span>results<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> <span class="token function">gather_results</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><mark>
å®éªŒæ ‡å¤´ä¸æ˜¯æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚å®ç°å¯ä»¥æä¾›å®ƒä»¬ï¼Œä½†ä¸éœ€è¦è¿™æ ·åšã€‚
å®ƒä»¬æ˜¯ä¸ºC++å§”å‘˜ä¼šæ­£åœ¨è‡´åŠ›äºå°†å…¶çº³å…¥æœªæ¥æ ‡å‡†çš„ç‰¹æ€§å®šä¹‰çš„ã€‚
VisualStudio2019å’Œ2022éƒ½ä¸æä¾›<experimental future=""></experimental></mark>
<p>std::experimental::when_any()å‡½æ•°ä¸ºå½“ç”Ÿæˆå¤šä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œ,ä½†åªè¦å…¶ä¸­ä¸€ä¸ªå®Œæˆè¿è¡Œ,æˆ‘ä»¬å°±éœ€è¦é©¬ä¸Šå¦å¤–å¤„ç†è¯¥é¡¹æœ€å…ˆå¾—å‡ºçš„ç»“æœ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>FinalResult<span class="token operator">&gt;</span><span class="token function">find_and_process_value</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>MyData<span class="token operator">&gt;</span><span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> concurrency<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> num_tasks<span class="token operator">=</span><span class="token punctuation">(</span>concurrency<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span>concurrency<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>MyData<span class="token operator">*</span><span class="token operator">&gt;&gt;</span>results<span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> <span class="token keyword keyword-const">const</span> chunk_size<span class="token operator">=</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>num_tasks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>num_tasks<span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> chunk_begin<span class="token operator">=</span>data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;&gt;</span>done_flag<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_tasks<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-auto">auto</span> chunk_end <span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span>num_tasks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span>chunk_begin<span class="token operator">+</span>chunk_size<span class="token operator">:</span>data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">spawn_async</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> it<span class="token operator">=</span>chunk_begin<span class="token punctuation">;</span><span class="token operator">!</span><span class="token operator">*</span>done_flag<span class="token operator">&amp;&amp;</span>it<span class="token operator">!=</span>chunk_end<span class="token punctuation">;</span>it<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">matches_find_criteria</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                  <span class="token operator">*</span>done_flag<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
                  <span class="token keyword keyword-return">return</span> <span class="token operator">&amp;</span><span class="token operator">*</span>entry<span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>MyData<span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chunk_begin<span class="token operator">=</span>chunk_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>FinalResult<span class="token operator">&gt;&gt;</span>
    final_result <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>FinalResult<span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">DoneCheck</span><span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>FinalResult<span class="token operator">&gt;&gt;</span>final_result<span class="token punctuation">;</span>
        <span class="token function">DoneCheck</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>FinalResult<span class="token operator">&gt;&gt;</span>final_result<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">final_result</span><span class="token punctuation">(</span>final_result<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>when_any_result<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>MyData<span class="token operator">*</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;&gt;</span> results_param<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-auto">auto</span> results <span class="token operator">=</span> results_param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                MyData<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> ready_result<span class="token operator">=</span>results<span class="token punctuation">.</span>futures<span class="token punctuation">[</span>results<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>ready_result<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    final_result<span class="token operator">-&gt;</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token function">process_result</span><span class="token punctuation">(</span><span class="token operator">*</span>ready_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-else">else</span>
                <span class="token punctuation">{</span>
                    final_result<span class="token operator">-&gt;</span><span class="token function">set_exception</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_exception_ptr</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"No matching value found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span><span class="token function">when_any</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>results<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">DoneCheck</span><span class="token punctuation">(</span>final_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> final_result<span class="token operator">-&gt;</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="çº¿ç¨‹é—©å’Œçº¿ç¨‹å¡">çº¿ç¨‹é—©å’Œçº¿ç¨‹å¡ </h4>
<p>çº¿ç¨‹é—©latch,æ˜¯ä¸€ä¸ªåŒæ­¥å¯¹è±¡,å†…å«è®¡æ•°å™¨,ä¸€æ—¦å‡åˆ°0,å°±ä¼šè¿›å…¥å°±ç»ªçŠ¶æ€</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> thread_count<span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    latch <span class="token function">done</span><span class="token punctuation">(</span>thread_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_data data<span class="token punctuation">[</span>thread_count<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread_count<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>launch<span class="token double-colon punctuation">::</span>async<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">{</span>
            data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">process_data</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            done<span class="token punctuation">.</span><span class="token function">count_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">do_more_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>åŸºæœ¬çš„çº¿ç¨‹å¡ç±»std::experimental::barrier<br>
å’Œstd::experimental::flex_barrier<br>
å‡å®šæœ‰ä¸€ç»„çº¿ç¨‹åœ¨ååŒå¤„ç†æŸäº›æ•°æ®,å„çº¿ç¨‹ç›¸äº’ç‹¬ç«‹,åˆ†åˆ«å¤„ç†æ•°æ®,å› æ­¤æ“ä½œè¿‡ç¨‹ä¸å¿…åŒæ­¥.ä½†æ˜¯åªæœ‰åœ¨å…¨éƒ¨çº¿ç¨‹å®Œæˆå„è‡ªçš„å¤„ç†å,æ‰å¯ä»¥æ“ä½œä¸‹ä¸€é¡¹æ•°æ®æˆ–å¼€å§‹åç»­å¤„ç†,std::experimental:: barrieré’ˆå¯¹çš„å°±æ˜¯è¿™ç§åœºæ™¯</p>
<p>åˆ›å»ºçº¿ç¨‹å¡,çº¿ç¨‹åœ¨å®Œæˆè‡ªèº«çš„å¤„ç†å,å°±è¿è¡Œåˆ°çº¿ç¨‹å¡å¤„,é€šè¿‡åœ¨çº¿ç¨‹å¡å¯¹è±¡ä¸Šè°ƒç”¨arrive_and_wait()ç­‰å¾…åŒæ­¥ç»„çš„å…¶ä»–çº¿ç¨‹,åªè¦ç»„å†…æœ€åä¸€ä¸ªçº¿ç¨‹ä¹Ÿè¿è¡Œè‡³æ­¤,æ‰€æœ‰çº¿ç¨‹å³è¢«é‡Šæ”¾ï¼Œçº¿ç¨‹å¡ä¼šè‡ªæˆ‘é‡ç½®</p>
<p>åªè¦çº¿ç¨‹å¡ä¸Šè°ƒç”¨arrive_and_drop(),å³å¯ä»¤çº¿ç¨‹æ˜¾ç¤ºè„±ç¦»å…¶åŒæ­¥ç»„,é‚£æ ·,å®ƒå°±å†ä¹Ÿæ— æ³•è¢«é˜»æ‹¦,å› è€Œä¹Ÿä¸èƒ½ç­‰å¾…çº¿ç¨‹å¡è¿›å…¥å°±ç»ªçŠ¶æ€,å¹¶ä¸”,åœ¨ä¸‹ä¸€ä¸ªåŒæ­¥å‘¨æœŸä¸­,å¿…é¡»è¿è¡Œåˆ°çº¿ç¨‹å¡å¤„çš„çº¿ç¨‹å°†è¢«å‡ä¸€</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>result_chunk <span class="token function">process</span><span class="token punctuation">(</span>data_chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>data_chunk<span class="token operator">&gt;</span> <span class="token function">divide_into_chunks</span><span class="token punctuation">(</span>data_block data<span class="token punctuation">,</span><span class="token keyword keyword-unsigned">unsigned</span> chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">process_data</span><span class="token punctuation">(</span>data_block data<span class="token punctuation">,</span>data_sink <span class="token operator">&amp;</span>sink<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> concurrency <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> num_tasks <span class="token operator">=</span> <span class="token punctuation">(</span>concurrency <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span> concurrency <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>barrier <span class="token function">sync</span><span class="token punctuation">(</span>num_tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>joining_thread<span class="token operator">&gt;</span> <span class="token function">threads</span><span class="token punctuation">(</span>num_tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>data_chunk<span class="token operator">&gt;</span> chunks<span class="token punctuation">;</span>
    result_block results<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_threads<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">joining_thread</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>i<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    data_block current_block<span class="token operator">=</span>source<span class="token punctuation">.</span><span class="token function">get_next_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    chunks<span class="token operator">=</span><span class="token function">divide_into_chunks</span><span class="token punctuation">(</span>current_block<span class="token punctuation">,</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                sync<span class="token punctuation">.</span><span class="token function">arrive_and_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">set_chunk</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>num_threads<span class="token punctuation">,</span><span class="token function">process</span><span class="token punctuation">(</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sync<span class="token punctuation">.</span><span class="token function">arrive_and_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    sink<span class="token punctuation">.</span><span class="token function">write_data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="stdexperimentalflex_barrier">std::experimental::flex_barrier </h4>
<p>flex_barrierç›¸æ¯”äºbarrier,è¿˜æ¥å—è¡¥å…¨å‡½æ•°<br>
åªè¦å…¨éƒ¨çº¿ç¨‹éƒ½è¿è¡Œåˆ°çº¿ç¨‹å¡å¤„,è¯¥å‡½æ•°å°±ä¼šåœ¨å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œ,å®ƒä¸ä½†æä¾›äº†æœºåˆ¶,å¯ä»¥è®¾å®šåç»­ä»£ç ,ä»¤å…¶å¿…é¡»æŒ‰ä¸²è¡Œæ–¹å¼è¿è¡Œ<br>
è¿˜ç»™å‡ºäº†æ–¹æ³•,ç”¨äºæ”¹å˜ä¸‹ä¸€åŒæ­¥å‘¨æœŸå¿…é¡»åˆ°è¾¾è¯¥å¤„çš„çº¿ç¨‹æ•°ç›®,</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">process_data</span><span class="token punctuation">(</span>data_block data<span class="token punctuation">,</span>data_sink <span class="token operator">&amp;</span> sink<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> concurrency <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> num_threads <span class="token operator">=</span> <span class="token punctuation">(</span>concurrency<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span>concurrency<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>data_chunk<span class="token operator">&gt;</span>chunks<span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> split_source<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            data_block current_block<span class="token operator">=</span>source<span class="token punctuation">.</span><span class="token function">get_next_data_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            chunks<span class="token operator">=</span><span class="token function">divide_into_chunks</span><span class="token punctuation">(</span>current_block<span class="token punctuation">,</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">split_source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result_block results<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>experimental<span class="token double-colon punctuation">::</span>flex_barrier <span class="token function">sync</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
        sink<span class="token punctuation">.</span><span class="token function">write_data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">split_source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>joining_thread<span class="token operator">&gt;</span><span class="token function">threads</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_threads<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">joining_thread</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span><span class="token function">set_chunk</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>num_threads<span class="token punctuation">,</span><span class="token function">process</span><span class="token punctuation">(</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sync<span class="token punctuation">.</span><span class="token function">arrive_and_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>std::experimental::flex_barrier å…è®¸ç”¨æˆ·ä»¥ä¸€ä¸ªå‡½æ•°å¯¹è±¡æ§åˆ¶å®Œæˆé˜¶æ®µã€‚è‹¥å‡½æ•°å¯¹è±¡è¿”å› -1ï¼Œåˆ™ä¸æ›´æ”¹å‚ä¸çº¿ç¨‹é›†åˆï¼ˆè€Œä¸‹ä¸ªå¾ªç¯ä¸­åŒä¸€å‚ä¸çº¿ç¨‹é›†åˆå¿…é¡»æŠµè¾¾åŒæ­¥ç‚¹ï¼‰ï¼›å¦åˆ™å‚ä¸çº¿ç¨‹é›†åˆå˜ä¸ºæ‹¥æœ‰ç­‰äºè¿”å›å€¼ N çš„æ–°å¤§å°çš„é›†åˆï¼Œå¹¶ç”±åˆ°è¾¾å±éšœåŒæ­¥ç‚¹çš„ä¸‹ N ä¸ªçº¿ç¨‹ç»„æˆã€‚</p>
<h2 id="cå†…å­˜æ¨¡å‹å’ŒåŸå­æ“ä½œ">c++å†…å­˜æ¨¡å‹å’ŒåŸå­æ“ä½œ </h2>
<p>åŸå­æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„æ“ä½œ,åœ¨ç³»ç»Ÿçš„ä»»ä¸€çº¿ç¨‹å†…,æˆ‘ä»¬éƒ½ä¸ä¼šè§‚å¯Ÿåˆ°è¿™ç§æ“ä½œå±äºåŠå®ŒæˆçŠ¶æ€</p>
<p>å¯¹äºåŸå­ç±»å‹çš„ä¸Šçš„æ¯ä¸€ç§æ“ä½œï¼Œå¯ä»¥æä¾›é¢å¤–çš„å‚æ•°,ä»æšä¸¾ç±»std::memory_orderä¸­å–å€¼</p>
<p>æ“ä½œçš„ç±»åˆ«å†³å®šäº†å†…å­˜æ¬¡åºæ‰€å‡†è®¸çš„å–å€¼,è‹¥æ²¡æœ‰æ˜¾ç¤ºè°ƒç”¨å†…å­˜æ˜¾ç¤ºé¡ºåº,åˆ™é»˜è®¤ä½¿ç”¨æœ€ä¸¥<br>
æ ¼çš„å†…å­˜é¡ºåº,å³std::memory_order_seq_cst</p>
<p>æ“ä½œåˆ’åˆ†ä¸ºä¸‰ç±»:</p>
<ol>
<li>å­˜å‚¨æ“ä½œ:å¯é€‰ç”¨çš„å†…å­˜æ¬¡åºæœ‰std::memory_order_relaxed,std::memory_order_releaseæˆ–std::memory_order_seq_cst</li>
<li>è½½å…¥æ“ä½œ:std::memory_order_relaxed,std::memory_order_consumeï¼Œstd::memory_order_acquireæˆ–std::memory_order_seq_cst</li>
<li>åº¦æ”¹å†™æ“ä½œ:std::memory_order_relaxed,std::memory_order_consume,std::memory_order_acquireï¼Œstd::memory_order_releaseæˆ–std::memory_order_seq_cst</li>
</ol>
<h4 id="stdatomic_flag">std::atomic_flag </h4>
<p>æ˜¯æœ€ç®€å•çš„æ ‡å‡†åŸå­ç±»å‹,è¡¨ç¤ºä¸€ä¸ªå¸ƒå°”æ ‡å¿—,è¯¥ç±»å‹çš„å¯¹è±¡åªæœ‰ä¸¤ç§çŠ¶æ€æˆç«‹æˆ–ç½®é›¶</p>
<p>std::atomic_flagç±»å‹çš„å¯¹è±¡å¿…é¡»ç”±å®ATOMIC_FLAG_INITåˆå§‹åŒ–</p>
<p>åˆå§‹åŒ–ååªèƒ½æ‰§è¡Œä¸‰ç§æ“ä½œ:</p>
<ol>
<li>test_and_set()</li>
<li>clear()</li>
<li>ææ„é”€æ¯</li>
</ol>
<p>clearæ˜¯å­˜å‚¨æ“ä½œ,test_and_setæ˜¯è¯»æ”¹å†™æ“ä½œ</p>
<p>ä¸Šé¢çš„ä»£ç ä¸­,clear()çš„è°ƒç”¨æ˜¾ç¤ºåœ°é‡‡ç”¨é‡Šæ”¾è¯­ä¹‰å°†æ ‡å¿—æ¸…é›¶</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>f<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-bool">bool</span> x<span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">test_and_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ç”±äºåŸå­ç±»å‹çš„æ“ä½œéƒ½æ˜¯åŸå­åŒ–çš„,ä½†æ‹·è´èµ‹å€¼å’Œæ‹·è´æ„é€ éƒ½æ¶‰åŠä¸¤ä¸ªå¯¹è±¡<br>
,è€Œç‰µæ¶‰ä¸¤ä¸ªä¸åŒå¯¹è±¡çš„å•ä¸€æ“ä½œå´æ— æ³•åŸå­åŒ–,åœ¨æ‹·è´æ„é€ æˆ–æ‹·è´èµ‹å€¼çš„è¿‡ç¨‹ä¸­,å¿…é¡»å…ˆä»æ¥æºå¯¹è±¡è¯»å–å€¼,å†å°†å…¶å†™å‡ºåˆ°ç›®æ ‡å¯¹è±¡,è¿™æ˜¯åœ¨ä¸¤ä¸ªç‹¬ç«‹å¯¹è±¡ä¸Šçš„ä¸¤ä¸ªç‹¬ç«‹æ“ä½œ,å…¶ç»„åˆä¸å¯èƒ½æ˜¯åŸå­åŒ–çš„<br>
æ‰€ä»¥åŸå­å¯¹è±¡ç¦æ­¢æ‹·è´èµ‹å€¼å’Œæ‹·è´æ„é€ </p>
<p>é‡‡ç”¨std::atomic_flagå®ç°è‡ªæ—‹é”äº’æ–¥</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">spinlock_mutex</span><span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic_flag flag<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">spinlock_mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">flag</span><span class="token punctuation">(</span>ATOMIC_FLAG_INIT<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">test_and_set</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        flag<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="stdatomicbool">std::atomic<bool> </bool></h4>
<p>è¯¥ç±»å‹çš„å®ä¾‹èƒ½æ¥å—éåŸå­å¸ƒå°”é‡çš„èµ‹å€¼</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> b<span class="token punctuation">;</span>
<span class="token keyword keyword-bool">bool</span> x<span class="token operator">=</span>b<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
x<span class="token operator">=</span>b<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_oreder_acq_rel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>æ¯”è¾ƒäº¤æ¢æ“ä½œç»™å®šä¸€ä¸ªæœŸæœ›å€¼,åŸå­å˜é‡å°†å®ƒå’Œè‡ªèº«æ¯”è¾ƒ,å¦‚æœç›¸ç­‰,å°±å­˜å…¥å¦ä¸€æ—¢å®šçš„å€¼,å¦åˆ™æ›´æ–°æœŸæœ›å€¼æ‰€å±å˜é‡,å‘å®ƒèµ‹äºˆåŸå­å˜é‡çš„å€¼<br>
åŸå­å€¼ä¸æœŸæœ›å€¼ç›¸ç­‰è¿”å›true,å¦åˆ™è¿”å›false<br>
å¯¹äºcompare_exchange_weak(),å³ä½¿åŸå­å˜é‡çš„å€¼ç­‰äºæœŸæœ›å€¼<br>
ä¿å­˜åŠ¨ä½œä»æœ‰å¯èƒ½å¤±è´¥,åœ¨è¿™ç§æƒ…å½¢ä¸‹,åŸå­å˜é‡ç»´æŒåŸå€¼ä¸å˜,compare_exchange_weak()è¿”å›false<br>
ç”±äºæ“ä½œä¸­é€”å› ç³»ç»Ÿè°ƒåº¦åˆ‡å‡ºå¯¼è‡´æ“ä½œå¤±è´¥æˆä¸ºä½¯è´¥<br>
compare_exchange_weak()å¯èƒ½å‘ç”Ÿä½¯è´¥,æ‰€ä»¥å¾€å¾€ä½¿ç”¨å¾ªç¯</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-bool">bool</span> expected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword keyword-extern">extern</span> atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> b<span class="token punctuation">;</span>
<span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">!</span>expected<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>åªè¦expectedå˜é‡è¿˜æ˜¯false,å°±è¯´æ˜compare_exchange_weak()çš„è°ƒç”¨å‘ç”Ÿä½¯è´¥ç»§ç»­å¾ªç¯</p>
<p>æ¯”è¾ƒäº¤æ¢å‡½æ•°å¯ä»¥æ¥å—ä¸¤ä¸ªå†…å­˜æ¬¡åºå‚æ•°,è¿™ä½¿ç¨‹åºèƒ½å¤ŸåŒºåˆ†æˆåŠŸå’Œå¤±è´¥<br>
ä¸¤ç§æƒ…å†µ,é‡‡ç”¨ä¸åŒçš„å†…å­˜æ¬¡åº<br>
åˆé€‚çš„åšæ³•æ˜¯:è‹¥æ“ä½œæˆåŠŸ,å°±é‡‡ç”¨std::memory_order_acq_relå†…å­˜æ¬¡åº<br>
å¦åˆ™æ”¹ç”¨std::memory_order_relaxedå†…å­˜æ¬¡åº<br>
å¤±è´¥æ“ä½œè®¾å®šçš„å†…å­˜æ¬¡åºä¸èƒ½æ¯”æˆåŠŸæ“ä½œçš„æ›´ä¸¥æ ¼,è‹¥å°†å¤±è´¥æ“ä½œçš„å†…å­˜æ¬¡åºæŒ‡å®šä¸ºstd::memory_order_acquireæˆ–std::memory_order_seq_cst</p>
<h4 id="stdatomict-ç®—æœ¯ç±»å‹çš„æŒ‡é’ˆè¿ç®—">std::atomic&lt;T*&gt; ç®—æœ¯ç±»å‹çš„æŒ‡é’ˆè¿ç®— </h4>
<p>fetch_add()ç­‰éƒ½æ˜¯è¯»æ”¹å†™æ“ä½œ,è¿›è¡Œè®¡ç®—è¿”å›æ—§å€¼</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">Foo</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Foo some_array<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>Foo<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token function">ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>some_array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ptr<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>å¯¹äºè¿™äº›æ“ä½œç¬¦çš„é‡è½½,æ€»æ˜¯æœä»std::memory_order_seq_cstå†…å­˜æ¬¡åº</p>
<h4 id="æ³›åŒ–stdatomicç±»æ¨¡æ¿">æ³›åŒ–std::atomic&lt;&gt;ç±»æ¨¡æ¿ </h4>
<p>å¯¹äºè‡ªå®šä¹‰ç±»å‹UDT,å…¶åŸå­åŒ–ç±»å‹å°±æ˜¯std::atomic<udt><br>
æ‰€æä¾›çš„æ¥å£ä¸std::atomic<t>ç›¸åŒ<br>
ä¸åŒä¹‹å¤„åœ¨äºå‡½æ•°ä¸­å‡¡æ˜¯æ¶‰åŠè¯¥ç±»åŸå­å¯¹è±¡æ‰€è¡¨ç¤ºçš„å€¼,å®ƒçš„å‚æ•°å’Œè¿”å›å€¼å°±è¦æ”¹æˆUDTç±»å‹</t></udt></p>
<p>å¯¹äºæŸä¸ªè‡ªå®šä¹‰ç±»å‹UDT,å…¶åŸå­åŒ–ç±»å‹éœ€è¦å…·å¤‡å¹³å®æ‹·è´èµ‹å€¼æ“ä½œç¬¦<br>
ä¸å«æœ‰ä»»ä½•è™šå‡½æ•°,ä¹Ÿä¸å¯ä»¥ä»è™šåŸºç±»æ´¾ç”Ÿå‡ºæ¥,è¿˜å¿…é¡»ç”±ç¼–è¯‘å™¨ä»£å…¶éšå¼ç”Ÿæˆæ‹·è´èµ‹å€¼æ“ä½œç¬¦<br>
å¦å¤–,è‹¥å®šä¹‰ç±»å‹å…·æœ‰åŸºç±»æˆ–éé™æ€æ•°æ®,åˆ™å…¶åŒæ ·éœ€è¦å…·å¤‡å¹³æ—¶æ‹·è´æ“ä½œç¬¦</p>
<p>ç¼–è¯‘å™¨å€Ÿç”¨memcpy()å‡½æ•°å®ç°å¹³å®æ‹·è´èµ‹å€¼æ“ä½œç¬¦<br>
æ¯”è¾ƒäº¤æ¢æ“ä½œç¬¦é‡‡ç”¨çš„æ˜¯é€ä½æ¯”è¾ƒ,æ•ˆæœç­‰åŒäºmemcmp()å‡½æ•°</p>
<p>å¦‚æœè‡ªå®šä¹‰ç±»å‹å«æœ‰å¡«å……ä½,å´ä¸å‚ä¸æ™®é€šæ¯”è¾ƒæ“ä½œ,é‚£ä¹ˆå³ä½¿UDTå¯¹è±¡çš„å€¼ç›¸ç­‰<br>
æ¯”è¾ƒ-äº¤æ¢æ“ä½œè¿˜æ˜¯ä¼šå¤±è´¥</p>
<h3 id="åŒæ­¥æ“ä½œå’Œå¼ºåˆ¶é¡ºåº">åŒæ­¥æ“ä½œå’Œå¼ºåˆ¶é¡ºåº </h3>
<h4 id="åŒæ­¥å…³ç³»">åŒæ­¥å…³ç³» </h4>
<p>åŸºæœ¬æ€æƒ³:å¯¹å˜é‡xæ‰§è¡ŒåŸå­å†™æ“ä½œWå’ŒåŸå­è¯»æ“ä½œRï¼Œä¸”ä¸¤è€…éƒ½æœ‰é€‚å½“çš„æ ‡è®°,åªè¦æ»¡è¶³ä¸‹é¢å…¶ä¸­ä¸€ç‚¹,å®ƒä»¬å½¼æ­¤åŒæ­¥</p>
<ol>
<li>Rè¯»å–äº†Wç›´æ¥å­˜å…¥çš„å€¼</li>
<li>Wæ‰€å±çº¿ç¨‹éšåè¿˜æ‰§è¡Œäº†å¦ä¸€åŸå­å†™æ“ä½œ,Rè¯»å–äº†åé¢å­˜å…¥çš„å€¼</li>
<li>ä»»æ„çº¿ç¨‹æ‰§è¡Œä¸€è¿ä¸²è¯»æ”¹å†™æ“ä½œ,å…¶ä¸­ç¬¬ä¸€ä¸ªæ“ä½œè¯»å–çš„å€¼éƒ½æ˜¯Wå†™çš„æ•°æ®</li>
</ol>
<h4 id="å…ˆè¡Œå…³ç³»">å…ˆè¡Œå…³ç³» </h4>
<p>å…ˆè¡Œå…³ç³»å’Œä¸¥æ ¼å…ˆè¡Œå…³ç³»æ˜¯æ¸…æ¥šç•Œå®šå“ªäº›æ“ä½œå‘¢èƒ½å¤Ÿé¡¾çœ‹è§å…¶ä»–å“ªäº›æ“ä½œäº§ç”Ÿçš„ç»“æœ</p>
<p>åŸå­æ“ä½œè™½ç„¶æœ‰6ç§å†…å­˜æ¬¡åºï¼Œä½†ä»…ä»£è¡¨ä¸‰ç§æ¨¡å¼:</p>
<ol>
<li>å…ˆåä¸€è‡´æ¬¡åº:memory_order_seq_cst</li>
<li>è·å–-é‡Šæ”¾æ¬¡åº:memory_order_acquire,memory_order_release,memory_order_acq_rel<br>
memory_order_consume</li>
<li>å®½æ¾æ¬¡åº:memory_order_relaxed</li>
</ol>
<h5 id="å…ˆåä¸€è‡´é¡ºåº">å…ˆåä¸€è‡´é¡ºåº </h5>
<p>å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹å†…,æŸé¡¹æ“ä½œä¼˜å…ˆäºå¦ä¸€é¡¹å‘ç”Ÿ,é‚£ä¹ˆå…¶ä»–çº¿ç¨‹æ‰€è§çš„å…ˆåæ¬¡åºéƒ½å¿…é¡»å¦‚æ­¤<br>
ä¸ºäº†ä¿æŒç»å¯¹å…ˆåä¸€è‡´,æ‰€æœ‰çº¿ç¨‹éƒ½å¿…é¡»é‡‡ç”¨ä¿åºåŸå­æ“ä½œ<br>
é¡ºåºä¸€è‡´æ€§å‡ä¿è¯æ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œè¯­å¥å…¨å±€ä¸€è‡´ï¼Œä¸ä¼šå­˜åœ¨é‡æ’ã€‚</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>

std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> z<span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">write_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">write_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">++</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_seq_cst<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">++</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    y <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>write_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t2</span><span class="token punctuation">(</span>write_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t3</span><span class="token punctuation">(</span>read_x_then_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t4</span><span class="token punctuation">(</span>read_y_then_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t4<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"z = "</span><span class="token operator">&lt;&lt;</span>z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å…³äºä¸Šè¿°ä»£ç åˆ©ç”¨ä¸Šè¿°è§£é‡Šå¯å‚è€ƒå¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆéšæœºé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹bæ‰§è¡Œï¼Œæ­¤æ—¶yä¸ºtrue</li>
<li>éšæœºé€‰æ‹©ä¸‹ä¸€ä¸ªçº¿ç¨‹aæ‰§è¡Œï¼Œæ­¤æ—¶xä¸ºtrue</li>
<li>éšæœºé€‰æ‹©cçº¿ç¨‹æ‰§è¡Œï¼Œzä¸º1</li>
<li>éšæœºé€‰æ‹©dæ‰§è¡Œï¼Œzä¸º2<br>
è¿™ä¸ªè¿‡ç¨‹æ˜¯å…¨å±€ä¸€è‡´çš„ï¼Œå› æ­¤æœ€åzä¸º2</li>
</ol>
<p>æˆ–è€…ä¸Šè¿°ä¹Ÿå¯èƒ½å­˜åœ¨å…¶ä»–çš„é¡ºåºï¼Œè­¬å¦‚ï¼š</p>
<ol>
<li>éšæœºé€‰æ‹©çº¿ç¨‹cæ‰§è¡Œï¼Œæ­¤æ—¶xä¸ºfalseï¼Œçº¿ç¨‹cä¸€ç›´å¾ªç¯</li>
<li>éšæœºé€‰æ‹©çº¿ç¨‹dæ‰§è¡Œï¼Œæ­¤æ—¶yä¸ºfasleï¼Œçº¿ç¨‹dä¸€ç›´å¾ªç¯</li>
<li>éšæœºé€‰æ‹©çº¿ç¨‹aæ‰§è¡Œï¼Œæ­¤æ—¶xä¸ºtrue</li>
<li>éšæœºé€‰æ‹©çº¿ç¨‹cæ‰§è¡Œï¼Œæ­¤æ—¶yä¸ºfalseï¼Œxä¸ºtrueï¼Œzä¸º0</li>
<li>éšæœºé€‰æ‹©çº¿ç¨‹bæ‰§è¡Œï¼Œæ­¤æ—¶yä¸ºtrueï¼Œxä¸ºtrue</li>
<li>éšæœºé€‰æ‹©çº¿ç¨‹dæ‰§è¡Œï¼Œæ­¤æ—¶zä¸º1</li>
</ol>
<h5 id="éå…ˆåä¸€è‡´é¡ºåº">éå…ˆåä¸€è‡´é¡ºåº </h5>
<p>åœ¨ä¸åŒçš„cpuç¼“å­˜å’Œå†…éƒ¨ç¼“å†²ä¸­,åŒä¸€ä»½å†…å­˜æ•°æ®å¯èƒ½å…·æœ‰ä¸åŒçš„å€¼</p>
<h5 id="å®½æ¾æ¬¡åº">å®½æ¾æ¬¡åº </h5>
<p>åŸå­ç±»å‹ä¸Šçš„æ“ä½œä¸å­˜åœ¨åŒæ­¥å…³ç³»<br>
å®½æ¾åŸå­æ“ä½œå‡ ä¹ä¸è¦æ±‚æœä»ä»»ä½•æ¬¡åº</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> z<span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    y<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    z<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>write_x_then_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t2</span><span class="token punctuation">(</span>read_x_then_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"z="</span> <span class="token operator">&lt;&lt;</span> z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æ­¤æ—¶æ–­è¨€å¯èƒ½å‘ç”ŸæŠ¥é”™</p>
<p>å¤šä¸ªçº¿ç¨‹ä¸Šçš„å®½æ¾åŸå­æ“ä½œ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> loop_count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">read_values</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

read_values values<span class="token punctuation">[</span>loop_count<span class="token punctuation">]</span><span class="token punctuation">;</span>
read_values values2<span class="token punctuation">[</span>loop_count<span class="token punctuation">]</span><span class="token punctuation">;</span>
read_values values3<span class="token punctuation">[</span>loop_count<span class="token punctuation">]</span><span class="token punctuation">;</span>
read_values values4<span class="token punctuation">[</span>loop_count<span class="token punctuation">]</span><span class="token punctuation">;</span>
read_values values5<span class="token punctuation">[</span>loop_count<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">increment</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> var_to_inc<span class="token punctuation">,</span>read_values<span class="token operator">*</span> values<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>go<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loop_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var_to_inc<span class="token operator">-&gt;</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_vals</span><span class="token punctuation">(</span>read_values<span class="token operator">*</span> values<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>go<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loop_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å…è®¸å…¶ä»–çº¿ç¨‹æ¨é€å·¥ä½œåˆ°é˜Ÿåˆ—</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">print</span><span class="token punctuation">(</span>read_values<span class="token operator">*</span> v<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loop_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"("</span> <span class="token operator">&lt;&lt;</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">&lt;&lt;</span> <span class="token string">","</span> <span class="token operator">&lt;&lt;</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">&lt;&lt;</span> <span class="token string">","</span> <span class="token operator">&lt;&lt;</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>increment<span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t2</span><span class="token punctuation">(</span>increment<span class="token punctuation">,</span> <span class="token operator">&amp;</span>y<span class="token punctuation">,</span> values2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t3</span><span class="token punctuation">(</span>increment<span class="token punctuation">,</span> <span class="token operator">&amp;</span>z<span class="token punctuation">,</span> values3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t4</span><span class="token punctuation">(</span>read_vals<span class="token punctuation">,</span> values4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t5</span><span class="token punctuation">(</span>read_vals<span class="token punctuation">,</span> values5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    go <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t4<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t5<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">print</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span>values2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span>values3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span>values4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span>values5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿ç”¨è·å–-é‡Šæ”¾æ¬¡åº,å®ƒé¿å…äº†ç»å¯¹å…ˆåä¸€è‡´æ¬¡åºçš„é¢å¤–å¼€é”€</p>
<h5 id="è·å–-é‡Šæ”¾é¡ºåº">è·å–-é‡Šæ”¾é¡ºåº </h5>
<p>å…¶æ¯”å®½æ¾é¡ºåºä¸¥æ ¼ä¸€ç‚¹å¯ä»¥äº§ç”Ÿä¸€å®šç¨‹åº¦çš„åŒæ­¥è€Œä¸ä¼šå½¢æˆæœä»å…ˆåä¸€è‡´æ¬¡åºçš„å…¨å±€æ€»æ“ä½œåºåˆ—</p>
<p>è¯¥æ¨¡å‹ä¸­:åŸå­åŒ–è½½å…¥ä¸ºè·å–æ“ä½œ<br>
åŸå­åŒ–å­˜å‚¨ä¸ºé‡Šæ”¾æ“ä½œï¼Œè€ŒåŸå­åŒ–è¯»æ”¹å†™åˆ™ä¸ºè·å–æˆ–é‡Šæ”¾æ“ä½œ</p>
<p>è¿™ç§å†…å­˜æ¬¡åºåœ¨æˆå¯¹çš„è¯»å†™çº¿ç¨‹ä¹‹é—´èµ·åˆ°åŒæ­¥ä½œç”¨<br>
é‡Šæ”¾ä¸è·å–æ“ä½œæ„æˆåŒæ­¥å…³ç³»ï¼Œå‰è€…å†™å‡ºçš„å€¼ç”±åè€…è¯»å–</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>

std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> z<span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">write_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">write_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">++</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">++</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢çš„ä»£ç ä¸­yçš„å†™ä¸è¯»ç›¸åŒæ­¥<br>
æ­¤æ—¶ç”±äºxçš„å†™å…¥å…ˆäºy<br>
æ‰€ä»¥yçš„è¯»æ“ä½œåå†è¿›è¡Œxçš„è¯»æ“ä½œä¸€å®šæˆåŠŸ<br>
æ‰€ä»¥æ­¤å¤„zçš„ç»“æœä¸º1</p>
<p>ä½†å¦‚æœä¸Šé¢yçš„è½½å…¥æ“ä½œæ²¡æ”¾åœ¨whileå¾ªç¯ä¸­,yçš„è½½å…¥å¯èƒ½ä¸ºfalseæ­¤æ—¶xåˆ™ä¸å†ç¡®å®š<br>
è·å–å’Œé‡Šæ”¾æ“ä½œæˆå¯¹æ—¶æ‰å¯ä»¥äº§ç”ŸåŒæ­¥</p>
<p>è¿ç”¨è·å–é‡Šæ”¾æ¬¡åºä¼ é€’åŒæ­¥</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> <span class="token function">sync1</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sync2</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">thread_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sync1<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token keyword keyword-void">void</span> <span class="token function">thread_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>sync1<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sync2<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

viid <span class="token function">thread_3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>sync2<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å°½ç®¡thread_2åªæ¥è§¦è¿‡sync1å’Œsync2,ä½†è¿™è¶³ä»¥åŒæ­¥çº¿ç¨‹thread_1å’Œthread_3,ä»è€Œä¿è¯æ¯ä¸ªæ–­è¨€éƒ½ä¸ä¼šè§¦å‘</p>
<p>ä¸Šä¾‹ä¸­,æˆ‘ä»¬è¿˜èƒ½è¿›ä¸€æ­¥å°†å˜é‡sync1å’Œsync2èåˆæˆå•ä¸€å˜é‡,åœ¨çº¿ç¨‹thread_2ä¸Šå¯¹å…¶æ‰§è¡Œ"è¯»-æ”¹-å†™"æ“ä½œ<br>
è¯¥æ“ä½œé‡‡ç”¨memory_order_acq_relæ¬¡åº</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">thread_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-void">void</span> <span class="token function">thread_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> expected <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token comment">//  åŸå­çš„æ¯”è¾ƒ *this  å’Œ expectçš„å€¼ï¼Œè‹¥å®ƒä»¬é€ä½ç›¸ç­‰ï¼Œåˆ™ä»¥ desired æ›¿æ¢å‰è€…ï¼ˆè¿›è¡Œè¯»ä¿®æ”¹å†™æ“ä½œï¼‰ã€‚å¦åˆ™ï¼Œå°† *this ä¸­çš„å®é™…å€¼åŠ è½½è¿› expected ï¼ˆè¿›è¡ŒåŠ è½½æ“ä½œï¼‰ã€‚</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>sync<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_acq_rel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expected <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">thread_3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><h5 id="è·å–-é‡Šæ”¾æ¬¡åºå’Œmemory_order_consume">è·å–-é‡Šæ”¾æ¬¡åºå’Œmemory_order_consume </h5>
<p>è¿™ç§å†…å­˜æ¬¡åºå¯ä»¥æŒ‰åŸå­åŒ–æ–¹å¼è½½å…¥æŸä»½æ•°æ®çš„æŒ‡é’ˆ,æˆ‘ä»¬æŠŠå­˜å‚¨æ“ä½œè®¾å®šæˆmemory_order_releaseæ¬¡åº<br>
è€Œå°†åé¢çš„è¯»å–æ“ä½œè®¾å®šä¸ºmemory_order_consumeæ¬¡åº</p>
<p>å³å¯ä¿è¯æ‰€æŒ‡å‘çš„ç›®æ ‡æ•°æ®å¾—åˆ°æ­£ç¡®åŒæ­¥è€Œæ— é¡»å¯¹ä»»ä½•éç‹¬ç«‹æ•°æ®æ–½åŠ åŒæ­¥æªæ–½</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">X</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> i<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string s<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>X<span class="token operator">*</span><span class="token operator">&gt;</span> p<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> a<span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">create_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    X<span class="token operator">*</span> x<span class="token operator">=</span><span class="token keyword keyword-new">new</span> X<span class="token punctuation">;</span>
    x<span class="token operator">-&gt;</span>i<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">;</span>
    x<span class="token operator">-&gt;</span>s<span class="token operator">=</span><span class="token string">"hello"</span><span class="token punctuation">;</span>
    a<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">use_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    X<span class="token operator">*</span> x<span class="token punctuation">;</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>x<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>i<span class="token operator">==</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>x<span class="token operator">-&gt;</span>s<span class="token operator">==</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><p>ä¸Šè¿°ä»£ç ç»“æ„çš„æ„ä¹‰åœ¨äºä¿è¯æŒ‡é’ˆpçš„è½½å…¥æ“ä½œæ¥å—åˆ¤åˆ«è¡¨è¾¾å¼å¸¦æ¥ä¾èµ–,<br>
å› æ­¤ä¸¤ä¸ªæ–­è¨€è‚¯å®šéƒ½ä¸ä¼šè§¦å‘<br>
è€Œaçš„æ–­è¨€å¯èƒ½ä¼šè§¦å‘</p>
<p>è‹¥ä»£ç æœ‰å¤§é‡æºå¸¦ä¾èµ–,åˆ™ä¼šé€ æˆé¢å¤–å¼€é”€,æˆ‘ä»¬å¹¶ä¸æƒ³ç¼–è¯‘å™¨é¢å¯¹ä¾èµ–è€ŒæŸæ‰‹æ— ç­–<br>
è€Œå¸Œæœ›å®ƒå°†å€¼ç¼“å­˜åœ¨CPUå¯„å­˜å™¨ä¸­,å¹¶é‡æ–°ç¼–æ’æŒ‡ä»¤è¿›è¡Œä¼˜åŒ–</p>
<p>è¿™æ—¶,æˆ‘ä»¬å¯ä»¥ç”¨std::kill_dependency()æ˜¾å¼æ‰“æ–­ä¾èµ–é“¾,å‡è®¾æœ‰ä¸€ä¸ªåªè¯»çš„å…¨å±€æ•°ç»„<br>
å…¶ç´¢å¼•å€¼ç”±å…¶ä»–çº¿ç¨‹ç»™å‡º,è€Œæˆ‘ä»¬é‡‡ç”¨std::memory_order_consumeæ¬¡åºæ¥å—è¯¥å€¼<br>
é‚£ä¹ˆå¯ä»¥ç”¨std::kill_dependency()å‘ŠçŸ¥ç¼–è¯‘å™¨,æ— é¡»é‡å¤è¯»æ•°ç»„å…ƒç´ </p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-int">int</span> global_data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> index<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_consume<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">do_something_with</span><span class="token punctuation">(</span>global_data<span class="token punctuation">[</span>std<span class="token double-colon punctuation">::</span><span class="token function">kill_dependency</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>å¦‚æœå­˜å‚¨æ“ä½œçš„æ ‡è®°æ˜¯memory_order_release,memory_order_acq_relæˆ–memory<br>
_order_seq_cst,è€Œè½½å…¥æ“ä½œåˆ™ä»¥memory_order_consume,memory_order_acquireæˆ–memory_order_seq_cst<br>
æ ‡è®°,é‚£ä¹ˆæ“ä½œé“¾ç”±ä¸€ä¸ªé‡Šæ”¾åºåˆ—ç»„æˆ<br>
</strong><br>
<strong>è‹¥æœ€åè½½å…¥æ“ä½œæœä»å†…å­˜æ¬¡åºmemory_order_acquireæˆ–memory_order_seq_cstä¸å®ƒæ„æˆåŒæ­¥å…³ç³»,ä½†å¦‚æœè¯¥è½½å…¥æ“ä½œæœä»çš„å†…å­˜æ¬¡åºæ˜¯memory_order_consumeé‚£ä¹ˆä¸¤è€…æ„æˆå‰åºä¾èµ–å…³ç³»,æ“ä½œé“¾ä¸­,æ¯ä¸ª"è¯»-æ”¹-å†™"æ“ä½œéƒ½å¯ä»¥é€‰ç”¨ä»»æ„å†…å­˜æ¬¡åº,ç”šè‡³ä¹Ÿèƒ½é€‰ç”¨memory_order_relaxedæ¬¡åº<br>
</strong></p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> <span class="token function">count</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> queue_data<span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">populate_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> number_of_items <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    queue_data<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>number_of_items<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        queue_data<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    count<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>number_of_items<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">consume_queue_items</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-int">int</span> item_index<span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item_index<span class="token operator">=</span>count<span class="token punctuation">.</span><span class="token function">fetch_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>queue_data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Consumed item: "</span><span class="token operator">&lt;&lt;</span>queue_data<span class="token punctuation">[</span>item_index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>populate_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t2</span><span class="token punctuation">(</span>consume_queue_items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t3</span><span class="token punctuation">(</span>consume_queue_items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre><p>count.fetch_sub(1,std::memory_order_acquire)è¡¨ç¤ºå‘å…¶ä»–çº¿ç¨‹å‘ŠçŸ¥å®ƒä¼šä»å®¹å™¨å–å‡ºä¸€é¡¹æ•°æ®,ç„¶åæ‰çœŸæ­£è¯»å–å…±äº«ç¼“å†²,ä¸€æ—¦è®¡æ•°å€¼ä¸º0,å³å†æ— æ•°æ®é¡¹å¯å–,æ¶ˆè´¹çº¿ç¨‹å¿…é¡»å°±æ­¤ç­‰å¾…</p>
<p>ä¸Šè¿°ä»£ç ä¸­ä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œå–æ“ä½œ,é™¤éå‰ä¸€ä¸ªçº¿ç¨‹ä¹Ÿé‡‡ç”¨memory_order_releaseï¼Œä½†è¿™æ ·çš„åŒæ­¥è¿‡äºä¸¥æ ¼</p>
<h3 id="æ …æ ">æ …æ  </h3>
<p>æ …æ å…·å¤‡å¤šç§æ“ä½œ,ç”¨é€”æ˜¯å¼ºåˆ¶æ–½åŠ å†…å­˜æ¬¡åº<br>
å´æ— éœ€æ”¹åŠ¨ä»»ä½•æ•°æ®<br>
é€šå¸¸,å®ƒä»¬ä¸æœä»memory_order_relaxedæ¬¡åºçš„åŸå­æ“ä½œç»„åˆä½¿ç”¨ã€‚æ …æ æ“ä½œå…¨éƒ¨é€šè¿‡å…¨å±€å‡½æ•°æ‰§è¡Œã€‚<br>
å½“çº¿ç¨‹è¿è¡Œè‡³æ …æ å¤„æ—¶,å®ƒä¾¿ä¼šå¯¹çº¿ç¨‹ä¸­å…¶ä»–åŸå­æ“ä½œçš„æ¬¡åºäº§ç”Ÿä½œç”¨,æ …æ ä¹Ÿå¸¸å¸¸è¢«ç§°ä½œå†…å­˜å¡,æˆ–å†…å­˜å±éšœ,åŸå› æ˜¯å®ƒä»¬åœ¨ä»£ç ä¸­åˆ’å‡ºç•Œé™,é™å®šæŸäº›æ“ä½œä¸å¾—é€šè¡Œ<br>
åœ¨ä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œå¯èƒ½åŸæ¥å¹¶éå¤„å¤„å…·å¤‡å…ˆè¡Œå…³ç³»å’ŒåŒæ­¥å…³ç³»,æ …æ åˆ™åœ¨æ¬ ç¼ºä¹‹å¤„å¼•å…¥è¿™ä¸¤ç§å…³ç³»</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> z<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">++</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    x<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    y<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    z<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">a</span><span class="token punctuation">(</span>write_x_then_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">b</span><span class="token punctuation">(</span>read_y_then_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    a<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"z="</span> <span class="token operator">&lt;&lt;</span> z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢çš„ä¾‹å­é€šè¿‡åŠ å…¥æ …æ å®ç°äº†åŒæ­¥<br>
åŠ å…¥æ …æ ä½¿å­˜å‚¨æ“ä½œä¸å†æœä»memory_order_relaxedæ¬¡åº,è€Œæ˜¯ä»¥memory_order_releaseæ¬¡åºè¿›è¡Œ,<br>
è€Œè¯»å–æ“ä½œåˆ™ä»¥memory_order_acquireæ¬¡åºè¿›è¡Œ,è¿™æ ·å°±èƒ½ç¡®ä¿è¯»å–æ“ä½œå…ˆäºå†™å…¥æ“ä½œè¿›è¡Œ,ä»è€Œå®ç°åŒæ­¥</p>
<p>å°½ç®¡æ …æ æ˜¯è®©è¯»å†™åŒæ­¥,ä½†åŒæ­¥ç‚¹æ˜¯æ …æ æœ¬èº«</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æ …æ ä¸å†å‰ååˆ†éš”è¿™ä¸¤ä¸ªå†™å‡ºæ“ä½œ,å› æ­¤å®ƒä»¬ä¹‹é—´åŸæ¥çš„å…ˆåæ¬¡åºä¸å¤å­˜åœ¨,æ …æ åªæœ‰æ”¾ç½®åœ¨å˜é‡xå’Œyçš„å­˜å‚¨æ“ä½œä¹‹é—´,æ‰ä¼šå¼ºåˆ¶è¿™ä¸¤ä¸ªæ“ä½œæœä»å…ˆåæ¬¡åº</p>
<h3 id="å‡­å€ŸåŸå­æ“ä½œä»¤éåŸå­æ“ä½œæœä»å†…å­˜æ¬¡åº">å‡­å€ŸåŸå­æ“ä½œä»¤éåŸå­æ“ä½œæœä»å†…å­˜æ¬¡åº </h3>
<p>å‘éåŸå­æ“ä½œå¼ºåˆ¶æ–½è¡Œå†…å­˜æ¬¡åº</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword keyword-bool">bool</span> x<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> y<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> z<span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    x<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">atomic_thread_fence</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">++</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    x<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    y<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    z<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">a</span><span class="token punctuation">(</span>write_x_then_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>thread <span class="token function">b</span><span class="token punctuation">(</span>read_y_then_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    a<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"z="</span><span class="token operator">&lt;&lt;</span>z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="å¼ºåˆ¶éåŸå­æ“ä½œæœä»å†…å­˜æ¬¡åº">å¼ºåˆ¶éåŸå­æ“ä½œæœä»å†…å­˜æ¬¡åº </h5>
<p>lock()å®ç°æ–¹å¼æ˜¯åœ¨å¾ªç¯ä¸­åå¤è°ƒç”¨flag.text_and_set()ï¼Œå…¶ä¸­æ‰€é‡‡ç”¨çš„æ¬¡åºä¸ºstd::memory_order_acquire,unlock()<br>
å®è´¨ä¸Šæ˜¯æœä»std::memory_order_releaseæ¬¡åº<br>
çš„flag.clear()æ“ä½œ,ç¬¬ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨lock()æ—¶,æ ‡å¿—flagå¤„äºç½®é›¶çŠ¶æ€,test_and_set()ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šè®¾ç½®æ ‡å¿—æˆç«‹å¹¶è¿”å›false,è¡¨ç¤ºè´Ÿè´£æ‰§è¡Œçš„çº¿ç¨‹å·²è·å–äº†é”,é‚å¾ªç¯ç»“æŸ,äº’æ–¥éšå³ç”Ÿæ•ˆ,è¯¥çº¿ç¨‹å¯ä¿®æ”¹å—å…¶ä¿æŠ¤çš„æ•°æ®è€Œä¸å—å¹²æ‰°,æ­¤æ—¶æ ‡å¿—å·²è®¾ç½®æˆç«‹,å¦‚æœä»»ä½•å…¶ä»–çº¿ç¨‹å†è°ƒç”¨lock()ï¼Œéƒ½ä¼šåœ¨test_and_set()æ‰€åœ¨å¾ªç¯ä¸­é˜»å¡</p>
<p>å½“æŒé”çº¿ç¨‹å®Œæˆäº†å—ä¿æŠ¤æ•°æ®çš„æ”¹åŠ¨,å°±è°ƒç”¨unlock(),å†è¿›ä¸€æ­¥æŒ‰std::memory_order_releaseæ¬¡åºè¯­ä¹‰æ‰§è¡Œäº†flag.clear()<br>
è‹¥ç¬¬äºŒä¸ªçº¿ç¨‹å› è°ƒç”¨äº†lock()è€Œåå¤æ‰§è¡Œflag.test_and_set(),åˆå› è¯¥æ“ä½œé‡‡ç”¨äº†std::memory_order_acquireæ¬¡åºè¯­ä¹‰,æ•…æ ‡å¿—ä¸Šçš„è¿™ä¸¤é¡¹æ“ä½œå½¢æˆåŒæ­¥,æ ¹æ®äº’æ–¥çš„ä½¿ç”¨è§„åˆ™,é¦–å…ˆ,å—ä¿æŠ¤æ•°æ®çš„æ”¹åŠ¨é¡»æŒ‰æµç¨‹é¡ºåºåœ¨è°ƒç”¨ unlock()å‰å®Œæˆ,å…¶æ¬¡åªæœ‰åœ¨è§£é”ä»¥åæ‰èƒ½é‡æ–°åŠ é”ï¼›æœ€åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹éœ€è¦å…ˆè·å–é”,æ¥ç€æ‰å¯ä»¥è®¿é—®ç›®æ ‡æ•°æ®,æ‰€ä»¥,æ”¹åŠ¨å…ˆäºunlock()å‘ç”Ÿ,è‡ªç„¶ä¹Ÿå…ˆäºç¬¬äºŒä¸ªçº¿ç¨‹çš„lock()è°ƒç”¨,è¿›è€Œæ›´åŠ å…ˆäºç¬¬äºŒä¸ªçº¿ç¨‹æ•°æ®è®¿é—®</p>
<p>å‰é¢ç« èŠ‚ä»‹ç»çš„åŒæ­¥æœºåˆ¶å¦‚ä¸‹:</p>
<ol>
<li>
<p>std::thread<br>
å¦‚æœæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªå‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡,å‡­å€Ÿæ„é€ std::threadå®ä¾‹åˆ›å»ºæ–°çº¿ç¨‹å¹¶ç”±å®ƒæ‰§è¡Œ,é‚£ä¹ˆè¯¥å®ä¾‹çš„æ„é€ å‡½æ•°çš„å®Œæˆä¸å‰è€…çš„è°ƒç”¨å½¢æˆåŒæ­¥<br>
è‹¥ç®¡æ§çº¿ç¨‹çš„std::threadå¯¹è±¡ä¸Šæ‰§è¡Œäº†joinè°ƒç”¨,è€Œæ­¤å‡½æ•°è¿”å›æˆåŠŸ,åˆ™è¯¥çº¿ç¨‹çš„è¿è¡Œå®Œæˆä¸è¿™ä¸€è¿”å›åŠ¨ä½œåŒæ­¥</p>
</li>
<li>
<p>std::mutex,std::timed_mutex,std::recursive_mutexå’Œstd::recursive_timed_mutex<br>
ç»™å®šä¸€äº’æ–¥å¯¹è±¡,å…¶ä¸Šçš„lock()å’Œunlock()çš„å…¨éƒ¨è°ƒç”¨,ä»¥åŠtry_lock()ï¼Œtry_lock_for()å’Œtry_lock_until()çš„è°ƒç”¨ä¼šå½¢æˆå•ä¸€æ€»åºåˆ—,å³å¯¹è¯¥äº’æ–¥è¿›è¡ŒåŠ é”å’Œè§£é”çš„æ“ä½œåºåˆ—</p>
</li>
</ol>
<p>ç»™å®šä¸€äº’æ–¥å¯¹è±¡,å…¶ä¸Šçš„lock()å’Œunlock()çš„å…¨éƒ¨è°ƒç”¨,ä»¥åŠtry_lock(),try_lock_for()å’Œtry_lock_until()çš„æˆåŠŸè°ƒç”¨ä¼šå½¢æˆå•ä¸€æ€»åºåˆ—,å³å¯¹è¯¥äº’æ–¥è¿›è¡ŒåŠ é”å’Œè§£é”çš„æ“ä½œåºåˆ—<br>
ç»™å®šä¸€äº’æ–¥å¯¹è±¡,åœ¨å…¶åŠ é”å’Œè§£é”çš„æ“ä½œåºåˆ—ä¸­ï¼Œæ¯ä¸ªunlock()è°ƒç”¨éƒ½ä¸ä¸‹ä¸€ä¸ªlock()è°ƒç”¨åŒæ­¥,æˆ–ä¸ä¸‹ä¸€ä¸ªtry_lock(),try_lock_for()æˆ–try_lock_until()çš„è°ƒç”¨å¤±è´¥,åˆ™ä¸æ„æˆåŒæ­¥å…³ç³»</p>
<ol start="3">
<li>std::shared_mutex,std::shared_timed_mutex<br>
ç»™å®šä¸€äº’æ–¥å¯¹è±¡,å…¶ä¸Šçš„lock(),unlock(),lock_shared()å’Œunshared_shared()çš„å…¨éƒ¨è°ƒç”¨ä»¥åŠtry_lock(),try_lock_for()å’Œtry_lock_shared_until()çš„æˆåŠŸè°ƒç”¨ä¼šå½¢æˆå•ä¸€æ€»åºåˆ—,å³å¯¹è¯¥æ²ªæŒ‡è¿›è¡ŒåŠ é”å’Œè§£é”çš„æ“ä½œåºåˆ—</li>
</ol>
<p>ç»™å®šä¸€äº’æ–¥å¯¹è±¡,åœ¨å…¶åŠ é”å’Œè§£é”çš„æ“ä½œåºåˆ—ä¸­,æ¯ä¸ªunlock()è°ƒç”¨éƒ½ä¸ä¸‹ä¸€ä¸ªlock()è°ƒç”¨åŒæ­¥,æˆ–ä¸ä¸‹ä¸€ä¸ªtry_lock(),try_lock_for(),try_lock_until(),try_lock_shared()æˆ–try_lock_shared_for()çš„æˆåŠŸè°ƒç”¨åŒæ­¥,ä½†å¦‚æœè°ƒç”¨å¤±è´¥åˆ™ä¸æ„æˆä»»ä½•åŒæ­¥å…³ç³»</p>
<ol start="4">
<li>std::promise,std::future,std::shared_future<br>
ç»™å®šä¸€std::promiseå¯¹è±¡,åˆ™æˆ‘ä»¬ç”±get_future()å¾—åˆ°å…³è”çš„std::futureå¯¹è±¡,æˆ‘ä»¬å…±äº«å¼‚æ­¥çŠ¶æ€,å¦‚æœstd::promiseä¸Šçš„set_value()æˆ–set_exception()è°ƒç”¨æˆåŠŸ,åˆå¦‚æœæˆ‘ä»¬æ¥ç€åœ¨è¯¥std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait()æˆ–get(),wait_for()æˆ–wait_until()ï¼ŒæˆåŠŸè¿”å›std::future_status::ready,é‚£ä¹ˆè¿™ä¸¤æ¬¡è°ƒç”¨çš„æˆåŠŸè¿”å›æ„æˆåŒæ­¥</li>
</ol>
<p>ç»™å®šä¸€std::promiseå¯¹è±¡,åˆ™æˆ‘ä»¬ç”±get_future()å¾—åˆ°å…³è”çš„std::futureå¯¹è±¡,å®ƒä»¬å…±äº«å¼‚æ­¥çŠ¶æ€,å¦‚æœå‡ºç°å¼‚å¸¸,è¯¥å¼‚æ­¥çŠ¶æ€å°±ä¼šå­˜å‚¨ä¸€ä¸ªstd::future_errorå¼‚å¸¸å¯¹è±¡,åˆå¦‚æœæˆ‘ä»¬åœ¨å…³è”çš„std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait()...æˆåŠŸè¿”å›std::future_status::readyï¼Œé‚£ä¹ˆstd::promiseå¯¹è±¡çš„ææ„å‡½æ•°ä¸è¯¥æˆåŠŸè¿”å›æ„æˆåŒæ­¥</p>
<ol start="5">
<li>std::packaged_task,std::futureå’Œstd::shared_future<br>
ç»™å®šä¸€std::packaged_taskå¯¹è±¡,åˆ™æˆ‘ä»¬ç”±get_future()å¾—åˆ°å…³è”çš„std::futureå¯¹è±¡,å®ƒä»¬å…±äº«å¼‚æ­¥çŠ¶æ€,å¦‚æœåŒ…è£…çš„ä»»åŠ¡ç”±std::packaged_taskçš„å‡½æ•°è°ƒç”¨æ“ä½œç¬¦è¿è¡Œ,æˆ‘ä»¬å…³è”çš„std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait(),get(),wait_for()æˆ–wait_until()æˆåŠŸè¿”å›std::future_status::ready,é‚£ä¹ˆè¿™ä¸¤æ¬¡è°ƒç”¨çš„æˆåŠŸè¿”å›æ„æˆåŒæ­¥</li>
</ol>
<p>ç»™å®šä¸€std::packaged_taskå¯¹è±¡,åˆ™æˆ‘ä»¬ç”±get_future()å¾—åˆ°å…³è”çš„std::futureå¯¹è±¡,å®ƒä»¬å…±äº«å¼‚æ­¥çŠ¶æ€,å¦‚æœåŒ…è£…çš„ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸,è¯¥å¼‚æ­¥çŠ¶æ€å°±ä¼šå­˜å‚¨ä¸€ä¸ªstd::future_errorå¼‚å¸¸å¯¹è±¡,åˆå¦‚æœæˆ‘ä»¬åœ¨å…³è”çš„std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait()...æˆåŠŸè¿”å›std::future_status::ready,é‚£ä¹ˆstd::packaged_taskå¯¹è±¡çš„ææ„å‡½æ•°ä¸è¯¥æˆåŠŸè¿”å›æ„æˆåŒæ­¥</p>
<ol start="6">
<li>std::asyncï¼Œstd::futureå’Œstd::shared_futrure,å¦‚æœä¸€é¡¹ä»»åŠ¡é€šè¿‡è°ƒç”¨std::launch::asyncæ–¹å¼åœ¨å…¶ä»–çº¿ç¨‹ä¸Šå¼‚æ­¥è¿è¡Œ,åˆ™è¯¥std::asyncè°ƒç”¨ä¼šç”Ÿæˆä¸€ä¸ªå…³è”çš„std::futureå¯¹è±¡,å®ƒä¸å¯åŠ¨çš„ä»»åŠ¡å…±äº«å¼‚æ­¥çŠ¶æ€,è‹¥æˆ‘ä»¬åœ¨è¯¥std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait(),get()ï¼Œwait_for()æˆ–wait_until()æˆåŠŸè¿”å›std::future_status::ready,é‚£ä¹ˆä»»åŠ¡çš„å®Œæˆä¸è¯¥ä»»åŠ¡æˆåŠŸè¿”å›æ„æˆåŒæ­¥</li>
</ol>
<p>å¦‚æœä»¥std::launch::deferredæ–¹å¼å¯åŠ¨çš„ä»»åŠ¡,åˆ™è¯¥ä»»åŠ¡çš„è¿è¡Œä¸std::asyncè°ƒç”¨çš„è¿”å›åŒæ­¥,è‹¥ä»»åŠ¡çš„è¿è¡Œå®Œæˆ,åˆ™è¯¥ä»»åŠ¡çš„ç»“æœä¸std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait(),get()ï¼Œwait_for()æˆ–wait_until()çš„æˆåŠŸè¿”å›åŒæ­¥,è‹¥ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸,åˆ™è¯¥å¼‚å¸¸ä¸std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait(),get()ï¼Œwait_for()æˆ–wait_until()çš„å¼‚å¸¸è¿”å›åŒæ­¥</p>
<ol start="7">
<li>
<p>std::experimental::futureï¼Œstd::experimental::shared_futureå’Œåç»­å‡½æ•°<br>
å¼‚æ­¥å…±äº«çŠ¶æ€ä¼šå› ç›®æ ‡äº‹ä»¶è§¦å‘è€Œå˜æˆå°±ç»ª,å…±äº«çŠ¶æ€ä¸Šæ‰€ç¼–æ’çš„åç»­å‡½æ•°ä¹Ÿéšä¹‹è¿è¡Œ,è¯¥äº‹ä»¶ä¸åç»­å‡½æ•°çš„å¯åŠ¨æ„æˆåŒæ­¥ï¼Œåœ¨èµ·å§‹futureä¸Šè°ƒç”¨thenæ¥ç¼–æ’åç»­å‡½æ•°,å¹¶ç”±æ­¤ç”Ÿæˆå¦ä¸€ä¸ªstd::futureå¯¹è±¡,å®ƒä¸èµ·å§‹futureå…±äº«å¼‚æ­¥çŠ¶æ€,è‹¥æˆ‘ä»¬åœ¨è¯¥æ–°std::futureå¯¹è±¡ä¸Šè°ƒç”¨wait(),get(),wait_For()æˆ–wait_until(),æˆåŠŸè¿”å›std::future_status::readyé‚£ä¹ˆåç»­å‡½æ•°çš„å®Œæˆä¼šä¸è¯¥æˆåŠŸè¿”å›æ„æˆåŒæ­¥,æˆ–ä¸æ‰€ç¼–æ’çš„ä¸‹ä¸€ä¸ªåç»­å‡½æ•°çš„å¯åŠ¨æ„æˆåŒæ­¥</p>
</li>
<li>
<p>std::latch è‹¥åœ¨å…¶ä¸Šè°ƒç”¨count_down(),æˆ–count_down_and_wait()ï¼Œåˆ™æ¯æ¬¡è°ƒç”¨çš„å¯åŠ¨éƒ½ä¸å…¶è‡ªèº«çš„å®ŒæˆåŒæ­¥</p>
</li>
<li>
<p>std::barrier è‹¥åœ¨å…¶ä¸Šè°ƒç”¨arrive_and_wait()æˆ–arrive_and_drop(),åˆ™æ¯æ¬¡è°ƒç”¨çš„å¯åŠ¨éƒ½ä¸å…¶è‡ªèº«çš„å®ŒæˆåŒæ­¥</p>
</li>
<li>
<p>std::experimental::flex_barrierï¼šç»™å®šä¸€std::experimental::flex_barrierå®ä¾‹,è‹¥åœ¨å…¶ä¸Šè°ƒç”¨arrive_and_wait()æˆ–arrive_and_drop(),åˆ™æ¯æ¬¡è°ƒç”¨çš„å¯åŠ¨éƒ½ä¸å…¶ä¸‹ä¸€æ¬¡arrive_and_wait()è¿è¡Œå®ŒæˆåŒæ­¥<br>
ç»™å®šä¸€ std::experimental::flex_barrierå®ä¾‹,è‹¥åœ¨å…¶ä¸Šè°ƒç”¨wait()æˆ–wait_for()æˆ–wait_until(),åˆ™æ¯æ¬¡è°ƒç”¨çš„å¯åŠ¨éƒ½ä¸å…¶è¡¥å…¨å‡½æ•°çš„å…¨éƒ¨å¯åŠ¨å®ŒæˆåŒæ­¥<br>
ç»™å®šä¸€ std::experimental::flex_barrierå®ä¾‹,è‹¥åœ¨å…¶ä¸Šè°ƒç”¨arrive_and_drop(),åˆ™è¿™äº›è°ƒç”¨ä¼šå› ç­‰å¾…è¡¥å…¨å‡½æ•°çš„å®Œæˆè€Œå‘ç”Ÿé˜»å¡,è€Œè¡¥å…¨å‡½æ•°çš„è¿”å›ä¸è¿™äº›è°ƒç”¨çš„å®Œæˆæ„æˆåŒæ­¥</p>
</li>
<li>
<p>std::condition_variableå’Œstd::condition_variable_any<br>
æ¡ä»¶å˜é‡å¹¶ä¸æä¾›ä»»ä½•åŒæ­¥å…³ç³»,å®ƒä»¬æœ¬è´¨ä¸Šæ˜¯å¿™ç¢Œç­‰å¾ªç¯çš„ä¼˜åŒ–,å…¶æ‰€æœ‰åŒæ­¥åŠŸèƒ½éƒ½ç”±å…³è”çš„äº’æ–¥æä¾›</p>
</li>
</ol>
<h2 id="è®¾è®¡åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„">è®¾è®¡åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„ </h2>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADSAFE_QUEUE_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADSAFE_QUEUE_HPP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.shared_mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_queue</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex mut<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data_queue<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>condition_variable data_cond<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword keyword-this">this</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> <span class="token operator">!</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword keyword-this">this</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> <span class="token operator">!</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">try_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">try_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// THREADSAFE_QUEUE_HPP</span></span>

</code></pre><p>æœ¬ä¾‹ä¸æ ˆå®¹å™¨æœ‰æ‰€ä¸åŒ:å‡å®šåœ¨æ•°æ®å…¥é˜Ÿçš„è¿‡ç¨‹ä¸­,æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶åœ¨ç­‰å¾…,é‚£ä¹ˆdata_cond.notify_one()çš„è°ƒç”¨åªä¼šå”¤é†’ä¸€ä¸ª,ç„¶è€Œè‹¥è¯¥è§‰é†’çš„çº¿ç¨‹åœ¨wait_and_pop()æ—¶æŠ›å‡ºå¼‚å¸¸,å°±ä¸ä¼šæœ‰ä»»ä½•å…¶ä»–çº¿ç¨‹è¢«å”¤é†’,å¦‚æœå¸Œæœ›æ‰€æœ‰ç­‰å¾…çº¿ç¨‹éƒ½è¢«å”¤é†’,ä½¿ç”¨data_cond.notify_all()å³å¯ï¼Œä½†ä¼šå¤§å¤§å¢åŠ å¼€é”€<br>
æ”¹å–„æ–¹æ³•æ˜¯ä¸ºäº†ä¸æŠ›å‡ºå¼‚å¸¸,é˜Ÿåˆ—å®¹å™¨æ”¹ä¸ºå­˜å‚¨std::shared_ptr&lt;&gt;</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADSAFE_QUEUE_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADSAFE_QUEUE_HPP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.shared_mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_queue</span> 
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex mut<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> data_queue<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>condition_variable data_cond<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword keyword-this">this</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> <span class="token operator">!</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">try_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> res <span class="token operator">=</span> data_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>        
            <span class="token keyword keyword-return">return</span> data_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// THREADSAFE_QUEUE_HPP</span></span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREAD_SAFE_STACK_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREAD_SAFE_STACK_HPP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.shared_mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stack&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;exception&gt;</span></span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">empty_stack</span><span class="token operator">:</span><span class="token base-clause">std<span class="token double-colon punctuation">::</span><span class="token class-name">exception</span></span><span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-char">char</span><span class="token operator">*</span> <span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-throw">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_stack</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>stack<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> stack<span class="token punctuation">;</span>
        <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">threadsafe_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">threadsafe_stack</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_stack<span class="token operator">&amp;</span> other<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data <span class="token operator">=</span> other<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        threadsafe_stack<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_stack<span class="token operator">&amp;</span> <span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-throw">throw</span> <span class="token function">empty_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span> <span class="token function">res</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-void">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword keyword-throw">throw</span> <span class="token function">empty_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-bool">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// THREAD_SAFE_STACK_HPP</span></span>
</code></pre><h4 id="é‡‡ç”¨ç»†ç²’åº¦çš„é”å’Œæ¡ä»¶å˜é‡å®ç°çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—å®¹å™¨">é‡‡ç”¨ç»†ç²’åº¦çš„é”å’Œæ¡ä»¶å˜é‡å®ç°çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—å®¹å™¨ </h4>
<p>å•çº¿ç¨‹é˜Ÿåˆ—çš„ç®€å•å®ç°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span> <span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            T data<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
            <span class="token function">node</span><span class="token punctuation">(</span>T data_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> head<span class="token punctuation">;</span>
        node<span class="token operator">*</span> tail<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">queue</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        queue<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> queue<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">try_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span> <span class="token function">res</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>head<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            head <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                tail <span class="token operator">=</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token function">node</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> new_tail <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span>
            <span class="token punctuation">{</span>
                head<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tail <span class="token operator">=</span> new_tail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ol>
<li>
<p>é€šè¿‡åˆ†ç¦»æ•°æ®è€Œå®ç°å¹¶å‘<br>
æˆ‘ä»¬å¯ä»¥é¢„å…ˆè®¾ç½®ä¸€ä¸ªä¸å«æ•°æ®çš„è™šä½èŠ‚ç‚¹<br>
ä»è€Œä¿è¯è‡³å°‘å­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹,ä»¥åŒºåˆ«å¤´å°¾ä¸¤ä¸ªèŠ‚ç‚¹çš„è®¿é—®,å¦‚æœé˜Ÿåˆ—ä¸ºç©º,headå’Œtailä¸¤ä¸ªæŒ‡é’ˆéƒ½ä¸å†æ˜¯NULLå€¼,è€Œæ˜¯åŒæ—¶æŒ‡å‘è™šä½èŠ‚ç‚¹<br>
è‹¥æˆ‘ä»¬å‘é˜Ÿåˆ—æ·»åŠ æ•°æ®,åˆ™headå’ŒtailæŒ‡é’ˆä¼šåˆ†åˆ«æŒ‡å‘ä¸åŒçš„èŠ‚ç‚¹,åœ¨head-&gt;nextå’Œtail-&gt;nextä¸Šä¸ä¼šå‡ºç°ç«äº‰,ä½†å…¶ç¼ºç‚¹æ˜¯,ä¸ºäº†å®¹çº³è™šä½èŠ‚ç‚¹,æˆ‘ä»¬éœ€è¦é€šè¿‡æŒ‡é’ˆé—´æ¥å­˜å‚¨æ•°æ®,é¢å¤–å¢åŠ äº†ä¸€ä¸ªè®¿é—®å±‚çº§</p>
<p>å¸¦æœ‰è™šä½èŠ‚ç‚¹çš„ç®€å•é˜Ÿåˆ—</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span> <span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">queue</span>
<span class="token punctuation">{</span>
 <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
     <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
     <span class="token punctuation">{</span>
         std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
         std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>
     std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> head<span class="token punctuation">;</span>
     node<span class="token operator">*</span> tail<span class="token punctuation">;</span>
 <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
     <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">tail</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
     queue<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
     queue<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> queue<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
     std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">try_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
         <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>tail<span class="token punctuation">)</span>
         <span class="token punctuation">{</span>
             <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span> <span class="token function">res</span><span class="token punctuation">(</span>head<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
         std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> old_head <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
         head <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
         std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
         tail<span class="token operator">-&gt;</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
         node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> new_tail <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
         tail <span class="token operator">=</span> new_tail<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ol>
<p>å¼•å…¥è™šä½èŠ‚ç‚¹,headæŒ‡é’ˆä¸å†å–å€¼NULL,æ”¹ä¸ºæ¯”è¾ƒheadå’Œtailæ˜¯å¦é‡å </p>
<p>pushåªè®¿é—®tailæŒ‡é’ˆè€Œä¸å†è§¦åŠheadæŒ‡é’ˆï¼Œè™½ç„¶try_pop()æ—¢è®¿é—®headæŒ‡é’ˆåˆè®¿é—®tailæŒ‡é’ˆ,ä½†tailæŒ‡é’ˆåªç”¨äºå‡½æ•°ä¸­æœ€å¼€å§‹çš„æ¯”è¾ƒè¿ç®—ï¼Œæ‰€ä»¥åªéœ€çŸ­æš‚æŒé”</p>
<p>pushåœ¨æ–°èŠ‚ç‚¹åˆ›å»ºå®Œæˆå°±é”ä½,åœ¨æ•°æ®èµ‹äºˆå½“å‰å°¾èŠ‚ç‚¹ä¹‹å‰ä¹Ÿè¦é”ä½äº’æ–¥<br>
try_popé¦–å…ˆéœ€è¦ä¸ºheadé”ä½äº’æ–¥å¹¶ä¸€ç›´æŒé”,ç­‰å¾…ä½¿ç”¨å®Œå†è§£é”ï¼Œä½™ä¸‹åªæœ‰tail<br>
éœ€è¦åœ¨å¯¹åº”çš„äº’æ–¥ä¸ŠåŠ é”,æœ€å¥½åœ¨ä¸´è¿‘è®¿é—®å†åŠ é”,æ‰€ä»¥å¯ä»¥å°†åŠ é”å’Œè®¿é—®å°è£…æˆä¸€ä¸ªå‡½æ•°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREAD_SAFE_QUEUE_FINEGRAIN_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREAD_SAFE_QUEUE_FINEGRAIN_HPP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.shared_mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>mutex head_mutex<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> head<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>mutex tail_mutex<span class="token punctuation">;</span>
        node<span class="token operator">*</span> tail<span class="token punctuation">;</span>
        node<span class="token operator">*</span> <span class="token function">get_tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">tail_lock</span><span class="token punctuation">(</span>tail_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> tail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span><span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">head_lock</span><span class="token punctuation">(</span>head_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">get_tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> old_head <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            head <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> old_head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">tail</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        threadsafe_queue<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">try_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token punctuation">,</span>node<span class="token operator">&gt;</span> old_head <span class="token operator">=</span> <span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword keyword-return">return</span> old_head <span class="token operator">?</span> old_head<span class="token operator">-&gt;</span>data <span class="token operator">:</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">new_node</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> new_tail <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">tail_lock</span><span class="token punctuation">(</span>tail_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tail<span class="token operator">-&gt;</span>data <span class="token operator">=</span> new_data<span class="token punctuation">;</span>
            tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tail <span class="token operator">=</span> new_tail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADSAFE_QUEUE_WAIT_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADSAFE_QUEUE_WAIT_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>mutex head_mutex<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> head<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>mutex tail_mutex<span class="token punctuation">;</span>
        node<span class="token operator">*</span> tail<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>condition_variable data_cond<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">tail</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">threadsafe_queue</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_queue<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        threadsafe_queue<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> threadsafe_queue<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">try_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">try_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">wait_and_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        node<span class="token operator">*</span> <span class="token function">get_tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">tail_lock</span><span class="token punctuation">(</span>tail_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> tail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> old_head<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            head <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> old_head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">wait_for_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">head_lock</span><span class="token punctuation">(</span>head_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>head_lock<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span> <span class="token function">get_tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>head_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">wait_pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">head_lock</span><span class="token punctuation">(</span><span class="token function">wait_for_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">wait_pop_head</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">head_lock</span><span class="token punctuation">(</span><span class="token function">wait_for_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>head<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">try_pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">head_lock</span><span class="token punctuation">(</span>head_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">get_tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>node<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> <span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">try_pop_head</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">head_lock</span><span class="token punctuation">(</span>head_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">get_tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>node<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>head<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">threadsafe_queue</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">new_data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">tail_lock</span><span class="token punctuation">(</span>tail_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tail<span class="token operator">-&gt;</span>data <span class="token operator">=</span> new_data<span class="token punctuation">;</span>
        tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> new_tail <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tail <span class="token operator">=</span> new_tail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    data_cond<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token class-name">threadsafe_queue</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">wait_and_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span> old_head <span class="token operator">=</span> <span class="token function">wait_pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> old_head<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">threadsafe_queue</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">wait_and_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> old_head <span class="token operator">=</span> <span class="token function">wait_pop_head</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token class-name">threadsafe_queue</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">try_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span> old_head <span class="token operator">=</span> <span class="token function">try_pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> old_head<span class="token operator">?</span> old_head<span class="token operator">-&gt;</span>data <span class="token operator">:</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-bool">bool</span> <span class="token class-name">threadsafe_queue</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">try_pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span> old_head <span class="token operator">=</span> <span class="token function">try_pop_head</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> old_head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-bool">bool</span> <span class="token class-name">threadsafe_queue</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">head_lock</span><span class="token punctuation">(</span>head_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> head<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">get_tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// THREADSAFE_QUEUE_WAIT_HPP</span></span>
</code></pre><h3 id="è®¾è®¡æ›´å¤æ‚çš„åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„">è®¾è®¡æ›´å¤æ‚çš„åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„ </h3>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">THREADSAFE_LIST_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADSAFE_LIST_HPP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.shared_mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;hash_map&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;utility&gt;</span></span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">threadsafe_list</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> next<span class="token punctuation">;</span>
        <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">node</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> value<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    node head<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span> 
        <span class="token function">threadsafe_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">threadsafe_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">remove_if</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>node <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">threadsafe_list</span><span class="token punctuation">(</span>threadsafe_list <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span>delele<span class="token punctuation">;</span>
        threadsafe_list<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>threadsafe_list <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Function</span><span class="token operator">&gt;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">for_each</span><span class="token punctuation">(</span>Function f<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> current<span class="token operator">=</span><span class="token operator">&amp;</span>head<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> next<span class="token operator">=</span>current<span class="token operator">-&gt;</span>next<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">next_lk</span><span class="token punctuation">(</span>next<span class="token operator">-&gt;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
                lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">*</span>next<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                current<span class="token operator">=</span>next<span class="token punctuation">;</span>
                lk <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>next_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Predicate</span><span class="token operator">&gt;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">find_first_if</span><span class="token punctuation">(</span>Predicate p<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> current <span class="token operator">=</span><span class="token operator">&amp;</span>head<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> next<span class="token operator">=</span>current<span class="token operator">-&gt;</span>next<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">next_lk</span><span class="token punctuation">(</span>next<span class="token operator">-&gt;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
                lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">p</span><span class="token punctuation">(</span><span class="token operator">*</span>next<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword keyword-return">return</span> next<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                current<span class="token operator">=</span>next<span class="token punctuation">;</span>
                lk <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>next_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Predicate</span><span class="token operator">&gt;</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">remove_if</span><span class="token punctuation">(</span>Predicate p<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> current<span class="token operator">=</span><span class="token operator">&amp;</span>head<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> next<span class="token operator">=</span> current<span class="token operator">-&gt;</span>next<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">next_lk</span><span class="token punctuation">(</span>next<span class="token operator">-&gt;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">p</span><span class="token punctuation">(</span><span class="token operator">*</span>next<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">next_lk</span><span class="token punctuation">(</span>next<span class="token operator">-&gt;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">p</span><span class="token punctuation">(</span><span class="token operator">*</span>next<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> old_next <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        current<span class="token operator">-&gt;</span>next <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>next<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        next_lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword keyword-else">else</span> 
                    <span class="token punctuation">{</span>
                        lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        current <span class="token operator">=</span> next<span class="token punctuation">;</span>
                        lk <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>next_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// THREADSAFE_LIST_HPP</span></span>
</code></pre><h2 id="è®¾è®¡æ— é”æ•°æ®ç»“æ„">è®¾è®¡æ— é”æ•°æ®ç»“æ„ </h2>
<p>ç®—æ³•å’Œæ•°æ®ç»“æ„ä¸­åªè¦é‡‡ç”¨äº†äº’æ–¥,æ¡ä»¶å˜é‡æˆ–futureè¿›è¡ŒåŒæ­¥æ“ä½œ,å°±ç§°ä¹‹ä¸ºé˜»å¡å‹ç®—æ³•å’Œé˜»å¡å‹æ•°æ®ç»“æ„,å¦‚æœåº”ç”¨ç¨‹åºè°ƒç”¨æŸäº›åº“å‡½æ•°,å‘èµ·è°ƒç”¨çš„çº¿ç¨‹ä¾¿ä¼šæš‚åœè¿è¡Œ,å³åœ¨å‡½æ•°çš„è°ƒç”¨ç‚¹é˜»å¡,ç­‰åˆ°å¦ä¸€çº¿ç¨‹å®ŒæˆæŸé¡¹ç›¸å…³æ“ä½œ,é˜»å¡æ‰ä¼šè§£é™¤,å‰è€…æ‰ä¼šç»§ç»­è¿è¡Œã€‚<br>
è¿™äº›åº“å‡½æ•°çš„è°ƒç”¨è¢«å‘½åä¸ºé˜»å¡å‹è°ƒç”¨,æ“ä½œç³»ç»Ÿå¾€å¾€ä¼šæŠŠè¢«é˜»å¡çš„çº¿ç¨‹å½»åº•æš‚åœ,å¹¶å°†å…¶æ—¶é—´ç‰‡åˆ†ç»™å…¶ä»–çº¿ç¨‹,ç­‰åˆ°æœ‰çº¿ç¨‹æ‰§è¡Œäº†æ°å½“çš„æ“ä½œ,é˜»å¡æ–¹è¢«è§£é™¤,æ°å½“çš„æ“ä½œå¯èƒ½æ˜¯é‡Šæ”¾äº’æ–¥,çŸ¥ä¼šæ¡ä»¶å˜é‡,æˆ–æ˜¯æœªfutureå¯¹è±¡è£…å¡«ç»“æœå€¼è€Œä»¤å…¶å°±ç»ª</p>
<p>æ²¡æœ‰é‡‡ç”¨ä¸Šè¿°é˜»å¡å‹åº“å‡½æ•°çš„è°ƒç”¨çš„ç§°ä¸ºéé˜»å¡å‹ç®—æ³•å’Œéé˜»å¡å‹æ•°æ®ç»“æ„</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">spinlock_mutex</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic_flag flag<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">spinlock_mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">flag</span><span class="token punctuation">(</span>ATOMIC_FLAG_INIT<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">test_and_set</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-void">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        flag<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>å®è·µä¸­,æˆ‘ä»¬éœ€è¦å‚è€ƒä¸‹åˆ—è¯¦ç»†å®šä¹‰,æ ¹æ®é€‚ç”¨çš„æ¡æ¬¾,åˆ†è¾¨è¯¥å‹åˆ«/å‡½æ•°å±äºå“ªä¸€ç±»</p>
<ol>
<li>æ— é˜»ç¢:å‡å®šå…¶ä»–çº¿ç¨‹å…¨éƒ¨æš‚åœ,åˆ™ç›®æ ‡çº¿ç¨‹å°†åœ¨æœ‰é™æ­¥éª¤å†…å®Œæˆè‡ªå·±çš„æ“ä½œ</li>
<li>æ— é”:å¦‚æœå¤šä¸ªçº¿ç¨‹å…±åŒæ“ä½œåŒä¸€ä»½æ•°æ®,é‚£ä¹ˆåœ¨æœ‰é™æ­¥éª¤å†…,å…¶ä¸­æŸä¸€çº¿ç¨‹èƒ½å¤Ÿå®Œæˆè‡ªå·±çš„æ“ä½œ</li>
<li>å…ç­‰:åœ¨æŸä»½æ•°æ®ä¸Š,æ¯ä¸ªçº¿ç¨‹ç»è¿‡æœ‰é™æ­¥éª¤å°±èƒ½å®Œæˆè‡ªå·±çš„æ“ä½œ,å³ä¾¿è¯¥ä»½æ•°æ®åŒæ—¶è¢«å…¶ä»–å¤šä¸ªçº¿ç¨‹æ“ä½œ</li>
</ol>
<h3 id="æ— éœ€ç­‰å¾…çš„æ•°æ®ç»“æ„">æ— éœ€ç­‰å¾…çš„æ•°æ®ç»“æ„ </h3>
<p>å¦‚æœå®ƒè¢«å¤šä¸ªçº¿ç¨‹è®¿é—®,ä¸è®ºå…¶ä»–çº¿ç¨‹ä¸Šå‘ç”Ÿä»€ä¹ˆ,æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½åœ¨æœ‰é™æ­¥éª¤å†…å®Œæˆè‡ªå·±çš„æ“ä½œ,<br>
è‹¥å¤šä¸ªçº¿ç¨‹ä¹‹é—´å­˜åœ¨å†²çª,å¯¼è‡´æŸç®—æ³•æ— é™åˆ¶çš„åå¤å°è¯•æ‰§è¡Œæ“ä½œ,é‚£å®ƒå°±æ˜¯å…ç­‰ç®—æ³•</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LOCK_FREE_STACK_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOCK_FREE_STACK_HPP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_stack</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            T data<span class="token punctuation">;</span>
            node<span class="token operator">*</span> next<span class="token punctuation">;</span>
            <span class="token function">node</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> T<span class="token operator">&amp;</span> data_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">data</span><span class="token punctuation">(</span>data_<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>node<span class="token operator">*</span><span class="token operator">&gt;</span> head<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> new_node <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token function">node</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>new_node<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span> new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//é¦–å…ˆä¸ç­‰,new_node-&gt;next = head;ç„¶åç›¸ç­‰head=new_nodeï¼Œé€€å‡ºå¾ªç¯</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">pop</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> result<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>old_head<span class="token punctuation">,</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token operator">=</span>old_head<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token comment">//ä¸€æ—¦æ¯”è¾ƒäº¤æ¢æ“ä½œæˆåŠŸ,è¯´æ˜åªæœ‰å½“å‰çº¿ç¨‹åœ¨æ”¹åŠ¨æ ˆå®¹å™¨,ä»æ ˆé¡¶å¼¹å‡ºèŠ‚ç‚¹</span>
        <span class="token comment">//è¯¥æ®µä»£ç æœªå¤„ç†ç©ºæ ˆæƒ…å†µ,ä»¥åŠå®‰å…¨å¼‚å¸¸å¤„ç†</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_stack_sptr</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span><span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
        node<span class="token operator">*</span> next<span class="token punctuation">;</span>
        <span class="token function">node</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>node<span class="token operator">*</span><span class="token operator">&gt;</span> head<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> new_node <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token function">node</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>new_node<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span> new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>old_head <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>old_head<span class="token punctuation">,</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> old_head<span class="token operator">?</span> old_head<span class="token operator">-&gt;</span>data <span class="token operator">:</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//è¿™æ®µä»£ç è™½ç„¶æ˜¯æ— é”å®ç°,å´éå…ç­‰å®ç°,åŸå› åœ¨äºè‹¥compare_exchange_weak()çš„ç»“æœæ€»æ˜¯false,ç†è®ºä¸Šä¼šå¯¼è‡´push()å’Œpop()ä¸­çš„whileå¾ªç¯æŒç»­è¿›è¡Œ</span>
    <span class="token comment">//åªæœ‰ç­‰åˆ°æ²¡æœ‰çº¿ç¨‹è°ƒç”¨pop()æ—¶æ‰åˆ é™¤é“¾è¡¨ä¸­çš„èŠ‚ç‚¹</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>node<span class="token operator">*</span><span class="token operator">&gt;</span> to_be_deleted<span class="token punctuation">;</span>
        <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">delete_nodes</span><span class="token punctuation">(</span>node<span class="token operator">*</span> nodes<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                node<span class="token operator">*</span> next <span class="token operator">=</span> nodes<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword keyword-delete">delete</span> nodes<span class="token punctuation">;</span>
                nodes <span class="token operator">=</span> next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">try_reclaim</span><span class="token punctuation">(</span>node<span class="token operator">*</span> old_head<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>threads_in_pop<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                node<span class="token operator">*</span> nodes_to_delete <span class="token operator">=</span> to_be_deleted<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å½“å‰çº¿ç¨‹æŠŠå€™åˆ é“¾è¡¨æ”¶å½’å·±æœ‰</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">--</span>threads_in_pop<span class="token punctuation">)</span><span class="token comment">//åˆ¤æ–­pop()æ˜¯å¦ä»…ä»…æ­£è¢«å½“å‰çº¿ç¨‹å”¯ä¸€è°ƒç”¨</span>
                <span class="token punctuation">{</span>
                    <span class="token function">delete_nodes</span><span class="token punctuation">(</span>nodes_to_delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>nodes_to_delete<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">chain_pending_nodes</span><span class="token punctuation">(</span>nodes_to_delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-delete">delete</span> old_head<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">{</span>
                <span class="token function">chain_pending_node</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">--</span>threads_in_pop<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-void">void</span> <span class="token function">chain_pending_nodes</span><span class="token punctuation">(</span>node<span class="token operator">*</span> nodes<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> last<span class="token operator">=</span>nodes<span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> next<span class="token operator">=</span>last<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                last<span class="token operator">=</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">chain_pending_nodes</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-void">void</span> <span class="token function">chain_pending_nodes</span><span class="token punctuation">(</span>node<span class="token operator">*</span> first<span class="token punctuation">,</span> node<span class="token operator">*</span> last<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            last<span class="token operator">-&gt;</span>next <span class="token operator">=</span> to_be_deleted<span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>to_be_deleted<span class="token punctuation">.</span><span class="token function">compare_exchane_weak</span><span class="token punctuation">(</span>last<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span>first<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å€Ÿå¾ªç¯ä¿è¯last-&gt;nextæŒ‡å‘æ­£ç¡®</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-void">void</span> <span class="token function">chain_pending_node</span><span class="token punctuation">(</span>node<span class="token operator">*</span> n<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">chain_pending_nodes</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>    
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-unsigned">unsigned</span><span class="token operator">&gt;</span> threads_in_pop<span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">try_reclaim</span><span class="token punctuation">(</span>node<span class="token operator">*</span> old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop_safe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token operator">++</span>threads_in_pop<span class="token punctuation">;</span>
            node<span class="token operator">*</span> old_head <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>old_head<span class="token operator">&amp;&amp;</span><span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>old_head<span class="token punctuation">,</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//æ­¤å¤„headå·²ç»æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹,æ‰€ä»¥ä¸ä¼šæœ‰çº¿ç¨‹å†è®¿é—®old_head</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> res<span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">try_reclaim</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//åŸå­å˜é‡threads_in_popè®°å½•ç›®å‰æ­£æœ‰å¤šå°‘çº¿ç¨‹è¯•å›¾ä»æ ˆå®¹å™¨å¼¹å‡ºæ•°æ®</span>
        <span class="token comment">//å®ƒåœ¨pop()å‡½æ•°çš„æœ€å¼€å§‹å¤„è‡ªå¢,åœ¨try_reclaim()å†…éƒ¨è‡ªå‡,æ¯å½“æœ‰èŠ‚ç‚¹è¢«åˆ é™¤,ç¨‹åºå°±è°ƒç”¨try_reclaim()ä¸€æ¬¡</span>
        <span class="token comment">//ç”±äºå¯èƒ½å»¶ååˆ é™¤èŠ‚ç‚¹,æ‰€ä»¥æš‚æ—¶åªç”¨swapå°†æ•°æ®ç½®æ¢å‡ºæ¥,è€Œå…ˆä¸åˆ é™¤åœ°å€</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// LOCK_FREE_STACK_HPP</span></span>
</code></pre><p>é‡‡ç”¨é£é™©æŒ‡é’ˆå®ç°çš„pop()å‡½æ•°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>hp<span class="token operator">=</span><span class="token function">get_hazard_pointer_for_current_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">*</span> old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-do">do</span><span class="token punctuation">{</span>
        node<span class="token operator">*</span> temp<span class="token operator">=</span>old_head<span class="token punctuation">;</span>
        <span class="token keyword keyword-do">do</span><span class="token punctuation">{</span><span class="token comment">//åå¤å¾ªç¯ç›´åˆ°é£é™©æŒ‡é’ˆè¢«è®¾ç½®ä¸ºheadæ‰åœæ­¢</span>
            temp<span class="token operator">=</span>old_head<span class="token punctuation">;</span>
            hp<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>old_head1<span class="token operator">!=</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>old_head<span class="token punctuation">,</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hp<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">outstanding_hazard_pointers_for</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span><span class="token comment">//åˆ é™¤æ—§æœ‰å¤´ç»“ç‚¹ä¹‹å‰,å…ˆæ£€æŸ¥å®ƒæ˜¯å¦æ­£åœ¨è¢«é£é™©æŒ‡é’ˆæ‰€æŒ‡æ¶‰</span>
        <span class="token comment">//è‹¥è¢«æŒ‡æ¶‰,è¯¥èŠ‚ç‚¹å°±ä¸èƒ½é©¬ä¸Šåˆ é™¤,æˆ‘ä»¬è°ƒç”¨delete_nodes_with_no_hazards()ï¼Œä»¥æ£€æŸ¥reclaim_later()å›æ”¶æ‰€æœ‰èŠ‚ç‚¹,å¦‚æœå…¶ä¸­æœ‰ä¸€äº›èŠ‚ç‚¹ä¸å†è¢«ä»»ä½•æŒ‡é’ˆæ‰€æŒ‡æ¶‰,å³å¯å®‰å…¨åˆ é™¤</span>
            <span class="token function">reclaim_later</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-delete">delete</span> old_head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delete_nodes_with_no_hazards</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//get_hazard_pointer_for_current_thread()çš„ç®€å•å®ç°</span>
<span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> max_hazard_pointers<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">hazard_pointer</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>id<span class="token operator">&gt;</span>id<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">*</span><span class="token operator">&gt;</span> pointer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
hazard_pointer hazard_pointers<span class="token punctuation">[</span>max_hazard_pointers<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">hp_owner</span>
<span class="token punctuation">{</span>
    hazard_pointer <span class="token operator">*</span> hp<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">hp_owner</span><span class="token punctuation">(</span>hp_owner <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    hp_owner<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>hp_owner <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    <span class="token function">hp_owner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">hp</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>max_hazard_pointers<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>tread<span class="token double-colon punctuation">::</span>id old_id<span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>hazard_pointers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_id<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                hp<span class="token operator">=</span><span class="token operator">&amp;</span>hazard_pointers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>hp<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-throw">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"No hazard pointers available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">get_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> hp<span class="token operator">-&gt;</span>pointer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">hp_owner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        hp<span class="token operator">-&gt;</span>pointer<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hp<span class="token operator">-&gt;</span>id<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">get_hazard_pointer_for_current_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-thread_local">thread_local</span> <span class="token keyword keyword-static">static</span> hp_owner hazard<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> hazard<span class="token punctuation">.</span><span class="token function">get_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-bool">bool</span> <span class="token function">outstanding_hazard_pointers_for</span><span class="token punctuation">(</span>node<span class="token operator">*</span> p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>max_hazard_pointers<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>hazard_pointers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pointer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>p<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//èŠ‚ç‚¹å›æ”¶å‡½æ•°çš„ä¸€ç§ç®€å•å®ç°</span>
<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">do_delete</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token operator">*</span> p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-delete">delete</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">data_to_reclaim</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-void">void</span><span class="token operator">*</span> data<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> deleter<span class="token punctuation">;</span>
    data_to_reclaim<span class="token operator">*</span> next<span class="token punctuation">;</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
    data_to_reclaim<span class="token operator">*</span> next<span class="token punctuation">;</span>
    <span class="token function">data_to_reclaim</span><span class="token punctuation">(</span>T<span class="token operator">*</span> p<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">data</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">deleter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>do_delete<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">data_to_reclaim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">deleter</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>data_to_reclaim<span class="token operator">*</span><span class="token operator">&gt;</span> nodes_to_reclaim<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">add_to_reclaim_list</span><span class="token punctuation">(</span>data_to_reclaim<span class="token operator">*</span> node<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> nodes_to_reclaim<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>nodes_to_reclaim<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">reclaim_later</span><span class="token punctuation">(</span>T<span class="token operator">*</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">add_to_reclaim_list</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token function">data_to_reclaim</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">delete_nodes_with_no_hazards</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    data_to_reclaim <span class="token operator">*</span> current <span class="token operator">=</span> 
    nodes_to_reclaim<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        data_to_reclaim <span class="token operator">*</span> <span class="token keyword keyword-const">const</span> next <span class="token operator">=</span> current<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">outstanding_hazard_pointers_for</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-delete">delete</span> current<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">add_to_reclaim_list</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        current <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_stack</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> next<span class="token punctuation">;</span>
            <span class="token function">node</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data_<span class="token punctuation">)</span><span class="token operator">:</span>
            <span class="token function">data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span>
            <span class="token keyword keyword-const">const</span> new_node<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>node<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_node<span class="token operator">-&gt;</span>next<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">atomic_load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>std<span class="token double-colon punctuation">::</span><span class="token function">atomic_compare_exchange_weak</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>head<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>new_node<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>node<span class="token operator">&gt;</span> old_head<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">atomic_load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>old_head <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>std<span class="token double-colon punctuation">::</span><span class="token function">atomic_compare_exchange_weak</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>head<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>old_head<span class="token punctuation">,</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span><span class="token function">atomic_store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>node<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">lock_free_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æŒ‰åˆ†ç¦»å¼•ç”¨è®¡æ•°çš„æ–¹å¼å‘æ— é”æ ˆå®¹å™¨å‹å…¥èŠ‚ç‚¹<br>
å†…å¤–ä¸¤ä¸ªè®¡æ•°å™¨ä¹‹å’Œå³ä¸ºèŠ‚ç‚¹çš„æ€»å¼•ç”¨æ•°ç›®<br>
å¤–éƒ¨è®¡æ•°å™¨æ¯å½“æŒ‡é’ˆè¢«è¯»å–æ—¶è‡ªå¢,å†…éƒ¨è®¡æ•°å™¨æ¯å½“è¯»å–æ“ä½œå®Œæˆè€Œè‡ªå‡</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_stack</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">counted_node_ptr</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-int">int</span> external_count<span class="token punctuation">;</span>
            node<span class="token operator">*</span> ptr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-int">int</span><span class="token operator">&gt;</span> internal_count<span class="token punctuation">;</span>
            counted_node_ptr next<span class="token punctuation">;</span>
            <span class="token function">node</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data_<span class="token punctuation">)</span><span class="token operator">:</span>
            <span class="token function">data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">internal_count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>counted_node_ptr<span class="token operator">&gt;</span> head<span class="token punctuation">;</span>

        <span class="token keyword keyword-void">void</span> <span class="token function">increase_head_count</span><span class="token punctuation">(</span>counted_node_ptr<span class="token operator">&amp;</span> old_counter<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            counted_node_ptr new_counter<span class="token punctuation">;</span>
            <span class="token keyword keyword-do">do</span><span class="token punctuation">{</span>
                new_counter <span class="token operator">=</span> old_counter<span class="token punctuation">;</span>
                <span class="token operator">++</span>new_counter<span class="token punctuation">.</span>external_count<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_counter<span class="token punctuation">,</span>new_counter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯¹æ¯”ä¸¤ä¸ªæœºæ„ä½“,äºŒè€…ptrå‡æŒ‡å‘å¤´ç»“ç‚¹,ä½†external_countä¸åŒ,åˆ¤å®šheadæŒ‡é’ˆæ˜¯å¦åŒæ—¶è¢«åˆ«çš„çº¿ç¨‹æ”¹åŠ¨è¿‡,å¦‚æœä¸¤ä¸ªç»“æ„ä½“ç›¸ç­‰,å°±æŠŠè®¡æ•°å™¨è‡ªå¢åçš„æ–°å€¼èµ‹äºˆhead</span>
            old_counter<span class="token punctuation">.</span>external_count<span class="token operator">=</span>new_counter<span class="token punctuation">.</span>external_count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token operator">~</span><span class="token function">lock_free_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            counted_node_ptr new_node<span class="token punctuation">;</span>
            new_node<span class="token punctuation">.</span>ptr<span class="token operator">=</span><span class="token keyword keyword-new">new</span> <span class="token function">node</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_node<span class="token punctuation">.</span>external_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            new_node<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span>next<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>new_node<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            counted_node_ptr old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">increase_head_count</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> ptr<span class="token operator">=</span>old_head<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ptr<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_head<span class="token punctuation">,</span>ptr<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//è‹¥å¤±è´¥,åˆ™è¡¨æ˜æ­¤æ—¶æœ‰å¦ä¸€çº¿ç¨‹åŒæ—¶å¼¹å‡ºèŠ‚ç‚¹,ä¸”å…ˆäºæœ¬çº¿ç¨‹å®Œæˆ,æˆ–æœ‰å¦ä¸€çº¿ç¨‹åŒæ—¶å‘æ ˆå®¹å™¨å‹å…¥æ–°èŠ‚ç‚¹,ä¹Ÿå…ˆäºæœ¬çº¿ç¨‹å®Œæˆ,æ­¤æ—¶old_headæŒ‡å‘çš„èŠ‚ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤,æ‰€ä»¥éœ€è¦é‡æ–°è¯»å–headæŒ‡é’ˆ</span>
                <span class="token punctuation">{</span>
                    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> res<span class="token punctuation">;</span>
                    res<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€šè¿‡swapå°†æ•°æ®ä»èŠ‚ç‚¹ä¸­æå–å‡ºæ¥,ä»è€Œç¡®ä¿åœ¨å¼¹å‡ºå®Œæˆåæ•°æ®é¡¹æ— æ³•è¢«å…¶ä»–çº¿ç¨‹æŒ‡æ¶‰</span>
                    <span class="token keyword keyword-int">int</span> <span class="token keyword keyword-const">const</span> count_increase<span class="token operator">=</span>old_head<span class="token punctuation">.</span>external_count<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token comment">//å†…éƒ¨è®¡æ•°å™¨çš„å¢é‡æ˜¯å¤–éƒ¨è®¡æ•°å™¨çš„æ—§å€¼å‡2,å¤´èŠ‚ç‚¹å¼¹å‡ºæ ˆå®¹å™¨ï¼Œæ­¤æ—¶-1ï¼Œè€Œå½“å‰çº¿ç¨‹ä¸å†è®¿é—®è¯¥èŠ‚ç‚¹,æ‰€ä»¥å¤–éƒ¨è®¡æ•°å™¨å†-1</span>
                    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>internal_count<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span>count_increase<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span>count_increase<span class="token punctuation">)</span><span class="token comment">//fetch_addå°†èŠ‚ç‚¹å¤–éƒ¨å¼•ç”¨è®¡æ•°å™¨çš„æ–°å€¼åŠ åˆ°å†…éƒ¨å¼•ç”¨è®¡æ•°ä¸Š,è‹¥å†…éƒ¨å¼•ç”¨è®¡æ•°å€¼å˜ä¸º0,åˆ™å…¶åŸå€¼çš„è¿”å›å€¼æ˜¯æ–°çš„å¤–éƒ¨å¼•ç”¨è®¡æ•°å€¼çš„ç›¸åæ•°,é‚å¯åˆ é™¤èŠ‚ç‚¹</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword keyword-delete">delete</span> ptr<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>internal_count<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//è‹¥å½“å‰çº¿ç¨‹å¼¹å‡ºèŠ‚ç‚¹å¤±è´¥,åˆ™å®ƒä¸ä¼šå†è®¿é—®è¯¥èŠ‚ç‚¹,æˆ‘ä»¬é‚ä»¤å…¶å¼•ç”¨è®¡æ•°è‡ªå‡,å¦‚æœå½“å‰çº¿ç¨‹è¯•å›¾å¼¹å‡ºè¿™ä¸ªèŠ‚ç‚¹å´æ“ä½œå¤±è´¥,åˆ™å®ƒä¸ä¼šå†è®¿é—®è¯¥èŠ‚ç‚¹,æˆ‘ä»¬å°±ä»¤å…¶å¼•ç”¨è®¡æ•°è‡ªå‡</span>
                <span class="token comment">//å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªæŒæœ‰æŒ‡é’ˆçš„çº¿ç¨‹,åˆ™å…¶å†…éƒ¨å¼•ç”¨è®¡æ•°ä¼šå˜ä¸º1,å†å‡1ä¼šä½¿è®¡æ•°æ¸…é›¶æ‰€ä»¥åˆ é™¤èŠ‚ç‚¹å†ç»§ç»­å¾ªç¯</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword keyword-delete">delete</span> ptr<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><p>åªè¦æˆ‘ä»¬è½½å…¥headæŒ‡é’ˆ,å°±å¿…é¡»é¦–å…ˆä»¤å¤´èŠ‚ç‚¹çš„å¤–éƒ¨å¼•ç”¨è®¡æ•°è‡ªå¢,ä»¥è¡¨æ˜å®ƒæ­£åœ¨è¢«æŒ‡æ¶‰//å†…éƒ¨è®¡æ•°å™¨çš„å¢é‡æ˜¯å¤–éƒ¨è®¡æ•°å™¨çš„æ—§å€¼å‡2,å¤´èŠ‚ç‚¹å¼¹å‡ºæ ˆå®¹å™¨ï¼Œæ­¤æ—¶-1ï¼Œè€Œå½“å‰çº¿ç¨‹ä¸å†è®¿é—®è¯¥èŠ‚ç‚¹,æ‰€ä»¥å¤–éƒ¨è®¡æ•°å™¨å†-1</p>
<h4 id="å®ç°çº¿ç¨‹å®‰å…¨çš„æ— é”é˜Ÿåˆ—">å®ç°çº¿ç¨‹å®‰å…¨çš„æ— é”é˜Ÿåˆ— </h4>
<p>ä»…èƒ½æœåŠ¡å•ä¸€ç”Ÿäº§è€…å’Œå•ä¸€æ¶ˆè´¹è€…çš„æ— é”é˜Ÿåˆ—</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
            node<span class="token operator">*</span> next<span class="token punctuation">;</span>
            <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>node<span class="token operator">*</span><span class="token operator">&gt;</span> head<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>node<span class="token operator">*</span><span class="token operator">&gt;</span> tail<span class="token punctuation">;</span>
        node<span class="token operator">*</span> <span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_head<span class="token operator">==</span>tail<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            head<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> old_head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">lock_free_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">tail</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">lock_free_queue</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> lock_free_queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        lock_free_queue<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> lock_free_queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">lock_free_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                head<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-delete">delete</span> old_head<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> old_head<span class="token operator">=</span><span class="token function">pop_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>old_head<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token function">res</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>old_head<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-delete">delete</span> old_head<span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> res
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">new_data</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            node<span class="token operator">*</span> p<span class="token operator">=</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">;</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> old_tail<span class="token operator">=</span>tail<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            old_tail<span class="token operator">-&gt;</span>data<span class="token operator">=</span>new_data<span class="token punctuation">;</span>
            old_tail<span class="token operator">-&gt;</span>next<span class="token operator">=</span>p<span class="token punctuation">;</span>
            tail<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä¸Šé¢çš„ä»£ç ä»…æ”¯æŒå•ç”Ÿäº§è€…å’Œå•æ¶ˆè´¹è€…æ¨¡å¼,è‹¥è¦æ”¯æŒå¤šç”Ÿäº§è€…å’Œå¤šæ¶ˆè´¹è€…æ¨¡å¼åˆ™éœ€è¿›ä¸€æ­¥ä¿®æ”¹</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">new_data</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token function">T</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    counted_node_ptr new_next<span class="token punctuation">;</span>
    new_next<span class="token punctuation">.</span>ptr<span class="token operator">=</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">;</span>
    new_next<span class="token punctuation">.</span>external_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> old_tail<span class="token operator">=</span> tail<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        T<span class="token operator">*</span> old_data<span class="token operator">=</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_tail<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_data<span class="token punctuation">,</span>new_data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//è‹¥å°¾èŠ‚ç‚¹æ²¡æœ‰æ•°æ®,åˆ™å°†æ–°æ•°æ®æ”¾å…¥å°¾èŠ‚ç‚¹</span>
        <span class="token punctuation">{</span>
            old_tail<span class="token operator">-&gt;</span>next<span class="token operator">=</span>new_next<span class="token punctuation">;</span>
            tail<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>new_next<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_data<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å®ç°æ— é”é˜Ÿåˆ—çš„push()åŠŸèƒ½,å…¶ä¸­å¯¹å°¾èŠ‚ç‚¹è¿›è¡Œå¼•ç”¨è®¡æ•°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">counted_node_ptr</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-int">int</span> external_count<span class="token punctuation">;</span>
            node<span class="token operator">*</span> ptr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>counted_node_ptr<span class="token operator">&gt;</span>head<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>counted_node_ptr<span class="token operator">&gt;</span>tail<span class="token punctuation">;</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node_counter</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-unsigned">unsigned</span> internal_count<span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-unsigned">unsigned</span> external_counters<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//         ä½åŸŸï¼ˆbit fieldï¼‰:</span>

<span class="token comment">// å†’å·ï¼ˆ:ï¼‰åé¢çš„æ•°å­—è¡¨ç¤ºè¯¥å˜é‡å ç”¨çš„ä½æ•°ã€‚</span>
<span class="token comment">// internal_count:30 è¡¨ç¤º internal_count å ç”¨ 30 ä½ã€‚</span>
<span class="token comment">// external_count:2 è¡¨ç¤º external_count å ç”¨ 2 ä½ã€‚</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>node_counter<span class="token operator">&gt;</span> count<span class="token punctuation">;</span>
            counted_node_ptr next<span class="token punctuation">;</span>
            <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                node_counter new_count<span class="token punctuation">;</span>
                new_count<span class="token punctuation">.</span>internal_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                new_count<span class="token punctuation">.</span>external_counters<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
                count<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>new_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span>ptr<span class="token operator">=</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span>external_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
            <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">new_data</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token function">T</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                counted_node_ptr new_next<span class="token punctuation">;</span>
                new_next<span class="token punctuation">.</span>node_ptr new_next<span class="token punctuation">;</span>
                new_next<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> node<span class="token punctuation">;</span>
                new_next<span class="token punctuation">.</span>external_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">increase_external_count</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    T<span class="token operator">*</span> old_data<span class="token operator">=</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_data<span class="token punctuation">,</span>new_data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        old_tail<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span>next<span class="token operator">=</span>new_next<span class="token punctuation">;</span>
                        old_tail<span class="token operator">=</span>tail<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>new_next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">free_external_counter</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        new_data<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    
                    <span class="token punctuation">}</span>
                    old_tail<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span><span class="token function">release_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä»æ— é”é˜Ÿåˆ—å¼¹å‡ºå°¾èŠ‚ç‚¹,è¯¥å°¾èŠ‚ç‚¹é‡‡å–äº†å¼•ç”¨è®¡æ•°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-void">void</span> <span class="token function">release_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            counted_node_ptr old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">increase_external_count</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> ptr<span class="token operator">=</span>old_head<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>ptr<span class="token operator">==</span>tail<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    ptr<span class="token operator">-&gt;</span><span class="token function">release_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_head<span class="token punctuation">,</span>ptr<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    T<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> res<span class="token operator">=</span>ptr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">free_external_counter</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ptr<span class="token operator">-&gt;</span><span class="token function">release_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨æ— é”é˜Ÿåˆ—ä¸­é’ˆå¯¹æŸèŠ‚ç‚¹çš„é‡Šæ”¾å¼•ç”¨</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-void">void</span> <span class="token function">release_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                node_counter old_count<span class="token operator">=</span>count<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                node_counter new_count<span class="token punctuation">;</span>
                <span class="token keyword keyword-do">do</span><span class="token punctuation">{</span>
                    <span class="token keyword keyword-new">new</span> counter<span class="token operator">=</span>old_count<span class="token punctuation">;</span>
                    <span class="token operator">--</span>new_counter<span class="token punctuation">.</span>internal_count<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_count<span class="token punctuation">,</span>new_counter<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>new_counter<span class="token punctuation">.</span>internal_count<span class="token operator">&amp;&amp;</span><span class="token operator">!</span>new_counter<span class="token punctuation">.</span>external_counters<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword keyword-delete">delete</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>åœ¨æ— é”é˜Ÿåˆ—ä¸­é’ˆå¯¹æŸèŠ‚ç‚¹è·å–æ–°å¼•ç”¨</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">increase_external_count</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>counted_node_ptr<span class="token operator">&gt;</span><span class="token operator">&amp;</span> counter<span class="token punctuation">,</span>counted_node_ptr<span class="token operator">&amp;</span> old_counter<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            counted_node_ptr new_counter<span class="token punctuation">;</span>
            <span class="token keyword keyword-do">do</span><span class="token punctuation">{</span>
                new_counter<span class="token operator">=</span>old_counter<span class="token punctuation">;</span>
                <span class="token operator">++</span>new_counter<span class="token punctuation">.</span>external_count<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>counter<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_counter<span class="token punctuation">,</span>new_counter<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            old_counter<span class="token punctuation">.</span>external_count<span class="token operator">=</span>new_counter<span class="token punctuation">.</span>external_count<span class="token punctuation">;</span>
        
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>é’ˆå¯¹æ— é”é˜Ÿåˆ—çš„èŠ‚ç‚¹é‡Šæ”¾å…¶å¤–éƒ¨è®¡æ•°å™¨</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">free_external_counter</span><span class="token punctuation">(</span>counted_node_ptr<span class="token operator">&amp;</span> old_node_ptr<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> ptr<span class="token operator">=</span>old_node_ptr<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
            <span class="token keyword keyword-int">int</span> <span class="token keyword keyword-const">const</span> count_increase<span class="token operator">=</span>old_node_ptr<span class="token punctuation">.</span>external_count<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
            node_counter new_counter<span class="token punctuation">;</span>
            <span class="token keyword keyword-do">do</span><span class="token punctuation">{</span>
                new_counter <span class="token operator">=</span> old_counter<span class="token punctuation">;</span>
                <span class="token operator">--</span>new_counter<span class="token punctuation">.</span>external_counters<span class="token punctuation">;</span>
                new_counter<span class="token punctuation">.</span>internal_count<span class="token operator">+=</span>count_increase<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>ptr<span class="token operator">-&gt;</span>count<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_counter<span class="token punctuation">,</span>new_counter<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>new_counter<span class="token punctuation">.</span>internal_count<span class="token operator">&amp;&amp;</span><span class="token operator">!</span>new_counter<span class="token punctuation">.</span>external_counters<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-delete">delete</span> ptr<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ç»è¿‡ä¿®æ”¹çš„pop()å¯ä»¥ååŠ©é˜Ÿåˆ—çš„push()æ“ä½œ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">node</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>node_counter<span class="token operator">&gt;</span> count<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>counted_node_ptr<span class="token operator">&gt;</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            counted_node_ptr old_head<span class="token operator">=</span>head<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">increase_external_count</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> ptr<span class="token operator">=</span>old_head<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>ptr<span class="token operator">==</span>tail<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                counted_node_ptr next<span class="token operator">=</span>ptr<span class="token operator">-&gt;</span>next<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_head<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    T<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> res<span class="token operator">=</span>ptr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">free_external_counter</span><span class="token punctuation">(</span>old_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ptr<span class="token operator">-&gt;</span><span class="token function">release_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æ— é”é˜Ÿåˆ—ä¸­çš„push()èŒƒä¾‹,å®ƒèƒ½æ¥å—å¦ä¸€çº¿ç¨‹çš„ååŠ©</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">lock_free_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">set_new_tail</span><span class="token punctuation">(</span>counted_node_ptr<span class="token operator">&amp;</span>old_tail<span class="token punctuation">,</span>counted_node_ptr <span class="token operator">&amp;</span>new_tail<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            node<span class="token operator">*</span> <span class="token keyword keyword-const">const</span> current_tail_ptr<span class="token operator">=</span>old_tail<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>tail<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">,</span>new_tail<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>old_tail<span class="token punctuation">.</span>ptr<span class="token operator">==</span>current_tail_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">.</span>ptr<span class="token operator">!=</span>current_tail_ptr<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">free_external_counter</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span>
            <span class="token punctuation">{</span>
                current_tail_ptr<span class="token operator">-&gt;</span><span class="token function">release_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>T new_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">new_data</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token function">T</span><span class="token punctuation">(</span>new_value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            counted_node_ptr new_next<span class="token punctuation">;</span>
            new_next<span class="token punctuation">.</span>ptr<span class="token operator">=</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">;</span>
            new_next<span class="token punctuation">.</span>external_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            counted_node_ptr old_tail<span class="token operator">=</span>tail<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">increase_external_count</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span>old_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
                T <span class="token operator">*</span> old_data<span class="token operator">=</span><span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_data<span class="token punctuation">,</span>new_data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    counted_node_ptr old_next<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>old_tail<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span>next<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_next<span class="token punctuation">,</span>new_next<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword keyword-delete">delete</span> new_next<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
                        new_next<span class="token operator">=</span>old_next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">set_new_tail</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">,</span>new_next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    new_data<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-else">else</span>
                <span class="token punctuation">{</span>
                    counted_node_ptr old_next<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>old_tail<span class="token punctuation">.</span>ptr<span class="token operator">-&gt;</span>next<span class="token punctuation">.</span><span class="token function">compare_exchange_strong</span><span class="token punctuation">(</span>old_next<span class="token punctuation">,</span>new_next<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        old_next<span class="token operator">=</span>new_next<span class="token punctuation">;</span>
                        new_next<span class="token punctuation">.</span>ptr<span class="token operator">=</span><span class="token keyword keyword-new">new</span> node<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">set_new_tail</span><span class="token punctuation">(</span>old_tail<span class="token punctuation">,</span>old_next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="å®ç°æ— é”æ•°æ®ç»“æ„çš„åŸåˆ™">å®ç°æ— é”æ•°æ®ç»“æ„çš„åŸåˆ™ </h3>
<h4 id="åŸåˆ™1åœ¨åŸå‹è®¾è®¡ä¸­ä½¿ç”¨stdmemory_order_seq_cstæ¬¡åº">åŸåˆ™1ï¼šåœ¨åŸå‹è®¾è®¡ä¸­ä½¿ç”¨std::memory_order_seq_cstæ¬¡åº </h4>
<p>è‹¥ä»£ç æœä»std::memory_order_seq_cstæ¬¡åº,ä¼šä»¤å…¨éƒ¨æ“ä½œå½¢æˆä¸€ä¸ªç¡®å®šçš„æ€»åºåˆ—ã€‚</p>
<h4 id="åŸåˆ™2ä½¿ç”¨æ— é”çš„å†…å­˜å›æ”¶æ–¹æ¡ˆ">åŸåˆ™2ï¼šä½¿ç”¨æ— é”çš„å†…å­˜å›æ”¶æ–¹æ¡ˆ </h4>
<ol>
<li>æš‚ç¼“å…¨éƒ¨åˆ é™¤å¯¹è±¡çš„åŠ¨ä½œ,ç­‰åˆ°æ²¡æœ‰çº¿ç¨‹è®¿é—®æ•°æ®ç»“æ„çš„æ—¶å€™,æ‰åˆ é™¤å¾…é”€æ¯çš„å¯¹è±¡</li>
<li>é‡‡ç”¨é£é™©æŒ‡é’ˆ,ä»¥è¾¨è¯†ç‰¹å®šå¯¹è±¡æ˜¯å¦æ­£åœ¨è¢«æŸçº¿ç¨‹è®¿é—®,å°±å¯¹è±¡è¿›è¡Œå¼•ç”¨è®¡æ•°,åªè¦å¤–éƒ¨ç¯å¢ƒæ­£åœ¨æŒ‡æ¶‰ç›®æ ‡å¯¹è±¡,å®ƒå°±ä¸ä¼šè¢«åˆ é™¤</li>
<li>å°±å¯¹è±¡è¿›è¡Œå¼•ç”¨è®¡æ•°,åªè¦å¤–éƒ¨ç¯å¢ƒä»åœ¨æŒ‡æ¶‰ç›®æ ‡å¯¹è±¡,å®ƒå°±ä¸ä¼šè¢«åˆ é™¤</li>
</ol>
<h4 id="åŸåˆ™3-é˜²èŒƒabaé—®é¢˜">åŸåˆ™3: é˜²èŒƒABAé—®é¢˜ </h4>
<p>é—®é¢˜äº§ç”Ÿè¿‡ç¨‹å¦‚ä¸‹:</p>
<ol>
<li>çº¿ç¨‹ç”²è¯»å–åŸå­å˜é‡x,å¾—çŸ¥å…¶å€¼ä¸ºA</li>
<li>çº¿ç¨‹ç”²æ ¹æ®Aæ‰§è¡ŒæŸé¡¹æ“ä½œ,æ¯”å¦‚æŸ¥æ‰¾,æˆ–å¦‚æœxæ˜¯æŒ‡é’ˆï¼Œåˆ™ä¾æ®å®ƒæå–å‡ºç›¸å…³å€¼(ç§°ä¸ºov)</li>
<li>çº¿ç¨‹ç”²å› æ“ä½œç³»ç»Ÿè°ƒåº¦è€Œå‘ç”Ÿé˜»å¡</li>
<li>å¦ä¸€çº¿ç¨‹å¯¹åŸå­å˜é‡xæ‰§è¡Œåˆ«çš„æ“ä½œ,å°†å…¶å€¼æ”¹æˆB</li>
<li>åˆæœ‰çº¿ç¨‹æ”¹å˜äº†ä¸Aç›¸å…³çš„æ•°æ®,æ˜¯çš„çº¿ç¨‹ç”²åŸæœ¬æŒæœ‰çš„å€¼å¤±æ•ˆ,ï¼ˆè¿™ç§æƒ…å½¢è‚¯å‘¢ä¸ªä¸ºAè¡¨ç¤ºæŸå†…å­˜åœ°å€ï¼Œè€Œæ”¹åŠ¨æ“ä½œåˆ™æ˜¯é‡Šæ”¾æŒ‡é’ˆçš„ç›®æ ‡å†…å­˜ï¼Œæˆ–å˜æ›´ç›®æ ‡æ•°æ®ï¼Œæœ€åå°†äº§ç”Ÿä¸¥é‡åæœ</li>
<li>åŸå­å˜é‡xå†æ¬¡è¢«æŸçº¿ç¨‹æ”¹åŠ¨ï¼Œé‡æ–°å˜å›A,è‹¥xå±äºæŒ‡é’ˆå‹åˆ«,å…¶æŒ‡å‘ç›®æ ‡å¯èƒ½åœ¨æ­¥éª¤5è¢«æ”¹æ¢æˆä¸€ä¸ªæ–°å¯¹è±¡</li>
<li>çº¿ç¨‹ç”²ç»§ç»­è¿è¡Œ,åœ¨åŸå­å˜é‡xä¸Šæ‰§è¡Œæ¯”è¾ƒäº¤æ¢æ“ä½œ,ä¸Aè¿›è¡Œå¯¹æ¯”ï¼Œå› æ­¤æ¯”è¾ƒæ“ä½œæˆåŠŸï¼ˆå› xçš„å€¼ä¾ç„¶ä¸ºAï¼‰ï¼Œä½†æ­¥éª¤2ä¸­çš„ovå·²ç»å¤±æ•ˆ,è€Œçº¿ç¨‹ç”²å´æ— ä»åˆ†è¾¨,è¿™å°†ç ´åæ•°æ®ç»“æ„</li>
</ol>
<h4 id="åŸåˆ™4æ‰¾å‡ºå¿™ç­‰å¾ªç¯ååŠ©å…¶ä»–çº¿ç¨‹">åŸåˆ™4ï¼šæ‰¾å‡ºå¿™ç­‰å¾ªç¯,ååŠ©å…¶ä»–çº¿ç¨‹ </h4>
<p>é˜»å¡å‹æ“ä½œä¸ä½¿ç”¨äº’æ–¥å’Œé”ä¸€æ ·,ä¸‰è€…å‡æœ‰å¯èƒ½ä»¥å¿™ç­‰å¾ªç¯çš„æ–¹å¼å¾ªç¯<br>
å‡è®¾æŒ‰ç…§è°ƒåº¦å®‰æ’,æŸçº¿ç¨‹å…ˆå¼€å§‹æ‰§è¡Œ,å´å› å¦ä¸€çº¿ç¨‹çš„æ“ä½œè€Œæš‚åœç­‰å¾…,é‚£ä¹ˆåªè¦æˆ‘ä»¬ä¿®æ”¹æ“ä½œçš„ç®—æ³•,å°±èƒ½è®©å‰è€…å…ˆå®Œæˆå…¨éƒ¨æ­¥éª¤,ä»è€Œé¿å…å¿™ç­‰ï¼šè¿™è¦æ±‚å°†éåŸå­å˜é‡çš„æ•°æ®æˆå‘˜æ”¹ä¸ºåŸå­å˜é‡,å¹¶é‡‡ç”¨æ¯”è¾ƒ-äº¤æ¢æ“ä½œè®¾ç½®å…¶å€¼</p>
<hr>
<h2 id="è®¾è®¡å¹¶å‘ä»£ç ">è®¾è®¡å¹¶å‘ä»£ç  </h2>
<h3 id="åœ¨çº¿ç¨‹é—´åˆ‡åˆ†ä»»åŠ¡çš„æ–¹æ³•">åœ¨çº¿ç¨‹é—´åˆ‡åˆ†ä»»åŠ¡çš„æ–¹æ³• </h3>
<ol>
<li>
<p>å…ˆåœ¨çº¿ç¨‹é—´åˆ‡åˆ†æ•°æ®,å†å¼€å§‹å¤„ç†</p>
</li>
<li>
<p>ä»¥é€’å½’æ–¹å¼åˆ’åˆ†æ•°æ®</p>
</li>
</ol>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">Parallel_Quick_Sort_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Parallel_Quick_Sort_HPP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.shared_mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.future.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"thread_safe_stack.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span>


<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">sorter</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">chunk_to_sort</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    thread_safe_stack<span class="token operator">&lt;</span>chunk_to_sort<span class="token operator">&gt;</span> chunks<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> threads<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> max_thread_count<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> end_of_data<span class="token punctuation">;</span>
    <span class="token function">sorter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">max_thread_count</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">end_of_data</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">sorter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        end_of_data <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>threads<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">try_sort_chunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>chunk_to_sort<span class="token operator">&gt;</span> chunk <span class="token operator">=</span> chunks<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">sort_chunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">do_sort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>chunk_data<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>chunk_data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> chunk_data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> result<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>chunk_data<span class="token punctuation">,</span>chunk_data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> partition_val <span class="token operator">=</span> <span class="token operator">*</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-typename">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>iterator divide_point<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">partition</span><span class="token punctuation">(</span>chunk_data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>chunk_data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> val<span class="token operator">&lt;</span>partition_val<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chunk_to_sort new_lower_chunk<span class="token punctuation">;</span>
        new_lower_chunk<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>new_lower_chunk<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>chunk_data<span class="token punctuation">,</span>chunk_data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>divide_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> lower_future <span class="token operator">=</span> new_lower_chunk<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_lower_chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>threads<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>max_thread_count<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sorter<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>sort_thread<span class="token punctuation">,</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">new_higher</span><span class="token punctuation">(</span><span class="token function">do_sort</span><span class="token punctuation">(</span>chunk_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_higher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>new_lower<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>std<span class="token double-colon punctuation">::</span>future_status<span class="token double-colon punctuation">::</span>ready<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">try_sort_chunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_lower<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">sort_chunk</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>chunk_to_sort<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> chunk<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        chunk<span class="token operator">-&gt;</span>promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token function">do_sort</span><span class="token punctuation">(</span>chunk<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">sort_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>end_of_data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">try_sort_chunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">parallel_quick_sort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    
   <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> data<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   sorter<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> sorter<span class="token punctuation">;</span>
   <span class="token keyword keyword-return">return</span> sorter<span class="token punctuation">.</span><span class="token function">do_sort</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// Parallel_Quick_Sort_HPP</span></span>
</code></pre><ol start="3">
<li>ä¾æ®å·¥ä½œç±»åˆ«åˆ’åˆ†ä»»åŠ¡</li>
</ol>
<h3 id="å½±å“å¹¶å‘ä»£ç æ€§èƒ½çš„å› ç´ ">å½±å“å¹¶å‘ä»£ç æ€§èƒ½çš„å› ç´  </h3>
<ol>
<li>å¤„ç†å™¨æ•°é‡</li>
<li>æ•°æ®ç«äº‰å’Œç¼“å­˜ä¹’ä¹“ï¼š<br>
ä¾‹å¦‚fetch_and_addæ“ä½œ,å¹¶é‡‡ç”¨äº†std::memory_order_relaxedå†…å­˜æ¬¡åº,å¦‚æœä¿©ä¸ªçº¿ç¨‹åœ¨ä¸¤ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œç›¸åŒçš„ä»£ç ,ä¸¤ä¸ªå¤„ç†å™¨çš„ç¼“å­˜ä¸­å°†åˆ†åˆ«å½¢æˆå˜é‡counterçš„å‰¯æœ¬,å®ƒä»¬å¿…é¡»åœ¨ä¸¤ä¸ªå¤„ç†å™¨ä¹‹é—´æ¥å›ä¼ é€’,ä¸¤è€…æ‰€å«çš„counterå€¼æ‰å¯ä»¥ä¿æŒæœ€æ–°,ä»è€Œæ­£ç¡®æ‰§è¡Œè‡ªå¢æ“ä½œ,å¦‚æœè¿è¡Œä¸Šè¿°ä»£ç çš„å¤„ç†å™¨æ•°é‡è¿‡å¤š,æˆ–è€…æ•°æ®å¤„ç†è¿‡å¿«,å„å¤„ç†å™¨å¯èƒ½å½¼æ­¤ç­‰å¾…<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
my_data data<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">processing_loop_with_mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
     std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">done_processing</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ol>
<p>å‡å®šå¤šä¸ªçº¿ç¨‹è¦è®¿é—®æ•°æ®dataå’Œäº’æ–¥m,é‚£ä¹ˆ,è‹¥ç³»ç»Ÿå…·æœ‰è¶Šå¤šæ ¸å¿ƒæˆ–å¤„ç†å™¨,é«˜åº¦äº‰å¤ºå°±è¶Šå¯èƒ½å‘ç”Ÿ,å³å¤„ç†å™¨å¯èƒ½ç›¸äº’ç­‰å¾…</p>
<ol start="3">
<li>
<p>ä¸ç»æ„å…±äº«<br>
å‡å®šå¤šä¸ªçº¿ç¨‹è¦è®¿é—®ä¸€ä¸ªæ•´å‹æ•°ç»„,å…¶ä¸­å„çº¿ç¨‹éƒ½å…·æœ‰ä¸“å±çš„å…ƒç´ ,ä¸”åªåå¤è¯»å†™è‡ªå·±çš„å…ƒç´ ,ç”±äºæ•´å‹å˜é‡çš„å°ºå¯¸å¾€å¾€æ¯”æ¢å­˜æ¬¾å°å¾ˆå¤š,å› æ­¤åŒä¸€ç¼“å­˜å¿«èƒ½å¤Ÿå®¹çº³å¤šä¸ªæ•°ç»„å…ƒç´ ,ç»“æœ,å°½ç®¡ä¸ªçº¿ç¨‹ä»…è®¿é—®æ•°ç»„ä¸­å±äºè‡ªå·±çš„å…ƒç´ ,ä½†ä»ä¼šè®©ç¡¬ä»¶äº§ç”Ÿç¼“å­˜ä¹’ä¹“é—®é¢˜,åŸå› æ˜¯ä¸€ä¸ªç¼“å­˜å—å†…å¯èƒ½åŒ…å«äº†ä¸¤ä¸ªçº¿ç¨‹æ‰€éœ€è¦çš„å…ƒç´ é›†åˆ,è€Œæ•°æ®ä»¥ç¼“å­˜å—å½¢å¼ä¼ é€’</p>
</li>
<li>
<p>æ•°æ®çš„ç´§å‡‘ç¨‹åº¦<br>
å¤ªç´§å‡‘ä¼šå‘ç”Ÿä¸Šè¿°çš„ä¸ç»æ„å…±äº«é—®é¢˜,è€Œå¤ªç¨€ç–åˆ™ä¼šå¯¼è‡´é—²æ•£æ•°æ®è¿œå¤šäºæœ‰ç”¨æ•°æ®é€ æˆç¼“å­˜æµªè´¹</p>
</li>
<li>
<p>è¿‡åº¦ä»»åŠ¡åˆ‡æ¢ä¸çº¿ç¨‹è¿‡é¥±å’Œ</p>
</li>
</ol>
<h3 id="è®¾è®¡æ•°æ®ç»“æ„ä»¥æå‡å¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½">è®¾è®¡æ•°æ®ç»“æ„ä»¥æå‡å¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½ </h3>
<ol>
<li>é’ˆå¯¹å¤æ‚æ“ä½œçš„æ•°æ®åˆ’åˆ†</li>
<li>å…¶ä»–æ•°æ®ç»“æ„çš„è®¿é—®æ¨¡å¼<br>
å¦‚æœäº’æ–¥ä¸å—ä¿æŠ¤çš„æ•°æ®ä½äºåŒä¸€ç¼“å­˜å—ä¸­,æ­¤æ—¶å…¶ä»–çº¿ç¨‹å†è¯•å›¾åŠ é”,é‚£ä¹ˆåœ¨äº’æ–¥ä¸ŠæŒé”çš„çº¿ç¨‹å°±ä¼šé­å—æ€§èƒ½æŸå¤±,è¦ç¡®å®šè¿™ç§ä¸ç»æ„å…±äº«æ˜¯å¦çœŸçš„æ„æˆé—®é¢˜,å…¶ä¸­ä¸€ç§æµ‹è¯•æ–¹æ³•æ˜¯é’ˆå¯¹ä¸åŒçº¿ç¨‹å¹¶å‘è®¿é—®çš„å„é¡¹æ•°æ®,åœ¨å®ƒä»¬ä¹‹é—´åŠ å…¥å·¨å¤§çš„å¡«å……å—</li>
</ol>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">protected_data</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
    <span class="token keyword keyword-char">char</span> padding<span class="token punctuation">[</span>std<span class="token double-colon punctuation">::</span>hardware_destructive_interference_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    my_data data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>æˆ–è€…,é‡‡ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•,åˆ¤å®šæ•°ç»„å…ƒç´ ä¹‹é—´æ˜¯å¦å­˜åœ¨ä¸ç»æ„çš„å…±äº«</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">protected_data</span>
<span class="token punctuation">{</span>
    data_item1 d1<span class="token punctuation">;</span>
    data_item2 d2<span class="token punctuation">;</span>
    <span class="token keyword keyword-char">char</span> padding<span class="token punctuation">[</span>std<span class="token double-colon punctuation">::</span>hardware_destructive_interference_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
my_data some_array<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><h3 id="è®¾è®¡å¹¶å‘ä»£ç æ—¶é¢å¤–è¦è€ƒè™‘çš„å› ç´ ">è®¾è®¡å¹¶å‘ä»£ç æ—¶é¢å¤–è¦è€ƒè™‘çš„å› ç´  </h3>
<ol>
<li>å¹¶è¡Œç®—æ³•ä»£ç ä¸­çš„å¼‚å¸¸å®‰å…¨</li>
</ol>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">accumulate_block</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>T<span class="token operator">&amp;</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        result<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">accumulate</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
T <span class="token function">parallel_accumulate</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>T init<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>length<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> init<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> max_threads<span class="token operator">=</span><span class="token punctuation">(</span>length<span class="token operator">+</span>min_per_thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>min_per_thread<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> hardware_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> num_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>hardware_threads<span class="token operator">!=</span><span class="token number">0</span><span class="token operator">?</span>hardware_threads<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>max_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> block_size<span class="token operator">=</span>length<span class="token operator">/</span>num_threads<span class="token punctuation">;</span>    
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">results</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> <span class="token function">threads</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator block_start<span class="token operator">=</span>first<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Iterator block_end<span class="token operator">=</span>block_start<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>block_end<span class="token punctuation">,</span>block_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">accumulate_block</span><span class="token generic class-name"><span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>block_start<span class="token punctuation">,</span>block_end<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        block_start<span class="token operator">=</span>block_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token generic-function"><span class="token function">accumulate_block</span><span class="token generic class-name"><span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>last<span class="token punctuation">,</span>results<span class="token punctuation">[</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>threads<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>threads<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">mem_fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>join<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">accumulate</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>results<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ç®—æ³•éœ€è¦è®¡ç®—å‡ºä¸€ä¸ªå€¼å¹¶å°†å…¶è¿”å›,åŒæ—¶å…è®¸ç›¸å…³ä»£ç æŠ›å‡ºå¼‚å¸¸<br>
é‡‡ç”¨std::packaged_taskå’Œstd::futureæ”¹å†™ç®—æ³•</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">accumulate_block</span>  
<span class="token punctuation">{</span>
    T <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span> Iterator last<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">accumulate</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> last<span class="token punctuation">,</span> T<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span> <span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
T <span class="token function">parallel_accumulate</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>T init<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>length<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> init<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> max_threads<span class="token operator">=</span><span class="token punctuation">(</span>length<span class="token operator">+</span>min_per_thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>min_per_thread<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> hardware_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> num_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>hardware_threads<span class="token operator">!=</span><span class="token number">0</span><span class="token operator">?</span>hardware_threads<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>max_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> block_size<span class="token operator">=</span>length<span class="token operator">/</span>num_threads<span class="token punctuation">;</span> 
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> <span class="token function">futures</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> <span class="token function">threads</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator block_start<span class="token operator">=</span>first<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Iterator block_end<span class="token operator">=</span>block_start<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>block_end<span class="token punctuation">,</span>block_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token function">T</span><span class="token punctuation">(</span>Iterator<span class="token punctuation">,</span>Iterator<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>accumulate_block<span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>block_start<span class="token punctuation">,</span>block_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        block_start<span class="token operator">=</span>block_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    T last_result <span class="token operator">=</span> accumulate_block<span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>threads<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>threads<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">mem_fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>join<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    T result<span class="token operator">=</span>init<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        result<span class="token operator">+=</span>futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result<span class="token operator">+</span> <span class="token operator">=</span> last_result<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  
</code></pre><p>ä¸Šé¢çš„ä¿®æ”¹è§£å†³äº†ä¸€ä¸ªæ½œåœ¨é—®é¢˜:å·¥ä½œçº¿ç¨‹æ‰€æŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢«futureæ•è·ï¼Œè½¬è€Œåœ¨ä¸»çº¿ç¨‹ä¸Šé‡æ–°æŠ›å‡º,å‡è®¾æŠ›å‡ºçš„å¼‚å¸¸ä¸æ­¢ä¸€ä¸ª,é‚£å°±åªæœ‰ä¸€ä¸ªå¼‚å¸¸èƒ½å¤Ÿå‘ä¸Šä¼ é€’</p>
<p>ä»ç¬¬ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå¼€å§‹,ç›´åˆ°å…¨éƒ¨æ±‡åˆå®Œæˆå†æœ‰å¼‚å¸¸å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹æ³„éœ²,è§£å†³æ–¹æ³•æ˜¯</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Iterator block_end<span class="token operator">=</span>block_start<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>block_end<span class="token punctuation">,</span>block_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">accumulate_block</span><span class="token generic class-name"><span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>block_start<span class="token punctuation">,</span>block_end<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        block_start<span class="token operator">=</span>block_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token generic-function"><span class="token function">accumulate_block</span><span class="token generic class-name"><span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>last<span class="token punctuation">,</span>results<span class="token punctuation">[</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>threads<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>threads<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">mem_fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span>join<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_threads<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-throw">throw</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>æ›´å¥½çš„è§£å†³åŠæ³•æ˜¯è®¾è®¡ä¸€ä¸ªç±»,æå–å‡ºé‡å¤ä»£ç </p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">join_threads</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span><span class="token operator">&amp;</span> threads<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">join_threads</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span><span class="token operator">&amp;</span> threads_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">threads</span><span class="token punctuation">(</span>threads_<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">join_threads</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>threads<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><ol start="2">
<li>std::asyncçš„çº¿ç¨‹å®‰å…¨<br>
std::asyncä¼šè®©çº¿ç¨‹åº“æ›¿æˆ‘ä»¬ç®¡æ§çº¿ç¨‹,ä»»ä½•ç”Ÿæˆçš„çº¿ç¨‹ä¸€ä½†è¿è¡Œå®Œæˆ,å¯¹åº”çš„futureå³è¿›å…¥å°±ç»ªçŠ¶æ€,å¦‚æœä¸ç­‰futureè¿›å…¥å°±ç»ªçŠ¶æ€å°±å°†å…¶é”€æ¯,futureå¯¹è±¡çš„ææ„å‡½æ•°ä¾ç„¶ä¼šç­‰å¾…æœŸçº¿ç¨‹è¿è¡Œç»“æŸ,å¦åˆ™,çº¿ç¨‹ä»ä¼šè¿è¡Œï¼Œä¸Šé¢çš„ç­‰å¾…å·§å¦™çš„é¿å…äº†çº¿ç¨‹æŒæœ‰æŒ‡å‘å±€éƒ¨æ•°æ®çš„å¼•ç”¨å¯¼è‡´çº¿ç¨‹èµ„æºä¸¢å¤±çš„é—®é¢˜</li>
</ol>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
T <span class="token function">parallel_accumulate</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>T init<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> max_chunk_size<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">&lt;=</span>max_chunk_size<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">accumulate</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">{</span>
        Iterator mid_point<span class="token operator">=</span>first<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>mid_point<span class="token punctuation">,</span>length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> first_half_result<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>parallel_accumulate<span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span>first<span class="token punctuation">,</span>mid_point<span class="token punctuation">,</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
        T second_half_result<span class="token operator">=</span><span class="token function">parallel_accumulate</span><span class="token punctuation">(</span>mid_point<span class="token punctuation">,</span>last<span class="token punctuation">,</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> first_half_result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>second_half_result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å€Ÿå¹¶å‘ç‰¹æ€§æ”¹è¿›ç›¸åº”èƒ½åŠ›<br>
åˆ†ç¦»GUIçº¿ç¨‹å’Œä»»åŠ¡çº¿ç¨‹</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>thread task_thread<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span><span class="token function">task_cancelled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">gui_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        event_data event<span class="token operator">=</span><span class="token function">get_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token operator">==</span>quit<span class="token punctuation">)</span> <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token function">process_event</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">task_completed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span>task_cancelled<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">do_task_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>task_cancelled<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perform_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-else">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">post_gui_event</span><span class="token punctuation">(</span>task_complete<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-void">void</span> <span class="token function">process</span><span class="token punctuation">(</span>event_data <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> event<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-switch">switch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-case">case</span> start_task<span class="token operator">:</span>
            task_thread<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-case">case</span> cancel_task<span class="token operator">:</span>
            task_cancelled<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            task_thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-default">default</span><span class="token operator">:</span>
            <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="å¹¶å‘ä»£ç çš„è®¾è®¡å®è·µ">å¹¶å‘ä»£ç çš„è®¾è®¡å®è·µ </h3>
<p>å¹¶è¡Œç‰ˆstd::for_each</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Func</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">paralllel_for_each</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>Func f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> max_threads<span class="token operator">=</span><span class="token punctuation">(</span>length<span class="token operator">+</span>min_per_thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>min_per_thread<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> hardware_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> num_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>hardware_threads<span class="token operator">!=</span><span class="token number">0</span><span class="token operator">?</span>hardware_threads<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>max_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> block_size<span class="token operator">=</span>length<span class="token operator">/</span>num_threads<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;&gt;</span> <span class="token function">futures</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator block_start<span class="token operator">=</span>first<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Iterator block_end<span class="token operator">=</span>block_start<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>block_end<span class="token punctuation">,</span>block_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span>Iterator<span class="token punctuation">,</span>Iterator<span class="token punctuation">,</span>Func<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>block_end<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        block_start<span class="token operator">=</span>block_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>last<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>é‡‡ç”¨std::asyncæ”¹å†™parallel_for_each</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Func</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">parallel_for_each</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>func f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">*</span>min_per_thread<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-else">else</span>
    <span class="token punctuation">{</span>
        Iterator <span class="token keyword keyword-const">const</span> mid_point<span class="token operator">=</span>first<span class="token operator">+</span>length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;</span> first_half_result<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>parallel_for_each<span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>Func<span class="token operator">&gt;</span><span class="token punctuation">,</span>first<span class="token punctuation">,</span>mid_point<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parallel_for_each</span><span class="token punctuation">(</span>mid_point<span class="token punctuation">,</span>last<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        first_half_result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Func</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">parallel_for_each</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>Func f<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">*</span>min_per_thread<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-else">else</span>
    <span class="token punctuation">{</span>
        Iterator <span class="token keyword keyword-const">const</span> mid_point<span class="token operator">=</span>first<span class="token operator">+</span>length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;</span> first_half_result<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>parallel_for_each<span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>Func<span class="token operator">&gt;</span><span class="token punctuation">,</span>first<span class="token punctuation">,</span>mid_point<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parallel_for_each</span><span class="token punctuation">(</span>mid_point<span class="token punctuation">,</span>last<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        first_half_result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> max_threads<span class="token operator">=</span><span class="token punctuation">(</span>length<span class="token operator">+</span>min_per_thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>min_per_thread<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> hardware_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> num_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>hardware_threads<span class="token operator">!=</span><span class="token number">0</span><span class="token operator">?</span>hardware_threads<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>max_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> block_size<span class="token operator">=</span>length<span class="token operator">/</span>num_threads<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>Iterator<span class="token operator">&gt;</span> result<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> done<span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span><span class="token function">threads</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        join_threads <span class="token function">joiner</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Iterator block_start <span class="token operator">=</span> first<span class="token punctuation">;</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
           Iterator block_end <span class="token operator">=</span> block_start<span class="token punctuation">;</span>
           std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>block_end<span class="token punctuation">,</span>block_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
           threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token function">find_element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>block_start<span class="token punctuation">,</span>block_end<span class="token punctuation">,</span>match<span class="token punctuation">,</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span><span class="token operator">&amp;</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">find_element</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>match<span class="token punctuation">,</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span><span class="token operator">&amp;</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>done_result<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">MatchType</span><span class="token operator">&gt;</span>
Iterator <span class="token function">parallel_find_impl</span><span class="token punctuation">(</span>Iterator begin<span class="token punctuation">,</span> Iterator end<span class="token punctuation">,</span> MatchType match<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> done<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token operator">*</span>min_per_thread<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>first<span class="token operator">!=</span>last <span class="token operator">&amp;&amp;</span><span class="token operator">!</span>done<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>first<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-return">return</span> first<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> last<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">{</span>
            Iterator <span class="token keyword keyword-const">const</span> mid_point <span class="token operator">=</span> first<span class="token operator">+</span><span class="token punctuation">(</span>length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>Iterator<span class="token operator">&gt;</span> async_result <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parallel_find_impl<span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>MatchType<span class="token operator">&gt;</span><span class="token punctuation">,</span>mid_point<span class="token punctuation">,</span>last<span class="token punctuation">,</span>match<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Iterator <span class="token keyword keyword-const">const</span> direct_result<span class="token operator">=</span><span class="token function">parallel_find_impl</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>mid_point<span class="token punctuation">,</span>match<span class="token punctuation">,</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> direct_result<span class="token operator">!=</span>last<span class="token operator">?</span>direct_result<span class="token operator">:</span>async_result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-throw">throw</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">MatchType</span><span class="token operator">&gt;</span>
Iterator <span class="token function">parallel_find</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span> Iterator last<span class="token punctuation">,</span> MatchType match<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">parallel_find_impl</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>match<span class="token punctuation">,</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¹¶è¡ŒåŒ–std::partial_sum<br>
ä»¥åˆ’åˆ†æ•°æ®æ®µè®¡ç®—å‰ç¼€å’Œ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">parallel_partial_sum</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span> Iterator last<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-typedef">typedef</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token double-colon punctuation">::</span>value_type value_type<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">process_chunk</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Iterator begin<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span><span class="token operator">*</span> previous_end_value<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span><span class="token operator">*</span>end_value<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-try">try</span>
            <span class="token punctuation">{</span>
                Iterator end <span class="token operator">=</span> last<span class="token punctuation">;</span>
                <span class="token operator">++</span>end<span class="token punctuation">;</span>
                std<span class="token double-colon punctuation">::</span><span class="token function">partial_sum</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> end<span class="token punctuation">,</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>previous_end_value<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    value_type<span class="token operator">&amp;</span> addend <span class="token operator">=</span> previous_end_value<span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">*</span>last<span class="token operator">+=</span>addend<span class="token punctuation">;</span>
                    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>end_value<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        end_value<span class="token operator">-&gt;</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token operator">*</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span>last<span class="token punctuation">,</span><span class="token punctuation">[</span>addend<span class="token punctuation">]</span><span class="token punctuation">(</span>value_type<span class="token operator">&amp;</span> item<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        item<span class="token operator">+=</span>addend<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>end_value<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    end_value<span class="token operator">-&gt;</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token operator">*</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                                                                                                                            
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>end_value<span class="token punctuation">)</span> end_value<span class="token operator">-&gt;</span><span class="token function">set_exception</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-throw">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> min_per_thread<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> max_threads<span class="token operator">=</span><span class="token punctuation">(</span>length<span class="token operator">+</span>min_per_thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>min_per_thread<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> hardware_threads<span class="token operator">=</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> num_threads<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>hardware_threads<span class="token operator">!=</span><span class="token number">0</span><span class="token operator">?</span>hardware_threads<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>max_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> chunk_size<span class="token operator">=</span>length<span class="token operator">/</span>num_threads<span class="token punctuation">;</span>
    <span class="token keyword keyword-typedef">typedef</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token double-colon punctuation">::</span>value_type value_type<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> <span class="token function">threads</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token function">previous_end_values</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token function">end_values</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    previout_end_values<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join_threads <span class="token function">joiner</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator block_start<span class="token operator">=</span>first<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span>num_threads<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Iterator block_last<span class="token operator">=</span>block_start<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>block_last<span class="token punctuation">,</span>block_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token function">process_chunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>block_start<span class="token punctuation">,</span>block_last<span class="token punctuation">,</span><span class="token punctuation">(</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">&amp;</span>previous_end_values<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>end_values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        block_start<span class="token operator">=</span>block_last<span class="token punctuation">;</span>
        <span class="token operator">++</span>block_start<span class="token punctuation">;</span>
        previous_end_values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>end_values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Iterator final_element <span class="token operator">=</span> block_start<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>final_element<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">process_chunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>final_element<span class="token punctuation">,</span><span class="token punctuation">(</span>num_threads<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">&amp;</span>previous_end_values<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢çš„ä»£ç é€šè¿‡åˆ†æ®µè®¡ç®—å‰ç¼€å’Œ,å†åˆ†æ‰¹åŠ ä¸Šå‰ä¸€æ®µçš„æœ«å°¾å’Œæ¥è®¡ç®—<br>
åˆ«è®¡ç®—å‡º{1,3,6} ã€ {4,9,15} ã€ {7,15,24} ã€‚ç¬¬ä¸€æ®µçš„æœ«é¡¹å€¼<br>
ä¸º 6, æˆ‘ä»¬å°†å®ƒä¸ç¬¬äºŒæ®µçš„ç»“æœé€é¡¹ç›¸åŠ ï¼Œå¾—åˆ° {1, 3, 6} ã€ {10 , 15, 21} ã€ {7, 15 , 24 } ã€‚ ç¬¬<br>
äºŒæ®µçš„æœ«é¡¹å€¼æ˜¯ 21, å®ƒæ¥ç€ä¸ç¬¬ä¸‰æ®µï¼ˆä¹Ÿæ˜¯æœ€åçš„æ•°æ®æ®µï¼‰çš„ç»“æœä¾æ¬¡ç›¸åŠ  ï¼Œ äº§ç”Ÿæœ€ç»ˆ<br>
ç»“æœ {l, 3, 6} ã€ {10, 15, 21} ã€ {28,36,45} ã€‚</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">barrier</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-unsigned">unsigned</span><span class="token operator">&gt;</span> count<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-unsigned">unsigned</span><span class="token operator">&gt;</span> spaces<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-unsigned">unsigned</span><span class="token operator">&gt;</span> generation<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-explicit">explicit</span> <span class="token function">barrier</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> count<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">count</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">spaces</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">generation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> my_generation<span class="token operator">=</span>generation<span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">--</span>spaces<span class="token punctuation">)</span><span class="token comment">//å½“ç©ºåº§é€’å‡ä¸º0æ—¶ï¼Œè¯´æ˜æ‰€æœ‰çº¿ç¨‹éƒ½å·²ç»åˆ°è¾¾çº¿ç¨‹å¡,generationæ‰æ›´æ–°</span>
        <span class="token punctuation">{</span>
            spaces<span class="token operator">=</span>count<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>generation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>generation<span class="token operator">==</span>my_generation<span class="token punctuation">)</span>
                std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">done_waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//å‡å°‘çº¿ç¨‹,å‰”é™¤çº¿ç¨‹å¡</span>
    <span class="token punctuation">{</span>
        <span class="token operator">--</span>count<span class="token punctuation">;</span>        
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">--</span>spaces<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            spaces<span class="token operator">=</span>count<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>generation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">parallel_partial_sum</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-typedef">typedef</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token double-colon punctuation">::</span>value_type value_type<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">process_element</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token punctuation">,</span>barrier<span class="token operator">&amp;</span>b<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            value_type<span class="token operator">&amp;</span> ith_element<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>first<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-bool">bool</span> update_source <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> step<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>stride<span class="token operator">&lt;=</span>i<span class="token punctuation">;</span><span class="token operator">++</span>step<span class="token punctuation">,</span>stride<span class="token operator">*=</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                value_type <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> source <span class="token operator">=</span> <span class="token punctuation">(</span>step<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">:</span>ith_element<span class="token punctuation">;</span>
                value_type <span class="token operator">&amp;</span> dest <span class="token operator">=</span> <span class="token punctuation">(</span>step<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span> itehr_element<span class="token operator">:</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                value_type <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> addend <span class="token operator">=</span> <span class="token punctuation">(</span>step<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span> buffer<span class="token punctuation">[</span>i<span class="token operator">-</span>stride<span class="token punctuation">]</span><span class="token operator">:</span><span class="token operator">*</span><span class="token punctuation">(</span>first<span class="token operator">+</span>i<span class="token operator">-</span>stride<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dest<span class="token operator">=</span>source<span class="token operator">+</span>addend<span class="token punctuation">;</span>
                update_source <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>step<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                b<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>update_source<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                ith_element <span class="token operator">=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            b<span class="token punctuation">.</span><span class="token function">done_waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>length<span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span> <span class="token function">buffer</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    barrier <span class="token function">b</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> <span class="token function">threads</span><span class="token punctuation">(</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join_threads <span class="token function">joiner</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator block_start<span class="token operator">=</span>first<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token function">process_element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">process_element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢çš„ä»£ç é€šè¿‡é€è½®è®¡ç®—å‰ç¼€å’Œ,å¹¶é€šè¿‡æ …æ åŒæ­¥çº¿ç¨‹,å‡å°‘çº¿ç¨‹å¡<br>
ä»¥2çš„æ¬¡å¹‚è¿›è¡Œåˆ’åˆ†æ•°æ®æ®µ,å¹¶è¡Œè®¡ç®—å‰ç¼€å’Œ<br>
å‡è®¾æˆ‘ä»¬è¿˜æ˜¯è®¡ç®—åºåˆ—{1,2,3,4,5,6,7,8,9}çš„å‰ç¼€å’Œï¼Œé‚£ä¹ˆç¬¬ä¸€è½®æ“ä½œä¾¿ä¼šå¾—å‡º {l, 3, 5, 7, 9, 11, 13, 15, 17}, å…¶ä¸­å‰ä¸¤ä¸ªå…ƒç´ å³ä¸ºæœ€ç»ˆç»“æœã€‚ç¬¬äºŒè½®æ“ä½œä¼šå¾—åˆ° {1, 3, 6, 10, 14, 18, 22, 26, 30}, è¿™æ—¶å‰ 4 é¡¹å…ƒç´ å·²å®Œæˆè®¡ç®—ã€‚ç¬¬ä¸‰è½®å¦‚ä¹åæˆ‘ä»¬æ±‚å‡º {1, 3, 6, 10, 15, 21, 28, 36, 44}, å…¶ä¸­å‰ 8 é¡¹å…ƒç´ éƒ½æ˜¯æ­£ç¡®ç»“æœï¼Œæœ€åä¸€è½®ä¼šäº§ç”Ÿ {l, 3, 6, 10, 15 ,21, 28, 36, 45}</p>
<hr>
<h2 id="é«˜çº§çº¿ç¨‹ç®¡ç†">é«˜çº§çº¿ç¨‹ç®¡ç† </h2>
<h3 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ±  </h3>
<p>çº¿ç¨‹æ± çš„æœ€ç®€å•å®ç°æ˜¯,é‡‡ç”¨æ•°ç›®å›ºå®šçš„å·¥ä½œçº¿ç¨‹,æ¯å½“æœ‰ä»»åŠ¡éœ€è¦å¤„ç†æ—¶,è°ƒç”¨å‡½æ•°è®©å®ƒæ”¾åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­<br>
ç­‰å¾…,å„å·¥ä½œçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­é¢†å–æŒ‡å®šçš„ä»»åŠ¡å¹¶è¿è¡Œ,ç„¶åå†å›åˆ°é˜Ÿåˆ—é¢†å–å…¶ä»–ä»»åŠ¡</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">thread_pool</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic_bool done<span class="token punctuation">;</span>
    threadsafe_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> work_queue<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> threads<span class="token punctuation">;</span>
    join_threads joiner<span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>task<span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>work_queue<span class="token punctuation">.</span><span class="token function">try_pop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">joiner</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> thread_count<span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread_count<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_pool<span class="token double-colon punctuation">::</span>worker_thread<span class="token punctuation">,</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            done<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-throw">throw</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        done<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">FunctionType</span><span class="token operator">&gt;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">submit</span><span class="token punctuation">(</span>FunctionType f<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        work_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">function</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span></span></span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä¸€ä¸ªçº¿ç¨‹æ± ,ä½¿ç”¨è€…å¯ä»¥ç­‰å¾…æ± å†…ä»»åŠ¡å®Œæˆ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">function_wrapper</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">impl_base</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-void">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-virtual">virtual</span> <span class="token operator">~</span><span class="token function">impl_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>impl_base<span class="token operator">&gt;</span> impl<span class="token punctuation">;</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">impl_type</span><span class="token operator">:</span><span class="token base-clause"><span class="token class-name">impl_base</span></span>
    <span class="token punctuation">{</span>
        F f<span class="token punctuation">;</span>
        <span class="token function">impl_type</span><span class="token punctuation">(</span>F f_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>f_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span>F <span class="token operator">&amp;&amp;</span>f<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">impl</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token generic-function"><span class="token function">impl_type</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">move</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        impl<span class="token operator">-&gt;</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-default">default</span><span class="token punctuation">;</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span>function_wrapper <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        impl <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    function_wrapper <span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>function_wrapper <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        impl <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token operator">*</span><span class="token keyword keyword-this">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> function_wrapper <span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span>function_wrapper <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    function_wrapper<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> function_wrapper <span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">thread_pool</span><span class="token punctuation">{</span>
    threadsafe_queue<span class="token operator">&lt;</span>function_wrapper<span class="token operator">&gt;</span> work_queue<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic_bool done<span class="token punctuation">;</span>

    <span class="token keyword keyword-void">void</span> <span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            function_wrapper task<span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>work_queue<span class="token punctuation">.</span><span class="token function">try_pop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-else">else</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">FunctionType</span><span class="token operator">&gt;</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>result_of<span class="token operator">&lt;</span><span class="token function">FunctionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type<span class="token operator">&gt;</span> <span class="token function">submit</span><span class="token punctuation">(</span>FunctionType f<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-typedef">typedef</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>result_of<span class="token operator">&lt;</span><span class="token function">FunctionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type result_type<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>result_type<span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        work_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        done<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>æˆ‘ä»¬æŠŠå‡½æ•°f åŒ…è£…åœ¨ std: :packaged_task&lt;result_type()&gt;ä¸­ï¼Œå› ä¸ºå¥æ˜¯å‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡ï¼Œä¸æ¥æ”¶å‚æ•°ï¼Œè¿”å›å€¼æ˜¯ result_type å‹åˆ«çš„å®ä¾‹ã€‚æ ¹æ®æ¨å¯¼ ï¼Œä¸¤è€…å½¼æ­¤ç›¸<br>
ç¬¦ã€‚æ¥ç€ï¼Œæˆ‘ä»¬ä» std: :packaged_tas k&lt;&gt; å–å¾—å¯¹åº”çš„futurå¿’è¶´ç„¶åå°†ä»»åŠ¡å‹å…¥é˜Ÿåˆ— ï¼Œ<br>
å†å‘ submitçš„è°ƒç”¨è€…è¿”å›futureï¼‰ã€‚è¯·æ³¨æ„ï¼Œç”±äº std: :packaged_tas k&lt;&gt;ä¸å¯å¤åˆ¶ ï¼Œå› æ­¤<br>
ä¸€å®šè¦é€šè¿‡ std::move æŠŠä»»åŠ¡å‹å…¥é˜Ÿåˆ—ã€‚ç…§æ­¤ä¿®æ”¹ï¼Œä»»åŠ¡é˜Ÿåˆ—å­˜å‚¨çš„å…ƒç´ æ˜¯function_wrapper å¯¹è±¡ï¼Œè€Œä¸å†æ˜¯ std::function<void>å¯¹è±¡ã€‚ç°åœ¨ï¼Œçº¿ç¨‹æ± é‚èƒ½å¤Ÿä¾ä»å‰æ–‡çš„æ–°<br>
æ–¹å¼å¤„ç†ä»»åŠ¡</void></p>
<p>é‡‡ç”¨çº¿ç¨‹æ± å®ç°çš„parallel_accumulate()å‡½æ•°,è¿ç®—è¿‡ç¨‹åŠç­‰å¾…æ± å†…ä»»åŠ¡å®Œæˆ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Iterator</span><span class="token punctuation">,</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
T <span class="token function">parallel_accumulate</span><span class="token punctuation">(</span>Iterator first<span class="token punctuation">,</span>Iterator last<span class="token punctuation">,</span>T init<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> length<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>length<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> init<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> block_size<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-const">const</span> num_blocks<span class="token operator">=</span> <span class="token punctuation">(</span>length<span class="token operator">+</span>block_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>block_size<span class="token punctuation">;</span>
    thread_pool pool<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> <span class="token function">futures</span><span class="token punctuation">(</span>num_blocks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator block_start<span class="token operator">=</span>first<span class="token punctuation">;</span>
<span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_blocks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Iterator block_last<span class="token operator">=</span>block_start<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">advance</span><span class="token punctuation">(</span>block_last<span class="token punctuation">,</span>block_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token function">accumulate_block</span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>block_last<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        block_start<span class="token operator">=</span>block_last<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    T last_result<span class="token operator">=</span><span class="token generic-function"><span class="token function">accumulate_block</span><span class="token generic class-name"><span class="token operator">&lt;</span>Iterator<span class="token punctuation">,</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>block_start<span class="token punctuation">,</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
    T result <span class="token operator">=</span> init<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num_blocks<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        result<span class="token operator">+=</span>futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result<span class="token operator">+=</span>last_result<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>çº¿ç¨‹æ•°ç›®æœ‰é™,è‹¥è€—å°½äº†ç©ºé—²çº¿ç¨‹,å°±å¯èƒ½ä»¤ä»–ä»¬å…¨éƒ½åœæ»ä¸å‰,ç©ºç­‰å“ªäº›å°šå¾…è°ƒåº¦æ‰§è¡Œçš„ä»»åŠ¡<br>
å› æ­¤,æˆ‘ä»¬éœ€è¦é‡‡ç”¨çš„è§£å†³åŠæ³•ä¸ç¬¬8ç« ç›¸ä¼¼,åœ¨ç­‰å¾…ç›®æ ‡æ•°æ®å—å®Œæˆæ“ä½œçš„è¿‡ç¨‹ä¸­,ä¸»åŠ¨å¤„ç†ç›¸å…³çš„è¿˜æœªæ’åºçš„æ•°æ®å—<br>
è‹¥é‡‡ç”¨çº¿ç¨‹æ± ç®¡ç†ä»»åŠ¡åˆ—è¡¨åŠå…¶å…³è”çº¿ç¨‹,åˆ™å®Œå…¨ä¸å¿…ç›´æ¥è®¿é—®ä»»åŠ¡åˆ—è¡¨å°±èƒ½è¾¾åˆ°ç›®çš„,è¿™æ­£æ˜¯çº¿ç¨‹æ± çš„æ„ä¹‰</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> thread_pool<span class="token double-colon punctuation">::</span><span class="token function">run_pending_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    function_wrapper task<span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>work_queue<span class="token punctuation">.</span><span class="token function">try_pop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-else">else</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>è¿™ä¸ªå®ç°åŸæ ·æå–äº†worker_thread()å‡½æ•°çš„ä¸»å¾ªç¯,å¹¶ä½œä¸ºrun_pending_task()å‡½æ•°è€Œè¢«è°ƒç”¨<br>
åŸºäºçº¿ç¨‹æ± çš„å¿«é€Ÿæ’åºå®ç°</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">sorter</span>
<span class="token punctuation">{</span>
    thread_pool pool<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">do_sort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> chunk_data<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>chunk_data<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> chunk_data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> result<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>chunk_data<span class="token punctuation">,</span>chunk_data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†åˆ’åˆ†ç‚¹æå‰å­˜å…¥result</span>
        T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> partition_val<span class="token operator">=</span><span class="token operator">*</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Typename std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>iterator divide_point<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span><span class="token function">partition</span><span class="token punctuation">(</span>chunk_data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>chunk_data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>T <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> val<span class="token operator">&lt;</span>partition_val<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> new_lower_chunk<span class="token punctuation">;</span>
        new_lower_chunk<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>new_lower_chunk<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>chunk_data<span class="token punctuation">,</span>chunk_data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>divide_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> <span class="token function">new_higher</span><span class="token punctuation">(</span><span class="token function">do_sort</span><span class="token punctuation">(</span>chunk_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_higher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>new_lower<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>std<span class="token double-colon punctuation">::</span>future_status<span class="token double-colon punctuation">::</span>timeout<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pool<span class="token punctuation">.</span><span class="token function">run_pending_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new_lower<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">parallel_quick_sort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> input<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> input<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sorter<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> s<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> s<span class="token punctuation">.</span><span class="token function">do_sort</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>çº¿ç¨‹æ± ä»…å…·å¤‡ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¾›å¤šçº¿ç¨‹å…±ç”¨,åœ¨åŒä¸€ä¸ªçº¿ç¨‹æ± å®ä¾‹ä¸Š,æ¯å½“æœ‰çº¿ç¨‹è°ƒç”¨submit()å‡½æ•°,å°±æŠŠæ–°ä»»åŠ¡å‹å…¥è¯¥é˜Ÿåˆ—,ç±»ä¼¼åœ°,ä¸ºäº†æ‰§è¡Œä»»åŠ¡,å·¥ä½œçº¿ç¨‹ä¸æ–­ä»è¿™ä¸€é˜Ÿåˆ—å¼¹å‡ºä»»åŠ¡</p>
<p>ä¸ºäº†è§£å†³ç¼“å­˜ä¹’ä¹“é—®é¢˜,ä¸ºæ¯ä¸ªçº¿ç¨‹é…å¤‡ç‹¬ç«‹çš„ä»»åŠ¡é˜Ÿåˆ—,å„çº¿ç¨‹åªåœ¨è‡ªå·±çš„é˜Ÿåˆ—ä¸Šå‘å¸ƒæ–°ä»»åŠ¡,ä»…å½“çº¿ç¨‹è‡ªèº«çš„é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡æ—¶,æ‰ä¼šä»å…¨å±€é˜Ÿåˆ—é¢†å–ä»»åŠ¡ã€</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">thread_pool</span>
<span class="token punctuation">{</span>
    threadsafe_queue<span class="token operator">&lt;</span>function_wrapper<span class="token operator">&gt;</span> pool_work_queue<span class="token punctuation">;</span>
    <span class="token keyword keyword-typedef">typedef</span> std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>function_wrapper<span class="token operator">&gt;</span> local_queue_type<span class="token punctuation">;</span>
    <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-thread_local">thread_local</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>local_queue_type<span class="token operator">&gt;</span> local_work_queue<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-void">void</span> <span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        local_work_queue<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> local_queue_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">run_pending_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">FunctionType</span><span class="token operator">&gt;</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>result_of<span class="token operator">&lt;</span><span class="token function">FunctionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type<span class="token operator">&gt;</span><span class="token function">submit</span><span class="token punctuation">(</span>FunctionType f<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-typedef">typedef</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>result_of<span class="token operator">&lt;</span><span class="token function">FunctionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type result_type<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>result_type<span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>local_work_queue<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            local_work_queue<span class="token operator">-&gt;</span><span class="token function">emplace</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span>
        <span class="token punctuation">{</span>
            pool_work_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">run_pending_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        function_wrapper task<span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>local_work_queue <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>local_work_queue<span class="token operator">-&gt;</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            task <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>local_work_queue<span class="token operator">-&gt;</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            local_work_queue<span class="token operator">-&gt;</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>pool_work_queue<span class="token punctuation">.</span><span class="token function">try_pop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>å½“çº¿ç¨‹è‡ªèº«çš„é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡æ—¶,æ‰ä¼šä»å…¨å±€é˜Ÿåˆ—é¢†å–ä»»åŠ¡,å…¶ä¸­é‡‡ç”¨äº†thread_localå˜é‡,ä»è€Œä»¤æ¯ä¸ªçº¿ç¨‹éƒ½å…·æœ‰è‡ªå·±çš„ä»»åŠ¡é˜Ÿåˆ—,çº¿ç¨‹æ± æœ¬èº«åˆ™å†ç»´æŠ¤ä¸€å…¨å±€é˜Ÿåˆ—</p>
<h4 id="ä»»åŠ¡çªƒå–">ä»»åŠ¡çªƒå– </h4>
<p>æœ‰ä¸”åªæœ‰ thread_local å…³é”®å­—ä¿®é¥°çš„å˜é‡å…·æœ‰çº¿ç¨‹ï¼ˆthreadï¼‰å‘¨æœŸï¼Œè¿™äº›å˜é‡åœ¨çº¿ç¨‹å¼€å§‹çš„æ—¶å€™è¢«ç”Ÿæˆï¼Œåœ¨çº¿ç¨‹ç»“æŸçš„æ—¶å€™è¢«é”€æ¯ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å®ä¾‹ã€‚<br>
thread_local ä¸€èˆ¬ç”¨äºéœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‡½æ•°ä¸­ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœç±»çš„æˆå‘˜å‡½æ•°å†…å®šä¹‰äº† thread_local å˜é‡ï¼Œåˆ™å¯¹äºåŒä¸€ä¸ªçº¿ç¨‹å†…çš„è¯¥ç±»çš„å¤šä¸ªå¯¹è±¡éƒ½ä¼šå…±äº«ä¸€ä¸ªå˜é‡å®ä¾‹ï¼Œå¹¶ä¸”åªä¼šåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œè¿™ä¸ªæˆå‘˜å‡½æ•°æ—¶åˆå§‹åŒ–è¿™ä¸ªå˜é‡å®ä¾‹ï¼Œè¿™ä¸€ç‚¹æ˜¯è·Ÿç±»çš„é™æ€æˆå‘˜å˜é‡ç±»ä¼¼çš„ã€‚</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">STEALING_THREAD_POOL_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STEALING_THREAD_POOL_HPP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.shared_mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.thread.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.condition_variable.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.mutex.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mingw.future.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"thread_safe_stack.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"join_threads.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"threadsafe_queue.hpp"</span></span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">function_wrapper</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">impl_base</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-void">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-virtual">virtual</span> <span class="token operator">~</span><span class="token function">impl_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>impl_base<span class="token operator">&gt;</span> impl<span class="token punctuation">;</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">impl_type</span><span class="token operator">:</span><span class="token base-clause"><span class="token class-name">impl_base</span></span>
    <span class="token punctuation">{</span>
        F f<span class="token punctuation">;</span>
        <span class="token function">impl_type</span><span class="token punctuation">(</span>F f_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>f_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span>F <span class="token operator">&amp;&amp;</span>f<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">impl</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token generic-function"><span class="token function">impl_type</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">move</span><span class="token generic class-name"><span class="token operator">&lt;</span>F<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        impl<span class="token operator">-&gt;</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-default">default</span><span class="token punctuation">;</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span>function_wrapper <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        impl <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    function_wrapper <span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>function_wrapper <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        impl <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token operator">*</span><span class="token keyword keyword-this">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> function_wrapper <span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    <span class="token function">function_wrapper</span><span class="token punctuation">(</span>function_wrapper <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
    function_wrapper<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> function_wrapper <span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">work_stealing_queue</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span><span class="token operator">:</span>
        <span class="token keyword keyword-typedef">typedef</span> function_wrapper data_type<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span>data_type<span class="token operator">&gt;</span> the_queue<span class="token punctuation">;</span>
        <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex the_mutex<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token function">work_stealing_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">work_stealing_queue</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> work_stealing_queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        work_stealing_queue<span class="token operator">&amp;</span> <span class="token keyword keyword-operator">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> work_stealing_queue<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword keyword-delete">delete</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">push</span><span class="token punctuation">(</span>data_type data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>the_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            the_queue<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>the_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> the_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">try_pop</span><span class="token punctuation">(</span>data_type<span class="token operator">&amp;</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>the_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>the_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            res <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>the_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            the_queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">try_steal</span><span class="token punctuation">(</span>data_type<span class="token operator">&amp;</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>the_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>the_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
            res <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>the_queue<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            the_queue<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">thread_pool</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-typedef">typedef</span> function_wrapper task_type<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>atomic_bool done<span class="token punctuation">;</span>
    threadsafe_queue<span class="token operator">&lt;</span>task_type<span class="token operator">&gt;</span> pool_work_queue<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>work_stealing_queue<span class="token operator">&gt;&gt;</span> queues<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> threads<span class="token punctuation">;</span>
    join_threads joiner<span class="token punctuation">;</span>
    <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-thread_local">thread_local</span> work_stealing_queue<span class="token operator">*</span> local_work_queue<span class="token punctuation">;</span>
    <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-thread_local">thread_local</span> <span class="token keyword keyword-unsigned">unsigned</span> my_index<span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">worker_thread</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> my_index_<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        my_index <span class="token operator">=</span> my_index_<span class="token punctuation">;</span>
        local_work_queue<span class="token operator">=</span> queues<span class="token punctuation">[</span>my_index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">run_pending_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-bool">bool</span> <span class="token function">pop_task_from_local_queue</span><span class="token punctuation">(</span>task_type<span class="token operator">&amp;</span> task<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
       <span class="token keyword keyword-return">return</span> local_work_queue<span class="token operator">&amp;&amp;</span> local_work_queue<span class="token operator">-&gt;</span><span class="token function">try_pop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-bool">bool</span> <span class="token function">pop_task_from_pool_queue</span><span class="token punctuation">(</span>task_type<span class="token operator">&amp;</span> task<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> pool_work_queue<span class="token punctuation">.</span><span class="token function">try_pop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-bool">bool</span> <span class="token function">pop_task_from_other_queue</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> index<span class="token punctuation">,</span> task_type<span class="token operator">&amp;</span> task<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>queues<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>my_index<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>queues<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>queues<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">try_steal</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">joiner</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-const">const</span> thread_count<span class="token operator">=</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread_count<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                queues<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>work_stealing_queue<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> work_stealing_queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> thread_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_pool<span class="token double-colon punctuation">::</span>worker_thread<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            done<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-throw">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span> done<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">FunctionType</span><span class="token operator">&gt;</span>
    std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>result_of<span class="token operator">&lt;</span><span class="token function">FunctionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type_result_type<span class="token operator">&gt;</span> <span class="token function">submit</span><span class="token punctuation">(</span>FunctionType f<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-typedef">typedef</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>result_of<span class="token operator">&lt;</span><span class="token function">FunctionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type result_type<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>packaged_task<span class="token operator">&lt;</span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>result_type<span class="token operator">&gt;</span> <span class="token function">res</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>local_work_queue<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            local_work_queue<span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">{</span>
            pool_work_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">run_pending_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        task_type task<span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">pop_task_from_local_queue</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token operator">||</span> <span class="token function">pop_task_from_pool_queue</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">pop_task_from_other_queue</span><span class="token punctuation">(</span>my_index<span class="token punctuation">,</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// STEALING_THREAD_POOL_HPP</span></span>
</code></pre><p>è‹¥çº¿ç¨‹æ± å†…æŸçº¿ç¨‹æ— äº‹å¯åš,å°±ä¼šèŒƒæ–‡ä¼—çº¿ç¨‹çš„ä¸“å±é˜Ÿåˆ—,è¯•å›¾ä¸ºè¯¥çº¿ç¨‹çªƒå–ä»»åŠ¡,è¿™æ ·,run_pending_task()å°±ä¼šå°è¯•ä»çº¿ç¨‹è‡ªå·±çš„é˜Ÿåˆ—é¢†å–ä»»åŠ¡,ä¹Ÿä¼šå°è¯•ä»çº¿ç¨‹æ± çš„å…¨å±€é˜Ÿåˆ—é¢†å–ä»»åŠ¡,è¿˜ä¼šå°è¯•ä»å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—çªƒå–ä»»åŠ¡</p>
<hr>
<h3 id="ä¸­æ–­çº¿ç¨‹">ä¸­æ–­çº¿ç¨‹ </h3>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">interrupt_flag</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-bool">bool</span> <span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword keyword-thread_local">thread_local</span> interrupt_flag this_thread_interrupt_flag<span class="token punctuation">;</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">interruptible_thread</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>thread internal_thread<span class="token punctuation">;</span>
    interrupt_flag<span class="token operator">*</span> flag<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
        <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">FunctionType</span><span class="token operator">&gt;</span>
        <span class="token function">interruptible_thread</span><span class="token punctuation">(</span>FunctionType f<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>interrupt_flag<span class="token operator">*</span><span class="token operator">&gt;</span> p<span class="token punctuation">;</span>
            internal_thread <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">[</span>f<span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token punctuation">]</span><span class="token punctuation">{</span>
                p<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>this_thread_interrupt_flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//ä¸­æ–­å¼‚å¸¸ä¼ é€’ç‰ˆæœ¬çš„åˆå§‹åŒ–</span>
        <span class="token function">interruptible_thread</span><span class="token punctuation">(</span>FunctionType f<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>promise<span class="token operator">&lt;</span>interrupt_flag<span class="token operator">*</span><span class="token operator">&gt;</span> p<span class="token punctuation">;</span>
            internal_thread <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">[</span>f<span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token punctuation">]</span><span class="token punctuation">{</span>
                p<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>this_thread_interrupt_flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
                <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span>thread_interrupted <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">handle_interruption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
        <span class="token keyword keyword-void">void</span> <span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                flag<span class="token operator">-&gt;</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-throw">throw</span> <span class="token function">thread_interrputed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-void">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">process_next_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>ä¸Šé¢çš„ä»£ç å¦‚æœä½¿ç”¨waitå°±æ— æ³•è¿›å…¥interruption_point()å‡½æ•°,å› ä¸ºwaitä¼šä¸€ç›´é˜»å¡,ç›´åˆ°çº¿ç¨‹ç»“æŸ,è€Œinterruption_point()å‡½æ•°éœ€è¦åœ¨çº¿ç¨‹é˜»å¡æ—¶æ£€æµ‹ä¸­æ–­æ ‡å¿—,å¦‚æœä¸­æ–­æ ‡å¿—è¢«è®¾ç½®,åˆ™æŠ›å‡ºå¼‚å¸¸<br>
é’ˆå¯¹æ¡ä»¶å˜é‡std::condition_variableçš„interruptble_wait()å‡½æ•°,ä½†å­˜åœ¨ç‘•ç–µ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-void">void</span> <span class="token function">interruptible_wait</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>condition_variable<span class="token operator">&amp;</span> cv<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span><span class="token operator">&amp;</span> lk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">set_condition_variable</span><span class="token punctuation">(</span>cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">clear_condition_variable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å‡½æ•°å…ˆæ£€æµ‹ä¸­æ–­æ˜¯å¦å‘ç”Ÿ,å†æŠŠæ¡ä»¶å˜é‡ä¸å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—å…³è”èµ·æ¥,æ¥ç€åœ¨æ¡ä»¶å˜é‡ä¸Šç­‰å¾…,ç»§è€Œè§£é™¤å…³è”,æœ€åå†æ¬¡æ£€æµ‹ä¸­æ–­.<br>
åœ¨ç›®æ ‡çº¿ç¨‹ç­‰å¾…æ¡ä»¶å˜é‡æœŸé—´,è‹¥éœ€è¦å®ƒä¸­æ–­,å¼•å‘ä¸­æ–­çš„çº¿ç¨‹å°±å‘æ¡ä»¶å˜é‡å¹¿æ’­,å”¤é†’æ­£åœ¨å…¶ä¸Šç­‰å¾…çš„å…¨éƒ¨çº¿ç¨‹</p>
<p>ä¸Šé¢çš„ä»£ç å¦‚æœåœ¨waitå¤„æŠ›å‡ºå¼‚å¸¸,å‡½æ•°ä¼šç›´æ¥é€€å‡ºè€Œä¸­æ–­æ ‡å¿—å’Œæ¡ä»¶å˜é‡ä¹‹é—´çš„å…³è”æ²¡æœ‰è¢«è§£é™¤â€”â€”å¯ä»¥é€šè¿‡ä¸­æ–­æ ‡å¿—çš„ææ„å‡½æ•°è§£é™¤å…³è”</p>
<p>å¦ä¸€ä¸ªé—®é¢˜ä¸ºæ¡ä»¶ç«äº‰,å¦‚æœåœ¨waitä¹‹å‰å°±è¢«ä¸­æ–­é‚£ä¹ˆæ¡ä»¶å˜é‡æ˜¯å¦å…³è”ä¸­æ–­æ ‡å¿—å°±æ— æ‰€è°“äº†,ä½†æ˜¯å¦‚æœåœ¨waitä¹‹åè¢«ä¸­æ–­å¦‚æœä¸æ˜¯è¿›å…¥interruption_point()å‡½æ•°,é‚£ä¹ˆæ¡ä»¶å˜é‡å…³è”çš„ä¸­æ–­æ ‡å¿—å°±ä¸ä¼šè¢«è§£é™¤,å¯¼è‡´çº¿ç¨‹æ— æ³•æ­£å¸¸é€€å‡º,å› æ­¤éœ€è¦åœ¨waitä¹‹åè§£é™¤å…³è”<br>
æˆ‘ä»¬éœ€è¦ä¿è¯ä¹‹é—´ç›®æ ‡çº¿ç¨‹ä¸ä¼šè¢«å”¤é†’,åˆ©ç”¨é”lkåŒæ—¶ä¿æŠ¤ä¸Šè¿°ä¸¤ä¸ªåŠ¨ä½œ,ä½†åŒæ—¶å¯èƒ½å‘ç”Ÿé”æ˜¯å¦æˆåŠŸé”ä½å’Œæ­»é”çš„é—®é¢˜<br>
å¦ä¸€æ–¹æ³•æ˜¯è°ƒç”¨wait_foræ›¿ä»£wait,ä½†è¶…æ—¶æ—¶é—´éš¾ä»¥è®¾è®¡,ä¼šå‡ºç°åå¤å”¤é†’çš„é—®é¢˜</p>
<p>é’ˆå¯¹æ¡ä»¶å˜é‡std::condition_variableçš„interruptible_wait()å‡½æ•°,å®ƒæ”¯æŒè¶…æ—¶å°±åœæ­¢</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">interrupt_flag</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> flag<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>condition_variable<span class="token operator">*</span> thread_cond<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">interrupt_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">thread_cond</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        flag<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>set_clear_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>thread_cond<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            thread_cond<span class="token operator">-&gt;</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-bool">bool</span> <span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> flag<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">set_condition_variable</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>condition_variable<span class="token operator">&amp;</span> cv<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>set_clear_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread_cond<span class="token operator">=</span><span class="token operator">&amp;</span>cv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">clear_condition_variable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>set_clear_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread_cond<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">clear_cv_on_destruct</span>
    <span class="token punctuation">{</span>
        <span class="token operator">~</span><span class="token function">clear_cv_on_destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">clear_condition_variable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">interruptible_wait</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>condition_variable<span class="token operator">&amp;</span> cv<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span><span class="token operator">&amp;</span> lk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">set_condition_variable</span><span class="token punctuation">(</span>cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interrupt_flag<span class="token double-colon punctuation">::</span>clear_cv_on_destruct guard<span class="token punctuation">;</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœæˆ‘ä»¬éœ€è¦ç­‰å¾…æŸä¸ªæ–­è¨€æˆç«‹,é‚£ä¹ˆå°±å¯ä»¥æŠŠ1msçš„æ—¶é™å®Œå…¨èåˆåˆ°æ–­è¨€å¾ªç¯ä¹‹ä¸­</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Predicate</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">interruptible_wait_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>condition_variable<span class="token operator">&amp;</span> cv<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span><span class="token operator">&amp;</span> lk<span class="token punctuation">,</span>Predicate pred<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">set_condition_variable</span><span class="token punctuation">(</span>cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interrupt_flag<span class="token double-colon punctuation">::</span>clear_cv_on_destruct guard<span class="token punctuation">;</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token function">pred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><h5 id="ä¸­æ–­æ¡ä»¶å˜é‡stdcondition_variable_anyä¸Šçš„ç­‰å¾…">ä¸­æ–­æ¡ä»¶å˜é‡std::condition_variable_anyä¸Šçš„ç­‰å¾… </h5>
<p>std::condition_variable_anyä¸std::condition_variableçš„åŒºåˆ«åœ¨äºå‰è€…å¯ä»¥é…åˆä»»æ„å‹åˆ«çš„é”,è€Œåè€…ä»…é™äºstd::unique<br>
_lock<a href="std::mutex">std::mutex</a></p>
<p>std::condition_variable_anyé€‚é…ä»»æ„çš„é”ï¼Œæ‰€ä»¥æ•ˆæœæ›´å¥½,interrupt_flagæ ‡å¿—ä¸­å†…æ¶µçš„äº’æ–¥set_clear_mutexä¹Ÿå¯ä»¥ä¼ ç»™wait</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span>  <span class="token class-name">interrupt_flag</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword keyword-bool">bool</span><span class="token operator">&gt;</span> flag<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>condition_variable<span class="token operator">*</span> thread_cond<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>condition_variable_any<span class="token operator">*</span> thread_cond_any<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>mutex set_clear_mutex<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">interrupt_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">thread_cond</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">thread_cond_any</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        flag<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span><span class="token function">lk</span><span class="token punctuation">(</span>set_clear_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>thread_cond<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            thread_cond<span class="token operator">-&gt;</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>thread_cond_any<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            thread_cond_any<span class="token operator">-&gt;</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Lockable</span><span class="token operator">&gt;</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">wait</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>condition_variable_any<span class="token operator">&amp;</span> cv<span class="token punctuation">,</span>Lockable<span class="token operator">&amp;</span> lk<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">custom_lock</span>
        <span class="token punctuation">{</span>
            interrupt_flag<span class="token operator">*</span> self<span class="token punctuation">;</span>
            Lockable<span class="token operator">&amp;</span> lk<span class="token punctuation">;</span>
            <span class="token function">custom_lock</span><span class="token punctuation">(</span>interrupt_flag<span class="token operator">*</span> self_<span class="token punctuation">,</span>
            std<span class="token double-colon punctuation">::</span>condition_variable_any<span class="token operator">&amp;</span> cond<span class="token punctuation">,</span>Lockable<span class="token operator">&amp;</span> lk_<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">self</span><span class="token punctuation">(</span>self_<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">lk</span><span class="token punctuation">(</span>lk_<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                self<span class="token operator">-&gt;</span>set_clear_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                self<span class="token operator">-&gt;</span>thread_cond_any<span class="token operator">=</span><span class="token operator">&amp;</span>cond<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-void">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                self<span class="token operator">-&gt;</span>set_clear_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-void">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>set_clear_mutex<span class="token punctuation">,</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        custom_lock <span class="token function">cl</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>cv<span class="token punctuation">,</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">Lockable</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">interruptible_wait</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>condition_variable_any<span class="token operator">&amp;</span> cv<span class="token punctuation">,</span>Lockable<span class="token operator">&amp;</span> lk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    this_thread_interrupt_flag<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>cv<span class="token punctuation">,</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä½™ä¸‹ä»£ç ä¸std::condition_variableæ—¶çš„interrupt_flag ç›¸åŒ</p>
<h5 id="ä¸­æ–­å…¶ä»–é˜»å¡å‹ç­‰å¾…">ä¸­æ–­å…¶ä»–é˜»å¡å‹ç­‰å¾… </h5>
<p>ä¸Šé¢çš„ä»£ç è¡¥å…¨äº†æ¡ä»¶å˜é‡ä¸Šçš„ç­‰å¾…,ä½†å’Œå­˜åœ¨åŒ…æ‹¬äº’æ–¥é”,futureç­‰ç­‰çš„ç­‰å¾…<br>
ä¸€èˆ¬çš„æ–¹æ³•æ˜¯å€ŸåŠ©std::condition_variableæ‰€ç”¨åˆ°çš„é™æ—¶åŠŸèƒ½</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-template">template</span><span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">interruptible_wait</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>future<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> uf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token operator">!</span>this_thread_flag<span class="token punctuation">.</span><span class="token function">is_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>uf<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>std<span class="token double-colon punctuation">::</span>future_status<span class="token double-colon punctuation">::</span>ready<span class="token punctuation">)</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>è¯¥å‡½æ•°ä¸€ç›´ç­‰å¾…,ç›´åˆ°ä¸­æ–­æ ‡å¿—è¢«è®¾ç½®ä¸ºæˆç«‹æ‰åœæ­¢,æˆ–ç­‰åˆ°futureå‡†å¤‡å°±ç»ªæ‰åœæ­¢,ä½†å‡½æ•°å†…éƒ¨ä»¥1msä¸ºæ—¶é™,åœ¨futureä¸Šåå¤è¿›è¡Œé˜»å¡å‹ç­‰å¾…<br>
wait_for()å¾€å¾€ä¼šè‡³å°‘ç­‰å¾…ä¸€ä¸ªå®Œæ•´çš„è®¡æ—¶å•å…ƒ,å› æ­¤,å¦‚æœæ‰€ç”¨æ—¶é’Ÿçš„è®¡æ—¶å•å…ƒæ˜¯15ms,æˆ‘ä»¬å°±å¾—ç­‰å¾…15msæ‰ä¼šæ£€æµ‹åˆ°ä¸­æ–­,è¿™ä¼šå¯¼è‡´æ•ˆç‡ä½ä¸‹</p>
<h5 id="å¤„ç†ä¸­æ–­">å¤„ç†ä¸­æ–­ </h5>
<p>ä»ä¸Šè¿°ä»£ç ä¸­interruption_point()å‡½æ•°çš„ä½œç”¨æ˜¯æ£€æµ‹ä¸­æ–­æ ‡å¿—,å¦‚æœä¸­æ–­æ ‡å¿—è¢«è®¾ç½®,åˆ™æŠ›å‡ºå¼‚å¸¸,ä½†è¯¥å‡½æ•°çš„å®ç°ä¾èµ–äºå…·ä½“çš„å¹³å°,å› æ­¤,æˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°è¯¥å‡½æ•°<br>
å¯ä»¥ç”¨try/catchæ•è·</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
    <span class="token function">do_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span>thread_interrupted <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">handle_interruption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤„ç†ä¸­æ–­</span>
<span class="token punctuation">}</span>
</code></pre><p>æˆ‘ä»¬é€šå¸¸å¸Œæœ›è®©ä¸­æ–­ç›´æ¥ç»ˆç»“çº¿ç¨‹,æ•…å¯è®©ä¸­æ–­å¼‚å¸¸å‘ä¸Šä¼ æ’­,ä½†æ˜¯<br>
std::threadåœ¨æ„é€ æ—¶è®¾å®šäº†çº¿ç¨‹å‡½æ•°,ä¸€æ—¦å¼‚å¸¸ä¼ æ’­åˆ°å‡½æ•°å¤–,std::terminate()å°±ä¼šè¢«è°ƒç”¨,ä»è€Œç»ˆæ­¢æ•´ä¸ªç¨‹åº</p>
<p>ç”±äºinterrupt_threadæ˜¯threadçš„åŒ…è£…ç±»,æ‰€ä»¥åˆå§‹åŒ–æ—¶åŒæ ·éœ€è¦ä¼ å…¥çº¿ç¨‹å‡½æ•°å¹¶åŠ ä¸Šcatchå—,ä¸ºäº†é˜²æ­¢å¿˜è®°è¿™ä¹ˆåš,å¯ä»¥åœ¨ç±»çš„åˆå§‹åŒ–ä»£ç ä¸­é˜²æ­¢catchå—,é€šè¿‡ä¸Šè¿°æ“ä½œä¸­æ–­åªä¼šç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">interruptible_thread</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>thread internal_thread<span class="token punctuation">;</span>
    <span class="token function">interruptibale_thread</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        internal_thread <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token punctuation">[</span>f<span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token punctuation">]</span><span class="token punctuation">{</span>
            p<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>this_thread_interrupt_flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
                <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-catch">catch</span><span class="token punctuation">(</span>thread_interrupted <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">handle_interruption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h5 id="åœ¨åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ä¸­æ–­åå°ä»»åŠ¡">åœ¨åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ä¸­æ–­åå°ä»»åŠ¡ </h5>
<p>ä¸ºäº†ä½¿æ–‡ä»¶ç´¢å¼•åŠæ—¶æ›´æ–°æ€»æ˜¯ç»´æŒæœ€æ–°çŠ¶æ€,ingå“Ÿä¸ªç¨‹åºéœ€è¦ä¸å¬è¿è¡Œ,è€Œå½“åº”ç”¨ç¨‹åºå…³é—­æ—¶,æˆ‘ä»¬éœ€è¦ä¾æ¬¡ç»“æŸåå°ç¨‹åºï¼Œå…¶ä¸­ä¸€ç§åšæ³•å°±æ˜¯ä¸­æ–­<br>
åœ¨åå°ç›‘æ§æ–‡ä»¶ç³»ç»Ÿ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span>mutex config_mutex<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>interruptible_thread<span class="token operator">&gt;</span> background_threads<span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">background_task</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> disk_id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">interruption_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs_change fsc<span class="token operator">=</span><span class="token function">get_fs_change</span><span class="token punctuation">(</span>disk_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>fsc<span class="token punctuation">.</span><span class="token function">has_changes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">update_index</span><span class="token punctuation">(</span>fsc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">start_background_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    background_threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">interruptible_thread</span><span class="token punctuation">(</span>background_thread<span class="token punctuation">,</span>disk_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    background_threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">interruptible_thread</span><span class="token punctuation">(</span>background_thread<span class="token punctuation">,</span>disk_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">start_background_processing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">process_gui_until_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lk</span><span class="token punctuation">(</span>config_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>background_threads<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        background_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>background_threads<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        background_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>å› ä¸ºä¸€ä¸ªçº¿ç¨‹ä¸ä¼šå› ä¸ºä¸­æ–­ç«‹å³ç»“æŸ,æ‰€ä»¥é€‰æ‹©å…ˆä¸­æ–­æ‰€æœ‰çº¿ç¨‹,å†ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ</p>
<hr>
<h2 id="å¹¶è¡Œç®—æ³•å‡½æ•°">å¹¶è¡Œç®—æ³•å‡½æ•° </h2>
<p>c++17å¼•å…¥äº†å¹¶è¡Œç®—æ³•å‡½æ•°,å®ƒä»¬æ˜¯æ–°å¼•å…¥çš„å¤šä¸ªå‡½æ•°é‡è½½<br>
std::execution::parå‘æ ‡å‡†åº“ç¤ºæ„,å…è®¸è°ƒç”¨é‡‡ç”¨å¤šçº¿ç¨‹,æŒ‰å¹¶è¡Œç®—æ³•çš„å½¢å¼æ‰§è¡Œ<br>
å…¶åˆ¶å®šäº†ä¸‰ç§ç­–ç•¥:</p>
<ul>
<li>std::execution::sequenced_policy: ä¸²è¡Œæ‰§è¡Œ</li>
<li>std::execution::parallel_policy: å¹¶è¡Œæ‰§è¡Œ</li>
<li>std::execution::parallel_unsequenced_policy: å¹¶è¡Œæ‰§è¡Œ,ä½†ä¸ä¿è¯é¡ºåº<br>
å®ƒä»¬æ˜¯ä¸‰ä¸ªç±»,ç”±å¤´æ–‡ä»¶executionå®šä¹‰,åˆ†åˆ«å¯¹åº”ä¸‰ä¸ªç­–ç•¥,è¯¥å¤´æ–‡ä»¶è¿˜å®šä¹‰äº†ä¸‰ä¸ªå¯¹åº”çš„ç­–ç•¥å¯¹è±¡,ä½œä¸ºå‚æ•°å‘ç®—æ³•ä¼ é€’<br>
std::execution::seq<br>
std::execution::par<br>
std::execution::par_unseq</li>
</ul>
<h4 id="å› æŒ‡å®šæ‰§è¡Œç­–ç•¥è€Œæ™®éäº§ç”Ÿçš„ä½œç”¨">å› æŒ‡å®šæ‰§è¡Œç­–ç•¥è€Œæ™®éäº§ç”Ÿçš„ä½œç”¨ </h4>
<ol>
<li>
<p>å¼‚å¸¸è¡Œä¸º:å¦‚æœæŒ‰æŸç§æ‰§è¡Œç­–ç•¥è°ƒç”¨ç®—æ³•,è€ŒæœŸé—´æœ‰å¼‚å¸¸æŠ›å‡º,åˆ™åæœå–å†³äºæ‰€é€‰ç”¨çš„æ‰§è¡Œç­–ç•¥<br>
std::for_each(std::execution::par,v.begin(),v.end(),[](auto x){throw my_exception();});<br>
æ™®é€šç‰ˆæœ¬å¼‚å¸¸std::bad_allocä¼šæŠ›å‡ºå‘å¤–ä¼ æ’­,è€Œé‡è½½ç‰ˆæœ¬åˆ™ä¼šä»¤æ•´ä¸ªç¨‹åºç»ˆæ­¢</p>
</li>
<li>
<p>ç®—æ³•ä¸­é—´æ­¥éª¤çš„æ‰§è¡Œèµ·ç‚¹å’Œæ—¶æœº<br>
æ‰§è¡Œç­–ç•¥æŒ‡å®šäº†ç®—æ³•å‡½æ•°çš„ä¸­é—´æ­¥éª¤çš„æ‰§è¡Œä¸»ä½“</p>
</li>
</ol>
<h4 id="stdexecutionsequenced_policy">std::execution::sequenced_policy </h4>
<p>é¡ºåºç­–ç•¥ä¸å¹¶è¡Œæ— å…³,å®ƒä»¤ç®—æ³•å‡½æ•°åœ¨å‘èµ·è°ƒç”¨çš„çº¿ç¨‹ä¸Šæ‰§è¡Œ å…¨éƒ¨æ“ä½œ,æ‰€æœ‰æ“ä½œéƒ½ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ,è¿˜å¿…é¡»æœä»ä¸€å®šçš„æ¬¡åº</p>
<h4 id="stdexecutionparallel_policy">std::execution::parallel_policy </h4>
<p>å‡½æ•°çš„å†…éƒ¨æ“ä½œå¯ä»¥åœ¨å‘èµ·è°ƒç”¨çš„çº¿ç¨‹ä¸Šæ‰§è¡Œ,ä¹Ÿå¯ä»¥ç”±ç¨‹åºåº“å¦å¤–åˆ›å»ºçº¿ç¨‹æ‰§è¡Œ,ç»™å®šä¸€é¡¹æ“ä½œ,å®ƒä¼šå›ºå®šåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå®Œæ•´æ‰§è¡Œåˆ°åº•<br>
std::for_each(std::execution::parallel,v.begin(),v.end(),[](int&amp; x){x+=count;});</p>
<p>è€Œstd::for_each(std::execution::par,v.begin(),v.end(),[](int&amp; x){x+=++count;});åˆ™ä¼šå› ä¸ºå‘ç”Ÿæ•°æ®ç«äº‰è€Œå­˜åœ¨é—®é¢˜</p>
<p>ä¸€ä¸ªå…·æœ‰å†…éƒ¨åŒæ­¥åŠŸèƒ½çš„ç±»,ä»¥åŠä½œç”¨åœ¨å…¶ä¸Šçš„å¹¶è¡Œç®—æ³•å‡½æ•°æ“ä½œ</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">X</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-mutable">mutable</span> std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span>
    <span class="token keyword keyword-int">int</span> data<span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">X</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-int">int</span> <span class="token function">get_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> data<span class="token punctuation">;</span>
    
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-void">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">increment_all</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>X<span class="token operator">&gt;</span><span class="token operator">&amp;</span> v<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>execution<span class="token double-colon punctuation">::</span>par<span class="token punctuation">,</span>v<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>v<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>X<span class="token operator">&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span>
        x<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šé¢çš„ä»£ç å¯ä»¥é‡‡ç”¨std::execution::par_unseqï¼Œå› ä¸ºæ¯ä¸ªå…ƒç´ éƒ½å…·å¤‡ä¸€ä¸ªäº’æ–¥</p>
<h4 id="è®¿é—®è®¡æ•°">è®¿é—®è®¡æ•° </h4>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unordered_map&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;numeric&gt;</span></span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">log_info</span><span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>string page<span class="token punctuation">;</span>
    time_t visit_time<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string browser<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-extern">extern</span> log_info <span class="token function">parse_log_line</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-using">using</span> visit_map_type <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-long">long</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

visit_map_type <span class="token function">count_visits_per_page</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> <span class="token keyword keyword-const">const</span><span class="token operator">&amp;</span>log_lines<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">combine_visits</span><span class="token punctuation">{</span>
        visit_map_type <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>visit_map_type lhs<span class="token punctuation">,</span>visit_map_type rhs<span class="token punctuation">)</span><span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>rhs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span><span class="token operator">&amp;</span> entry<span class="token operator">:</span>rhs<span class="token punctuation">)</span><span class="token punctuation">{</span>
                lhs<span class="token punctuation">[</span>entry<span class="token punctuation">.</span>first<span class="token punctuation">]</span><span class="token operator">+=</span>entry<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> lhs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    visit_map_type <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>log_info log<span class="token punctuation">,</span>visit_map_type visits<span class="token punctuation">)</span><span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
        <span class="token operator">++</span>map<span class="token punctuation">[</span>log<span class="token punctuation">.</span>page<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    visit_map_type <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>visit_map_type map<span class="token punctuation">,</span>log_info log<span class="token punctuation">)</span><span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
        <span class="token operator">++</span>map<span class="token punctuation">[</span>log<span class="token punctuation">.</span>page<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    visit_map_type <span class="token keyword keyword-operator">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>log_info log1<span class="token punctuation">,</span>log_info log2<span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span><span class="token punctuation">{</span>
        visit_map_type map<span class="token punctuation">;</span>
        <span class="token operator">++</span>map<span class="token punctuation">[</span>log1<span class="token punctuation">.</span>page<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>map<span class="token punctuation">[</span>log2<span class="token punctuation">.</span>page<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">transform_reduce</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>execution<span class="token double-colon punctuation">::</span>par_unseq<span class="token punctuation">,</span>log_lines<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>log_lines<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">visit_map_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">combine_visits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>parse_log_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><p>std::for_each ä»…éå†å…ƒç´ <br>
std::transform éå†å…ƒç´ å¹¶å°†è¿”å›å€¼æ”¾å…¥å®¹å™¨</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span><span class="token function">transform</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword keyword-return">return</span> i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><hr>
<h2 id="å¤šçº¿ç¨‹åº”ç”¨çš„æµ‹è¯•å’Œé™¤é”™">å¤šçº¿ç¨‹åº”ç”¨çš„æµ‹è¯•å’Œé™¤é”™ </h2>
<p>ä¸å¹¶å‘ç›¸å…³è”çš„é”™è¯¯åˆ†ä¸ºä¸¤å¤§ç±»:</p>
<ol>
<li>å¤šä½™çš„é˜»å¡</li>
<li>æ¡ä»¶ç«äº‰</li>
</ol>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>